---
title: "812 - Import eider duck data from NILU to Nivabasen, 2020"
author: "DHJ"
date: "2 9 2019"
output: 
  html_document:
    keep_md: true
---

Make tables for inserting into NIVAbase   
  
For eider duck data from NILU  
- Note: source of files the same as for cod siloxans (script 808)  
- Samples mostly exist in Nivabasen, but two samples MUST BE ADDED   

For coupling excel data of Labware data, we

- Create the sample table 'df_lookup_samples'  
- Coupling to excel data:
    - using TEXT_ID for all except siloxans (part a)  
    - Using TISSUE_NAME + SPECIMEN_NO for siloxans (part b)  

- In addition to lacking : Two samples (blod 10 + 11) have siloxan data but lack in Labware    
   - These two samples MUST BE ADDED    


## 0. Libraries and functions
```{r}

library(dplyr)
library(purrr)
library(lubridate)
library(stringr)
library(tidyr)
library(ggplot2)
library(niRvana)
library(safejoin)   # https://github.com/moodymudskipper/safejoin

source("812_Import_til_NIVAbasen_NILU_functions.R")

# "Restart" for lazy people that don't want to write the 
#    database password again (deletes all objects except database password/username)
if (FALSE){
  obj <- ls()
  obj <- obj[!obj %in% c("db_privkey", "db_pubkey", "db_pwd", "db_username")]
  rm(list = obj)
  rm(obj)
}


```

### a. Creds for connectng to Nivabasen    
Store your username and password to R (only once per R session)  
```{r}

set_credentials()

# Check these codes (press F2) for reminder about what comes from which tables:
# niRvana::get_biota_chemistry
# niRvana::get_samples_from_sampleid

```

### b. Year and station(s)
```{r}

selected_year <- 2020
selected_station <- "19N"

# Standard for Milkys
selected_species <- c("Gadus morhua", "Littorina littorea", "Mytilus edulis", "Nucella lapillus", 
    "Platichthys flesus", "Somateria mollissima")

# Get the selected_species:
# readRDS(file = "Files_to_Jupyterhub_2020/01_df_2020_notstandard_2021-08-19.rds") %>%
#   xtabs(~LATIN_NAME, .) %>% names() %>% dput()

```


## 1. Data from excel    

1. Eider duck data are from specimens/samples that MOSTLY ARE in the NIVAbase (for 2018 data, they were NOT) 
    - Sample ID given as Labware ID, e.g. 'NR-2020-09188' 
    - New records in BIOTA_SAMPLES only (SAMPLE_NO taken from data, get SAMPLE_ID from database)
    - Also note that although pairs of eggs and blood were unrelated (I think!),
      the same SPECIMEN_ID was giben for pairs of blood/egg samples     

2. NILU cod data (siloxans; D4,D5 and D6) are from specimens that MOSTLY ARE in the NIVAbase, 
but new samples (liver) are numbered corresponding to the muscle samples
   - Sample ID should normally be given as station number + sample number (1-100)
   - This was added manually in the excel file (Samperapport_edited.xlsx)
     based on the 'fake Labware ID' (e.g. 'NR-2020-09188') added (which doesn't correspond to
     the actual Labware IDs)
   - Use existing record in BIOTA_SINGLE_SPECIMENS (existing SPECIMEN_ID)
   - New records in BIOTA_SAMPLES_SPECIMENS - relationship between SAMPLE_NO and SPECIMEN_ID
   should be the same as for muscle
   - New records in BIOTA_SAMPLES (new SAMPLE_ID, SAMPLE_NO taken from data)

3. Biological effects in cod - from specimens that ARE in the NIVAbase, with the 
exception of a single cod individual (Fish_no = 15, station = 53B). New samples (bile, blood,
liver fraction). Samples are numbered corresponding to the muscle samples (as NILU cod)
    - Use existing records in BIOTA_SINGLE_SPECIMENS (existing SPECIMEN_ID)  
    - New records in BIOTA_SAMPLES_SPECIMENS (new SAMPLE_ID, but existing SPECIMEN_ID)  
    - New records in BIOTA_SAMPLES (new SAMPLE_ID, SAMPLE_NO taken from data)  


### a. Read Eider duck NILU data   
From script 808 (2020 version)  
- Station-defining columns  
    * not given
- Sample- (and specimen-)defining columns  
    * Sample_no_NILU - not used in this script     
    * Sample_no = NIVA sample number, containing TEXT_ID (example: `Nr. 2020-08432`)  - here used for all except siloxans  
    * TEXT_ID (already added in script 808 - all except siloxans)
    * TISSUE_NAME  
    * Specimen_label (1, 2, 3, .....) - here, only used for siloxans  
- Parameter  
    * PARAM
    * METHOD_ID (added in script 808 in this case)
    * UNIT
- Measurements  
    * Value   
    * Flag1  
```{r}

# NOTE!! PCB data with negative values (actually data < LOQ) were not correcetd to 
#   positive numbers with FLAG1 = "<"
# Later corrected in the database, see part 90 in this script  

dat_excel_1 <- readRDS("Data/808_dat_eiderduck_2020.rds") %>%
  mutate(TEXT_ID = sub("Nr. ", "NR-", Sample_no, fixed = TRUE)) %>%
  mutate(Specimen_label = as.numeric(Specimen_label))

# Show all
# xtabs(~TEXT_ID + Group, dat_excel_1)

if (FALSE){
  
  dat_excel_1 %>%
    count(TISSUE_NAME, TEXT_ID, Specimen_label) %>%
    arrange(TISSUE_NAME, TEXT_ID, Specimen_label)
  
}
```


### b. Check  
```{r}

xtabs(~Group + is.na(TEXT_ID), dat_excel_1)

xtabs(~Group + is.na(Specimen_label), dat_excel_1)

```

### c. Add TISSUE_NAME   
* Some NAs for HBCD records with TEXT_ID    
* Could also have done this in EXcel of course  
```{r}

# Some NA values 
# xtabs(~addNA(TISSUE_NAME) + Group + is.na(TEXT_ID), dat_excel_1)

lookup <- dat_excel_1 %>%
  filter(!is.na(TEXT_ID) & !is.na(TISSUE_NAME)) %>%
  distinct(TEXT_ID, TISSUE_NAME) %>%
  rename(TISSUE_NAME_new = TISSUE_NAME)

n <- nrow(dat_excel_1)
dat_excel_1 <- dat_excel_1 %>%
  left_join(lookup,  by = "TEXT_ID") %>%
  mutate(
    TISSUE_NAME = ifelse(is.na(TISSUE_NAME), TISSUE_NAME_new, TISSUE_NAME)
  )

if (nrow(dat_excel_1) > n){
  stop("TEXT_ID not unique")
}

# New check - all is OK now   
xtabs(~addNA(TISSUE_NAME) + addNA(Group), dat_excel_1)

```


## 2. Get some generic lookup tables  
* Tissues  
* Species names  
* Projects
* Methods  
```{r}

df_tissue <- get_nivabase_data(
  "select TISSUE_ID,TISSUE_NAME from NIVADATABASE.BIOTA_TISSUE_TYPES")

# Taxa (here: all taxa)
df_taxon <- get_nivabase_selection(
  "NIVA_TAXON_ID, LATIN_NAME", 
  "TAXONOMY", 
  "LATIN_NAME",
  selected_species, values_are_text = TRUE
)

# Get a list of projects
df_projects <- get_projects()   # we call it 'df_projects' (the default name)

# Get a list of stations
df_stations <- get_stations_from_project("CEMP_Biota", ignore.case = FALSE)

# Get df_methods (NILU methods only)
df_methods <- get_nivabase_selection(
  "*", 
  "METHOD_DEFINITIONS", 
  "LABORATORY", 
  "NILU", values_are_text = TRUE)

```

## 3. Creating df lookup_sample   

- created based on Labware and Nivadatabase   
- one line per sample    

### a. Get all Milkys samples from Labware table (actually a View)       
```{r}

# March-December data
sql <- paste(
  "select * from NIVADATABASE.LABWARE_CHECK_SAMPLE", 
  "where extract(YEAR from SAMPLED_DATE) =", selected_year, 
  "and extract(MONTH from SAMPLED_DATE) >= 3", 
  "and UPPER(PROSJEKT) like '%MILKYS%';")
sql
df_labware_01 <- get_nivabase_data(sql)

# January-February next year data (if any)
sql <- paste(
  "select * from NIVADATABASE.LABWARE_CHECK_SAMPLE", 
  "where extract(YEAR from SAMPLED_DATE) =", selected_year + 1, 
  "and extract(MONTH from SAMPLED_DATE) <= 2", 
  "and UPPER(PROSJEKT) like '%MILKYS%';")
df_labware_02 <- get_nivabase_data(sql)

# Remove everything except Eider duck stations
# Extract 'Specimen_no' and 'TISSUE_NAME'
df_samples_labware_all <- bind_rows(df_labware_01, df_labware_02) %>%
  # Add 'Specimen_no'
  mutate(DESCRIPTION = gsub("<f8>", "ø", DESCRIPTION, fixed = TRUE),
         DESCRIPTION = gsub("<c5>", "Å", DESCRIPTION, fixed = TRUE),
         DESCRIPTION = gsub("<e5>", "å", DESCRIPTION, fixed = TRUE),
         DESCRIPTION = gsub("<c6>", "Æ", DESCRIPTION, fixed = TRUE),
         DESCRIPTION = gsub("<e6>", "æ", DESCRIPTION, fixed = TRUE),
         DESCRIPTION2 = DESCRIPTION %>% stringr::str_sub(start = nchar(AQUAMONITOR_CODE) + 1),
         Specimen_label = stringr::str_extract(DESCRIPTION2, "[0-9]+") %>% as.numeric(),
         TISSUE_NAME = stringr::str_sub(TISSUE, start = 4))


```

### b. Pick the samples we focus on here  
- In this case, eidur duck  
```{r}

# Keep only Eider duck stations
df_samples_labware <- df_samples_labware_all %>%
  filter(AQUAMONITOR_CODE %in% selected_station)

if (FALSE){
  df_samples_labware %>%
    select(TEXT_ID, DESCRIPTION, SPECIES, TISSUE, Specimen_no, BIOTA_SAMPLENO, X_BULK_BIO) %>%
    arrange(TISSUE, BIOTA_SAMPLENO)
}

```

### c. Read existing Nivabase chemical data  
- % C, % N    
- Delta 13C, Delta 15N  
- PFAS  
```{r}

df_chem_specimens <- get_specimens_from_stationdata(
  df_stations %>% filter(STATION_CODE %in% selected_station))

# Add species 
df_chem_species <- get_nivabase_data(paste(
  "select a.TAXONOMY_CODE_ID, b.LATIN_NAME",
  "from NIVADATABASE.TAXONOMY_CODES a left join NIVADATABASE.TAXONOMY b",
  "on a.NIVA_TAXON_ID = b.NIVA_TAXON_ID",
  "where a.TAXONOMY_CODE_ID =",
  unique(df_chem_specimens$TAXONOMY_CODE_ID)
  ))
df_chem_specimens <- left_join(df_chem_specimens, df_chem_species, by = "TAXONOMY_CODE_ID")

# Get data frame of chemical results (30 seconds or so)
df_chem <- get_biota_chemistry(
  years = selected_year, 
  specimendata = df_chem_specimens, 
  stationdata = df_stations,
  report_samples = TRUE)

cat("\nDownloaded", nrow(df_chem), "records\n")

```

### d. Start the lookup table 'df_lookup_samples' for samples already included in Nivabasen    
- To be used for getting existing SAMPLE_ID   
- Also identifies samples in labware that have not entered the database (i.e. somethng is wrng in the labware data)      
```{r}

# Get the link (tissue, SAMPLE_NO) -> SAMPLE_ID by "extracting" from Nivabasen
df_for_join <- df_chem %>%
  # Get the sample IDs by "extracting" from Nivabasen
  distinct(SAMPLE_NO, TISSUE_NAME, SAMPLE_ID) %>%
  arrange(TISSUE_NAME, SAMPLE_NO)

# Start with labware samples, then add SAMPLE_ID 
df_lookup_samples <- df_samples_labware %>%
  select(AQUAMONITOR_CODE, TISSUE_NAME, BIOTA_SAMPLENO, X_BULK_BIO, TEXT_ID, Specimen_label) %>%
  # ...adding SAMPLE_ID:
  left_join(df_for_join, 
            by = c("TISSUE_NAME", "BIOTA_SAMPLENO" = "SAMPLE_NO"))

```

### e. Add specimen columns to 'df_lookup_samples'      
```{r}

# Get SPECIMEN_IDs from BIOTA_SAMPLES_SPECIMENS
existing_samples_spec <- get_nivabase_selection(
  "SAMPLE_ID, SPECIMEN_ID",
  "BIOTA_SAMPLES_SPECIMENS",
  "SAMPLE_ID",
  df_lookup_samples$SAMPLE_ID
)

# Get records from BIOTA_SINGLE_SPECIMENS
existing_specimens <- get_nivabase_selection(
  "SPECIMEN_ID, DATE_CAUGHT, STATION_ID, TAXONOMY_CODE_ID, SPECIMEN_NO",
  "BIOTA_SINGLE_SPECIMENS",
  "SPECIMEN_ID",
  unique(existing_samples_spec$SPECIMEN_ID)
  )

# Function for summarising several values to one text value (see example) 
summarise_values <- function(x){
  paste(unique(x), collapse = ",")
}
# Example:
# summarise_values(c(5,5,6))

# From BIOTA_SINGLE_SPECIMENS, create 1 row per sample
# E.g. if there are several individuals for a sample, "SPECIMEN_ID" and SPECIMEN_NO
#   will be one text value with the original value separated by comma (e.g "50000,50001" or "10,11")  
# STATION_ID, DATE_CAUGHT and TAXONOMY_CODE_ID should normallly be just one number
existing_specimens_by_sample <- existing_samples_spec %>%
  left_join(existing_specimens, by = "SPECIMEN_ID") %>%
  group_by(SAMPLE_ID) %>%
  summarise(across(.fns = summarise_values))

# Add to 'df_lookup_sample_id'  

# Check if spec
if (!"SPECIMEN_ID" %in% names(df_lookup_samples)){
  df_lookup_samples <- df_lookup_samples %>%
    left_join(existing_specimens_by_sample, by = "SAMPLE_ID")
    message("Specimen columns (SPECIMEN_ID, DATE_CAUGHT, STATION_ID, TAXONOMY_CODE_ID, SPECIMEN_NO) added")
} else {
  message("Specimen columns already added")
}

```
## 4. Checking 'df_lookup_samples'


### a. Lacking SAMPLE_ID? 

Should be all FALSE. (Used to lack 10 samples, error corrected now)
```{r}

# Lacking SAMPLE_ID? Should be all FALSE. (Used to lack 10 samples, error corrected now)
# Meaning: samples in labware samples that have not entered the database

check <- sum(is.na(df_lookup_samples$SAMPLE_ID))

if (check == 0){
  message("No SAMPLE_ID lacking")
} else {
  stop(check, " SAMPLE_IDs lacking. Some records in Labware has not entered NIVADATABASE")
}


#
# For sending to Espen, for fixing the error
#
if (FALSE){
  
  df_lookup_samples %>% 
    select(TISSUE_NAME, BIOTA_SAMPLENO, TEXT_ID, X_BULK_BIO, DESCRIPTION) %>%
    writexl::write_xlsx("Data/Prøver_ærfugl_2020_raw.xlsx")
  
  df_lookup_samples %>% 
    writexl::write_xlsx("Data/Prøver_ærfugl_2020_allekolonner.xlsx")
}

```
### b. Number of specimens per sample   
```{r}

check <- grepl(",", df_lookup_samples$SPECIMEN_ID, fixed = TRUE)

if (sum(check) == 0){
  message("No samples are linked to more than a single specimen (no pooled samples)")
} else {
  warning(sum(check), " samples are linked to several specimens (pooled samples).")
  df_lookup_samples[check,] %>%
    select(SAMPLE_ID, SPECIMEN_ID, SPECIMEN_NO) %>%
    knitr::kable(format = "html")
}


```

## 5. Check excel data with 'df_lookup_samples'  

### a. Add SAMPLE_ID to excel data     
- Using TEXT_ID for all except siloxans (part a)  
- Using TISSUE_NAME + SPECIMEN_NO for siloxans (part b)  
- In addition to lacking : Two samples (blod 10 + 11) have siloxan data but lack in Labware    
   - These two samples MUST BE ADDED    
```{r}

# Join this table 

# Add SAMPLE_ID by looking up TEXT_ID   
# For all excel rows *with* TEXT_ID (everything except siloxans in this case)
check_excel_a <- dat_excel_1 %>%
  filter(!is.na(TEXT_ID)) %>%
  left_join(df_lookup_samples %>% 
              select(TEXT_ID, BIOTA_SAMPLENO, X_BULK_BIO, SAMPLE_ID, SPECIMEN_NO) %>%
              rename(SPECIMEN_NO_nivabase = SPECIMEN_NO), 
            by = "TEXT_ID")

# Add SAMPLE_ID by looking up TISSUE_NAME + SPECIMEN_NO   
# For all excel rows *without* TEXT_ID (siloxans in this case)
check_excel_b <- dat_excel_1 %>%
  filter(is.na(TEXT_ID)) %>%
  left_join(df_lookup_samples %>% 
              select(TISSUE_NAME, Specimen_label, BIOTA_SAMPLENO, X_BULK_BIO, SAMPLE_ID, SPECIMEN_NO) %>%
              rename(SPECIMEN_NO_nivabase = SPECIMEN_NO), 
            by = c("TISSUE_NAME", "Specimen_label"))

# A lot of NAs in both cases, see previous chunk   
xtabs(~addNA(SAMPLE_ID), check_excel_a)   # all gets SAMPLE_ID 
xtabs(~addNA(SAMPLE_ID), check_excel_b)   # lacking SAMPLE_ID: sample exists in Excel but not in Labware + Nivadatabase 

# Check all samples
# 3 groups:
#   excel rows *with* TEXT_ID
#   excel rows *without* TEXT_ID but Excel SPECIMEN_NO has a corresponding Nivabasen SPECIMEN_NO
#   excel rows *without* TEXT_ID and Excel SPECIMEN_NO does not have a corresponding Nivabasen SPECIMEN_NO

check_excel <- bind_rows(check_excel_a, check_excel_b) %>%
  count(TEXT_ID, TISSUE_NAME, Specimen_label, 
        BIOTA_SAMPLENO, X_BULK_BIO, SAMPLE_ID, SPECIMEN_NO_nivabase)

```

### b. Summary  
```{r}

check_excel %>%
  count(TISSUE_NAME, SAMPLE_ID, BIOTA_SAMPLENO, SAMPLE_ID) %>%
  xtabs(n~is.na(SAMPLE_ID) + addNA(BIOTA_SAMPLENO) + addNA(TISSUE_NAME), .)  

```
### c. Decide SAMPLE_NO and SPECIMEN_NO to use
** By checking existing blood samples in NIVAbase   
```{r}

check_blood_samples <- df_lookup_samples %>%
  # Blood only
  filter(TISSUE_NAME == "Blod") %>%
  select(Specimen_label, BIOTA_SAMPLENO, SPECIMEN_NO) %>%
  arrange(Specimen_label)

# View(check_blood_samples)

# Specimen_label 1-9 => given BIOTA_SAMPLENO 6-14 and SPECIMEN_NO 106-114 
# Specimen_label 12 => given BIOTA_SAMPLENO 15 and SPECIMEN_NO 115
# Specimen_label 90-95 => given BIOTA_SAMPLENO 1-5 and SPECIMEN_NO 90-95    

# We decide to give
# Specimen_label 10-11 =>  16-17 and SPECIMEN_NO 116-117 


```


## 20. BIOTA_SAMPLES    

Makes `biota_samples`, used in 5  
In this case, quite similar to BIOTA_SINGLE_SPECIMENS, but includes TISSUE_ID   
- Note: EROD data should be given as TISSUE_ID = 64 (TISSUE_NAME = 'Liver - microsome'),
not TISSUE_ID = 3 (TISSUE_NAME = 'Lever')

### a. Start `biota_samples` 
```{r}
# df <- get_nivabase_data("select * from NIVADATABASE.BIOTA_SAMPLES where rownum < 4")
# df
# df %>% colnames() %>% dput()


# "SAMPLE_ID"            - Let the database decide
# "SPECIES_ID"           - NA seems to be the current standard for these data
# "TISSUE_ID"            - Lookup value from TISSUE_NAME
# "STATION_ID"           - Use value in 'data_for_input'
# "REMARK"               - NA
# "SAMPLE_NO"            - (e.g. 1-15 for each tissue) - reference to numbers found in Excel sheets
#                        - set to number found in Excel sheets + 100 to distinguish them
#                         from ordinary samples!
# "SAMPLE_DATE"          - set to TO_DATE('2019-09-03', 'yyyy-mm-dd')
# "TAXONOMY_CODE_ID"     - Lookup value
# "SAMPLE_DATE"          - Sample_date in 'data_insert2'

biota_samples_existing <- df_lookup_samples %>%
  # Blood only
  filter(TISSUE_NAME == "Blod") %>%
  pull(SAMPLE_ID) %>%
  get_nivabase_selection(
    "SPECIES_ID, TISSUE_ID, STATION_ID, SAMPLE_NO, REPNO, SAMPLE_DATE, TAXONOMY_CODE_ID",
    "BIOTA_SAMPLES",
    "SAMPLE_ID",
    .
  )

# Pick two random samples and use them for new samples
biota_samples <- biota_samples_existing[1:2,]

# WE only need to change SAMPLE_NO and REPNO - set according to previous chunk  
biota_samples$SAMPLE_NO <- 16:17
biota_samples$REPNO <- biota_samples$SAMPLE_NO

# For inspection of data 
biota_samples %>% 
  select(STATION_ID, TISSUE_ID, SAMPLE_NO, TAXONOMY_CODE_ID, SAMPLE_DATE) %>%
  arrange(STATION_ID, TISSUE_ID, SAMPLE_NO)

cat("===================================\n")
cat("Biota samples that will be inserted in database: \n")
# xtabs(~addNA(STATION_ID) + addNA(TISSUE_NAME), biota_samples)
xtabs(~addNA(STATION_ID) + addNA(TISSUE_ID), biota_samples)

# cat("===================================\n")
# cat("Records for input: \n")
# xtabs(~addNA(STATION_ID) + addNA(TISSUE_NAME), data_for_input)


# 47025
```

### b. Check 'biota_samples' vs single specimens   
NOT NEEDED

Check whether all stations/samples in 'biota_samples' has a corresponding fish in BIOTA_SINGLE_SPECIMENS  
- In this case, many of the 53B fish are from fish individuals that are not in the database   
- FOr these, we must not only add samples, but also BIOTA_SINGLE_SPECIMENS and BIOTA_SAMPLES_SPECIMENS  
```{r}

# check1 <- biota_samples %>% 
#   select(STATION_ID, SAMPLE_NO, TISSUE_NAME) %>%
#   safe_left_join(existing_singlespec %>% select(STATION_ID, SPECIMEN_NO, DATE_CAUGHT),
#                  na_matches = "never", 
#                  by = c("STATION_ID", "SAMPLE_NO" = "SPECIMEN_NO"),
#                  check = "Vm")     # 'm' means 'warn if not all x records are matched'   
#                                    # also prints the STATION_ID/SAMPLE_NO combinations
#                                    #    not matched


check1 <- data_for_input %>%
  select(STATION_CODE, TISSUE_NAME, SPECIMEN_NO) %>%
  mutate(SPECIMEN_NO = as.numeric(SPECIMEN_NO)) %>%
  left_join(existing_specimens, 
            by = c("STATION_CODE", "SPECIMEN_NO")) %>%
  filter(is.na(SPECIMEN_ID))

if (nrow(check1) == 0){
  message("All specimens found")  
} else {
  warning("Not all specimens found!")  
  # Show samples (STATION_CODE, TISSUE_NAME, SAMPLE_NO) lacking a specimen
  View(check1)
    
}

```



### c. Labware: Check SAMPLE_NO   
Not needed here (for Bjørnar and Espen)   


### d. Check tissues
There is a specific "liver - microsome" tissue 
```{r}
# Overview
biota_samples %>%
  xtabs(~STATION_ID + paste(TISSUE_ID, TISSUE_NAME), .)

```


### e. Make SQLs
PASTE INTO SQL DEVELOPER TO ADD THE RECORDS   
Note to DHJ: use "SQL developer (latest version)" from desktop. Don't use the start menu.  
- remember `commit;` after running the insert sentences   
- See `milkys_2020_eiderduck_biota_samples.sql` in `C:\Users\DHJ\AppData\Roaming\SQL Developer`  
```{r}

# Test functions
# make_sql_sample(1, biota_samples_eider)

sql_list <- 1:nrow(biota_samples) %>% 
  map_chr(make_sql_sample, data = biota_samples)
sql <- paste(sql_list, collapse = ";\n")
sql <- paste0(sql, ";\n")
writeLines(sql, "clipboard")  # copies SQLs to clipboard - go to SQL Developer and paste

cat("Number of SQLs: \n")
length(sql_list)  # 144

cat("\nSample of SQLs: \n")
sql_list[1:3]


```


### f1. Get the records we just added  
Directly from R, instead of pasting into SQL Developer for getting data  
- in contrast to the original of this code (for 2018 data)   
Remember to **commit** in SQL developer first  
```{r}

biota_samples_fromdatabase <- niRvana::get_nivabase_selection(
  "*",
  "BIOTA_SAMPLES",
  "STATION_ID",
  biota_samples$STATION_ID, 
  extra_where = paste(
    "and TRUNC(ENTERED_DATE) = TO_DATE('2021-08-29', 'yyyy-mm-dd')", 
    "and ENTERED_BY = 'DHJ'")
)

cat("Number of records: ")
nrow(biota_samples_fromdatabase) %>% cat()   # 144
cat("\nShould be the same as number of SQLs above! \n")


```

### f2. DELETE the records we just added  
- Only if needed of course
```{r}

get_nivabase_data("select count(*) from NIVADATABASE.BIOTA_SAMPLES")  #  60112

# DELETE from NIVADATABASE.BIOTA_SAMPLES where TRUNC(ENTERED_DATE) = TO_DATE('2021-09-30', 'yyyy-mm-dd') and ENTERED_BY = 'DHJ';
# commit;

```


### g. Add SAMPLE_ID from 'biota_samples_fromdatabase' 
```{r}

biota_samples <- biota_samples %>%
  safe_left_join(biota_samples_fromdatabase %>% select(STATION_ID, TISSUE_ID, TAXONOMY_CODE_ID, SAMPLE_NO, SAMPLE_ID), 
                 by = c("STATION_ID", "TISSUE_ID", "TAXONOMY_CODE_ID", "SAMPLE_NO"),
                 na_matches = "never",
                 check = "BCV") %>%
  safe_left_join(df_stations %>% select(STATION_ID, STATION_CODE),   # add STATION_CODE as well  
                 by = "STATION_ID",
                 na_matches = "never",
                 check = "BCV")
  

cat("Number of records: ")
length(unique(biota_samples$SAMPLE_ID)) %>% cat()
cat("\nShould be the same as above! \n")
cat("\n")

# Check ID
cat("SAMPLE_ID: ")
range(biota_samples$SAMPLE_ID) %>% paste(collapse = " - ") %>% cat()
cat("\n")

```

### h. Visualise `biota_samples`     
```{r}


if (FALSE) {
  
  # Check taht IDs are unique
  tab <- xtabs(~SAMPLE_ID, biota_samples)
  table(tab)
  
  # Check that SAMPLE_NO + TISSUE_NAME + STATION_ID are unique
  xtabs(~SAMPLE_NO + TISSUE_NAME + STATION_ID, biota_samples)
  
}

biota_samples %>%
  left_join(df_tissue) %>%
  ggplot(aes(TISSUE_NAME, SAMPLE_NO)) +
  geom_point() +
  facet_grid(cols = vars(STATION_CODE)) +
  theme(axis.text.x = element_text(hjust = 0, angle = -30))



```



### i. Make 'df_lookup_samples_new'   
- Will be the table used when we add data to the samples 
```{r}

# In 5c, we decided to give:
# Specimen_label 10-11 =>  16-17 and SPECIMEN_NO 116-117 

df_lookup_samples_new <- bind_rows(
  df_lookup_samples,
  data.frame(
    TISSUE_NAME = "Blod",
    Specimen_label = 10:11,
    SAMPLE_ID = biota_samples_fromdatabase$SAMPLE_ID,      # from (f1)
    SPECIMEN_NO = as.character(116:117))
  )

df_lookup_samples_new %>%
  select(TEXT_ID, TISSUE_NAME, Specimen_label, SAMPLE_ID, SPECIMEN_NO)
  
```


## 30. BIOTA_SINGLE_SPECIMENS  

### a. Gets existing BIOTA_SINGLE_SPECIMENS  
```{r}

existing_singlespec_1 <- get_nivabase_selection(
  "SPECIMEN_ID, DATE_CAUGHT, SPECIES_ID, STATION_ID, TAXONOMY_CODE_ID, SPECIMEN_NO",
  "BIOTA_SINGLE_SPECIMENS",
  "STATION_ID",
  unique(df_lookup_samples$STATION_ID),
  extra_where = " and extract(YEAR from DATE_CAUGHT) = 2020"
)


# Check
existing_singlespec_1 %>%
  left_join(df_stations %>% select(STATION_ID, STATION_CODE)) %>%
  ggplot(aes(x = STATION_CODE, y = SPECIMEN_NO)) +
  geom_point()


```

### b. Make specimens to add   
```{r}

# Start with two random blood specimens
# (We know they are blood from 5c)
biota_specimens_to_add <- existing_singlespec_1 %>%
  filter(SPECIMEN_NO %in% 106:107)

biota_specimens_to_add$SPECIMEN_NO <- 116:117

```


### b. Specimens we need vs. specimens we got   
NOT NEEDED HERE

### b1. Check samples in Labware file     
NOT NEEDED HERE
**For a bit improved code without hard-coded year, see "74...2019data"** 

### b3. Add SPECIMEN_NO to biota_samples     
NOT NEEDED HERE
Given that the checks above shows that two assumptions given in start of 'b' is OK   

### b4. Start 'biota_specimens_to_add'   
NOT NEEDED HERE
- In this case NONE - all speciemns are already there  

### c. Add date and species code   
to `existing_singlespec_date` 
- NOT NEEDED in this case  


### d. Make SQLs  
PASTE INTO SQL DEVELOPER TO ADD THE RECORDS   
Note to DHJ: use "SQL developer (latest version)" from desktop. Don't use the start menu.  
- remember `commit;` after running the insert sentences  
- See `milkys_2020_eiderduck_biota_specimens.sql` in `C:\Users\DHJ\AppData\Roaming\SQL Developer`  
```{r}
# Test functions
# make_sql_single_specimen(1, biota_single_specimens_eider)
# make_sql_single_specimen(2, biota_single_specimens_eider)

sql_list <- 1:nrow(biota_specimens_to_add) %>% 
  map_chr(make_sql_single_specimen, data = biota_specimens_to_add)
sql <- paste(sql_list, collapse = ";\n")
sql <- paste0(sql, ";\n")  
writeLines(sql, "clipboard")  # copies SQLs to clipboard - go to SQL Developer and paste


cat("Number of SQLs: \n")
length(sql_list)  # 9


cat("\nSample of SQLs: \n")
sql_list[1:3]

```

### e1. Get existing records in Nivabase
- CASE A: The records we just added  
- CASE B:
Directly from R, instead of pasting into SQL Developer for getting data  
- in contrast to the original of this code (for 2018 data)   
Remember to **commit** in SQL developer first   
- NOT NEEDED in this case - as this gets all specimens just added, and we didn't need to add any 
(we only need to add new links to the new samples, by adding records to BIOTA_SAMPLES_SPECIMENS, see below)
```{r}

#
# CASE A
#
if (TRUE){
  
  biota_specimens_fromdatabase <- niRvana::get_nivabase_selection(
    "*",
    "BIOTA_SINGLE_SPECIMENS",
    "STATION_ID",
    biota_samples$STATION_ID, 
    extra_where = paste(
      "and TRUNC(ENTERED_DATE) = TO_DATE('2021-08-29', 'yyyy-mm-dd')", 
      "and ENTERED_BY = 'DHJ'")
  )
  
  cat("Number of records: ")
  nrow(biota_specimens_fromdatabase) %>% cat()   # 144
  cat("\nShould be the same as number of SQLs above! \n\n")
  
}

#
# CASE B
#
if (FALSE){
  
  biota_specimens_fromdatabase <- get_nivabase_selection(
    "SPECIMEN_ID, DATE_CAUGHT, SPECIES_ID, STATION_ID, TAXONOMY_CODE_ID, SPECIMEN_NO",
    "BIOTA_SINGLE_SPECIMENS",
    "STATION_ID",
    unique(data_for_input$STATION_ID),
    extra_where = paste(" and extract(YEAR from DATE_CAUGHT) =", selected_year)
    )
  
}


# Check ID
cat("SPECIMEN_ID: ")
range(biota_specimens_fromdatabase$SPECIMEN_ID) %>% paste(collapse = " - ") %>% cat()
cat("\n")

```



## 40. BIOTA_SAMPLES_SPECIMENS   
Add records for   
1. The new specimens  
2. NOT NEEDED HERE: The 'old' specimens, linking to new samples (biota_samples)  

### a. Get all individuals   
NOT NEEDED HERE:
(including the new ones)
```{r}

biota_specimens_complete <- niRvana::get_nivabase_selection(
  "*",
  "BIOTA_SINGLE_SPECIMENS",
  "STATION_ID",
  unique(biota_samples$STATION_ID), 
  extra_where = paste(
    " and extract(YEAR from DATE_CAUGHT) =",
    selected_year)
    )

cat("Number of records: ")
nrow(biota_specimens_complete) %>% cat()   # 144

```

### b. Make `biota_samples_specimens`
```{r}

# biota_samples already have SPECIMEN_NO added (from 10b)
# biota_samples_specimens <- biota_samples %>%
#   select(STATION_ID, STATION_CODE, TISSUE_NAME, SAMPLE_NO, SAMPLE_ID, SPECIMEN_NO) %>%
#   safe_left_join(
#     biota_specimens_complete %>% select(STATION_ID, SPECIMEN_NO, SPECIMEN_ID),
#     na_matches = "never",
#     by = c("STATION_ID", "SPECIMEN_NO"),
#     check = "BCV")

# CAn just bind the like this, and check according to 5c
biota_samples_specimens <- bind_cols(
  biota_samples_fromdatabase %>% select(SAMPLE_ID, SAMPLE_NO) , 
  biota_specimens_fromdatabase %>% select(SPECIMEN_NO, SPECIMEN_ID)
)

cat("Number of records that will be added to BIOTA_SAMPLES_SPECIMENS: ")
nrow(biota_samples_specimens) %>% cat()   # 74

```

### c. Visualise biota_samples_specimens  
```{r}

if (FALSE)
  xtabs(~SAMPLE_NO + SPECIMEN_NO + STATION_ID, biota_samples_specimens)


ggplot(biota_samples_specimens, aes(SAMPLE_NO, SPECIMEN_NO)) +
  geom_point() +
  facet_grid(cols = vars(STATION_CODE), rows = vars(TISSUE_NAME)) +
  theme(axis.text.x = element_text(hjust = 0, angle = -30))

```


### d. Make SQLs  
PASTE INTO SQL DEVELOPER TO ADD THE RECORDS   
- See `milkys_2020_eiderduck_biota_samplesspec.sql` in `C:\Users\DHJ\AppData\Roaming\SQL Developer`  
```{r}
sql_list <- 1:nrow(biota_samples_specimens) %>% 
  map_chr(make_sql_samples_specimens, data = biota_samples_specimens)
sql <- paste(sql_list, collapse = ";\n")
sql <- paste0(sql, ";\n")
writeLines(sql, "clipboard")   # copies SQLs to clipboard - go to SQL Developer and paste

cat("Number of SQLs: \n")
length(sql_list)  # 144

cat("\nSample of SQLs: \n")
sql_list[1:3]

```

## 50. Recreating df lookup_sample   

- created based on Labware and Nivadatabase   
- one line per sample    

- already 
```{r}

```

### a. Get all Milkys samples from Labware table (actually a View)       
### b. Pick the samples we focus on here  
- df_samples_labware - has not changed  

### c. Read existing Nivabase chemical data  
df_chem - has not changed  

```{r}


existing_singlespec <- get_nivabase_selection(
  "SPECIMEN_ID, DATE_CAUGHT, SPECIES_ID, STATION_ID, SPECIMEN_NO",
  "BIOTA_SINGLE_SPECIMENS",
  "STATION_ID",
  unique(df_lookup_samples$STATION_ID),
  extra_where = " and extract(YEAR from DATE_CAUGHT) = 2020"
)

existing_samples_spec <- get_nivabase_selection(
  "SPECIMEN_ID, SAMPLE_ID",
  "BIOTA_SAMPLES_SPECIMENS",
  "SPECIMEN_ID",
  unique(existing_singlespec$SPECIMEN_ID)
)

existing_samples <- get_nivabase_selection(
  "SAMPLE_ID, STATION_ID, TISSUE_ID, REPNO, TAXONOMY_CODE_ID, SAMPLE_DATE, SAMPLE_NO",
  "BIOTA_SAMPLES",
  "SAMPLE_ID",
  unique(existing_samples_spec$SAMPLE_ID)
) 


# From BIOTA_SINGLE_SPECIMENS, create 1 row per sample
# E.g. if there are several individuals for a sample, "SPECIMEN_ID" and SPECIMEN_NO
#   will be one text value with the original value separated by comma (e.g "50000,50001" or "10,11")  
# STATION_ID, DATE_CAUGHT and TAXONOMY_CODE_ID should normallly be just one number
existing_specimens_by_sample <- existing_samples_spec %>%
  left_join(existing_singlespec, by = "SPECIMEN_ID") %>% # View
  group_by(SAMPLE_ID) %>%
  summarise(across(.fns = summarise_values))

# Add to 'df_lookup_sample_id'  

# Check if spec
if (!"SPECIMEN_ID" %in% names(existing_samples)){
  existing_samples <- existing_samples %>%
    left_join(existing_specimens_by_sample, by = "SAMPLE_ID")
    message("Specimen columns (SPECIMEN_ID, DATE_CAUGHT, STATION_ID, TAXONOMY_CODE_ID, SPECIMEN_NO) added")
} else {
  message("Specimen columns already added")
}

nrow(existing_samples)   # note: now 32, used to be 30 (until we added the two extra specimens / samples  
                         #   SPECIMEN_ID 332658-332659)

```

## 60. BIOTA_CHEMISTRY_VALUES

  ### a1. Add SAMPLE_ID to excel data     
- Same as making 'check_excel' in part 5 except that we use 'df_lookup_samples_new' instead of 'df_lookup_samples'  
- Using TEXT_ID for all except siloxans (part a)  
- Using TISSUE_NAME + SPECIMEN_NO for siloxans (part b)  
- In addition to lacking : Two samples (blod 10 + 11) have siloxan data but lack in Labware    
   - These two samples MUST BE ADDED    
```{r}

# Join this table 

# Add SAMPLE_ID by looking up TEXT_ID   
# For all excel rows *with* TEXT_ID (everything except siloxans in this case)
dat_insert_a <- dat_excel_1 %>%
  filter(!is.na(TEXT_ID)) %>%
  left_join(df_lookup_samples_new %>% 
              select(TEXT_ID, BIOTA_SAMPLENO, X_BULK_BIO, SAMPLE_ID, SPECIMEN_NO) %>%
              rename(SPECIMEN_NO_nivabase = SPECIMEN_NO), 
            by = "TEXT_ID")

# Add SAMPLE_ID by looking up TISSUE_NAME + SPECIMEN_NO   
# For all excel rows *without* TEXT_ID (siloxans in this case)
dat_insert_b <- dat_excel_1 %>%
  filter(is.na(TEXT_ID)) %>%
  left_join(df_lookup_samples_new %>% 
              select(TISSUE_NAME, Specimen_label, BIOTA_SAMPLENO, X_BULK_BIO, SAMPLE_ID, SPECIMEN_NO) %>%
              rename(SPECIMEN_NO_nivabase = SPECIMEN_NO), 
            by = c("TISSUE_NAME", "Specimen_label"))

# A lot of NAs in both cases, see previous chunk   
xtabs(~addNA(SAMPLE_ID), dat_insert_a)   # all gets SAMPLE_ID 
xtabs(~addNA(SAMPLE_ID), dat_insert_b)   # lacking SAMPLE_ID: sample exists in Excel but not in Labware + Nivadatabase 

# Check all samples
# 3 groups:
#   excel rows *with* TEXT_ID
#   excel rows *without* TEXT_ID but Excel SPECIMEN_NO has a corresponding Nivabasen SPECIMEN_NO
#   excel rows *without* TEXT_ID and Excel SPECIMEN_NO does not have a corresponding Nivabasen SPECIMEN_NO

dat_insert <- bind_rows(dat_insert_a, dat_insert_b)

if (sum(is.na(dat_insert$SAMPLE_ID))>0)
  stop("Not all data have gotten SAMPLE_ID!")

```

### a2. Last check  
```{r}

check <- dat_insert %>%
  count(TEXT_ID, TISSUE_NAME, Specimen_label, SAMPLE_ID) %>%
  arrange(SAMPLE_ID)
View(check)

```


### a3. Make lookup table for METHOD_ID   
NOT NEEDED HERE
df_lookup_methodid   



### b. Start `biota_chemistry_values_eider`   
By selecting columns and adding `METHOD_ID`   
```{r}
# df <- get_nivabase_data("select * from NIVADATABASE.BIOTA_CHEMISTRY_VALUES where rownum < 4")
# df
# df %>% colnames() %>% dput()

# "VALUE_ID"              - Let the database decide
# "SAMPLE_ID"             - From the database, after BIOTA_SAMPLES have been inserted
# "METHOD_ID"             - Lookup based on NAME and UNIT
# "VALUE"                 - From data
# "FLAG1"                 - From data
# "FLAG2"                 - NA
# "ENTERED_BY"            - DHJ
# "ENTERED_DATE"          - date, see above
# "REMARK"                - NA
# "DETECTION_LIMIT"       - NA
# "UNCERTAINTY"           - NA
# "QUANTIFICATION_LIMIT"  - NA
# "APPROVED"              - NA?

# For adding METHOD_ID - in this case we already have it
# biota_chemistry_values1 <- dat_insert %>%
#   safe_left_join(df_lookup_methodid, by = c("NAME", "UNIT"), 
#                  check = "VM", na_matches = "never")

biota_chemistry_values1 <- dat_insert %>%
  rename(VALUE = Value, 
         FLAG1 = Flag1)

biota_chemistry_values1 %>%
  select(TISSUE_NAME, SAMPLE_ID, METHOD_ID, VALUE, FLAG1)   # possibly also STATION_CODE

# Only records with a value
biota_chemistry_values2 <- biota_chemistry_values1 %>%
  filter(!is.na(VALUE))

```

### c. Add SAMPLE_ID  
NOT NEEDED HERE  (did that in a1)
```{r}

if (FALSE){

  biota_chemistry_values2 <- biota_chemistry_values1 %>%
    safe_left_join(df_lookup_sample_id, by = c("TISSUE_NAME", "SAMPLE_NO"), 
                   check = "BCVMn", na_matches = "never")
  
  biota_chemistry_values2$SAMPLE_ID %>% unique() %>% sort()
  
}

cat("\n")
cat("Number of SAMPLE_ID lacking (must be zero): \n")
sum(is.na(biota_chemistry_values2$SAMPLE_ID))

```


### d. Make SQLs  
And copies them to clipboard  
PASTE INTO SQL DEVELOPER TO ADD THE RECORDS  
- remember `commit;` after running the insert sentences  
- See `milkys_2020_eiderduck_biota_values.sql` in `C:\Users\DHJ\AppData\Roaming\SQL Developer`  
```{r}

sql_list <- 1:nrow(biota_chemistry_values2) %>% 
  map_chr(make_sql_chemistry_values, data = biota_chemistry_values2)
cat("Number of sql sentences: \n") # 2340
length(sql_list) # 2340

i <- 1:length(sql_list)
sql <- paste(sql_list[i], collapse = ";\n") # join sqls together, with "new line" character between
sql <- paste0(sql, ";\n")                   # add final "new line" character at the end
writeLines(sql, "clipboard-1024")   # copies SQLs to clipboard - go to SQL Developer and paste
                                    # "clipboard-1024" instead of "clipboard": increases avaliable
                                    #    for the clipboard

cat("\n") # 2340
cat("First sql sentences: \n") # 2340
head(sql_list, 3)

cat("\n") # 2340
cat("Last sql sentence: \n") # 2340
tail(sql_list, 1)


```



## 70. Reread and check data  

### a. Reread data 
```{r}

df_chem_specimens <- get_specimens_from_stationdata(
  df_stations %>% filter(STATION_CODE %in% "19N"))

# Get data frame of chemical results (30 seconds or so)
df_chem <- get_biota_chemistry(
  years = selected_year, 
  specimendata = df_chem_specimens, 
  stationdata = df_stations,
  report_samples = TRUE)

cat("\nDownloaded", nrow(df_chem), "records\n")

xtabs(~NAME + STATION_CODE, df_chem)

# range(df_chem$VALUE_ID)
# 1991470 2006914

```

### b. Test plot  
```{r}

df_chem %>%
  filter(grepl("BDE", NAME)) %>%
  ggplot(aes(NAME, VALUE, color = TISSUE_NAME)) + 
  geom_jitter(width = 0.1) +
  theme(axis.text.x = element_text(angle = -45, hjust = 0))

df_chem %>%
  filter(grepl("PCB", NAME)) %>%
  ggplot(aes(NAME, VALUE, color = TISSUE_NAME)) + 
  geom_jitter(width = 0.1) +
  theme(axis.text.x = element_text(angle = -45, hjust = 0))

# Metals + dechlorans  
df_chem %>%
  filter(nchar(NAME) == 2) %>%
  ggplot(aes(NAME, VALUE, color = TISSUE_NAME)) + 
  geom_jitter(width = 0.1) +
  theme(axis.text.x = element_text(angle = -45, hjust = 0))

```

## 80. Fix error in values 
- PCB data were inserted with negative values, these are actually data <LOQ!  
- Here we just modfy the values in place, using UPDATE in SQL

### a. Get VALUE_ID start and stop  
```{r}

#
# First, read 'df_chem' from file (part 70) 
#

# Data in 3 groups 
# df_chem$VALUE_ID %>% sort() %>% plot()

# Get all columns including ENTERED_BY and ENTERED_DATE   
df_chem_full <- get_nivabase_selection(
  "*",
  "BIOTA_CHEMISTRY_VALUES",
  "VALUE_ID",
  df_chem$VALUE_ID
)

df_chem_full$ENTERED_BY %>% table()
        #  DHJ      LABWARE NIVADATABASE 
        # 2122          280          140 

# Pick only those inserted by myself:
df_chem_dhj <- df_chem_full %>% 
  filter(ENTERED_BY == "DHJ")

# Range of VALUE_ID
df_chem_dhj$VALUE_ID %>% range()
# 2004793 2006914

# Check - line 1 should be line 2 minus 1
a <- df_chem_dhj$VALUE_ID %>% range() %>% diff() # 15444
b <- nrow(df_chem_dhj)  # 2542
if (b == a+1){
  message("VALUE_ID is a contiguous sequence and can be used to modify/remove data in the database")
} else {
  stop("VALUE_ID are not a contiguous sequence")
}


  


```

### b. Get data with errors  
- used in (d)
```{r}

df_chem_error <- get_nivabase_selection(
  "*",
  "BIOTA_CHEMISTRY_VALUES",
  "VALUE_ID",
  2004793:2006914,
  extra_where = " and VALUE < 0"
)

nrow(df_chem_dhj)
nrow(df_chem_error)
# [1] 2122
# [1] 244

```
### c. Update syntax  
- Copy-pasted into SQL developer   
- See SQL_scripts/Milkys_2020_Eider_fix_values.sql  

```
UPDATE NIVADATABASE.BIOTA_CHEMISTRY_VALUES
SET FLAG1 = '<' WHERE VALUE_ID >= 2004793 and VALUE_ID <= 2006914 and VALUE < 0;

UPDATE NIVADATABASE.BIOTA_CHEMISTRY_VALUES
SET VALUE = (-VALUE) WHERE VALUE_ID >= 2004793 and VALUE_ID <= 2006914 and VALUE < 0;

commit;

```

### d. Check again  
```{r}

df_check <- get_nivabase_selection(
  "*",
  "BIOTA_CHEMISTRY_VALUES",
  "VALUE_ID",
  2004793:2006914
)

df_check %>% filter(VALUE < 0)
# nothing

# Check first line in 'df_chem_error':  
df_check %>% filter(VALUE_ID == 2006358)
# has been corrected  



```


## 81. Add PBDE (BDE) data for eider duck blood   
- These were not in the excel file when I inserted the data  
  
1. Run 1-2 above (dat_excel_1)  
2. Run 3-4 above (df_samples_labware)  
3. Then run a. below  
4. Then run part 60 above
- the resulting sql script was 'Milkys_2020_Eider_add_BDE_in_blood.sql')


### a. Filter 'dat_excel_1' 
- so it only contains data we want to add   
- also, create 'df_lookup_samples_new'  
```{r}

if (FALSE){
  
  # BACKUP
  # dat_excel_1_back <- dat_excel_1
  # Restore
  # dat_excel_1 <- dat_excel_1_back
  
  dat_excel_1 <- dat_excel_1 %>%
    filter(Group %in% "PBDE" & TISSUE_NAME %in% "Blod")
  
  df_lookup_samples_new <- df_lookup_samples
  
}


```
