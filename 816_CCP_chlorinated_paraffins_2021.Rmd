---
title: "816_CCP_chlorinated_paraffins"
author: "DHJ"
date: "2022-12-10"
output: 
  html_document:
    keep_md: TRUE
    toc: true
    toc_float: true
---

* Extract SCCP and MCCP data from Labware   
    - Data given excl. and excl. LOQ  
    - Data with "T" (mostly for excl. LOQ) has not been transferred to Nivabase, so a lot of zeros missed  
    - This of course affects the median  
* Done here:  
    - Change "T" to zero for all results   
    - Set FLAG1 to zero, as it doesn't have any meaning for these data    
    - Make one data set for merging with "database data" on tall format, but also a "for_analysis" data with lower and upper bound  
* NOTE: 

## 1. Libraries
```{r setup, include=FALSE}
# install.packages("niRvana")

library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)

# And then the niRvana package. If you need to install it, then run thee next line also:
# devtools::install_github("NIVANorge/niRvana")
library(niRvana)

source("802_Get_NIVAbasen_data_functions.R")

```

### Settings  
```{r}

sampling_year <- 2021

```


## 2. Check data in LIMS

- Project 'O 210200.ANAIN' is hard-coded  
- NOTE: no selection for year (but see 3)

### One station as example  

```{r}

df_labware_meta <- get_nivabase_data("select * from NIVADATABASE.LABWARE_CHECK_SAMPLE where PROSJEKT = 'O 210200.ANAIN'")
nrow(df_labware_meta) # 982

# get_nivabase_data("select * from NIVADATABASE.LABWARE_IMPORT where rownum < 4")

# One station  
test <- get_nivabase_data(
  "select * from NIVADATABASE.LABWARE_IMPORT where PROSJEKT = 'O 210200.ANAIN' and AQUAMONITOR_CODE = '30B'")

table(substr(test$TEXT_ID, 1, 7))

# Pick 2021 only
test_2021 <- test %>%
  filter(substr(TEXT_ID, 4, 7) == "2021")
test_2022 <- test %>%
  filter(substr(TEXT_ID, 4, 7) == "2022")

# xtabs(~addNA(PARAM), test)  
# - MCCP and SCCP - not giving 
# xtabs(~addNA(PARAM_I_AQUAMONITOR), test)  # nothing  


```

### Normal indication of <LOQ data  

- ENTRY_QUALIFIER is NA or "<"  
- Example: BDEs  

```{r}

test_2021 %>%
  filter(REPORTED_NAME %in% c("BDE99", "BDE100", "BDE209")) %>%
  xtabs(~REPORTED_NAME + addNA(ENTRY_QUALIFIER), .)

```



#### Indication of <LOQ data for CCPs    

- FORMATTED_ENTRY is a number or "ND"  

```{r}

test_2021 %>%
  filter(REPORTED_NAME %in% c("SCCP eksl. LOQ", "SCCP inkl. LOQ", "MCCP eksl. LOQ", "MCCP inkl. LOQ")) %>%
  xtabs(~REPORTED_NAME + (FORMATTED_ENTRY == "ND"), .)

```


#### SAMPLE_NUMBER    
```{r}

test_2021 %>%
  count(SAMPLE_NUMBER) %>%
  arrange(SAMPLE_NUMBER) %>%
  group_by(n) %>%
  summarize(
    n = n(),
    min = min(SAMPLE_NUMBER),
    max = max(SAMPLE_NUMBER),
    diff = max-min)

```


#### Types of registered samples, 2021   

* One type of sample for muscle (mercury), another for liver   

```{r}

test_2021b <- test_2021 %>%
  group_by(TEXT_ID) %>%
  arrange(ANALYS) %>%
  summarize(
    no_params = n(),
    ANALYS = substr(paste(ANALYS, collapse = " // "), 1, 50)
    )

test_2021b %>% filter(no_params == 1) %>% head()

test_2021b %>%
  arrange(TEXT_ID) %>%
  mutate(TEXT_ID_no = as.numeric(substr(TEXT_ID, 9, 13))) %>%
  group_by(no_params) %>%
  summarize(
    no_samples = n(),
    min_ID = min(TEXT_ID_no),
    max_ID = max(TEXT_ID_no),
    diff = max_ID - min_ID,
    ANALYS_first = first(ANALYS))

```


#### Types of registered samples, 2022  

* More complex than 2021:  
    - as 2021, one type of sample for muscle (mercury, no_params = 1), another type for liver (no_params = 82)  
    - no_params = 3: siloxans (15 samples set up as midlertidig, 15 set up with final values  )  
    - no_params = 5 and 6: isotopes (SIA)    
    - no_params = 9, 10, 19: gall metabolites  

```{r}

test_2022b <- test_2022 %>%
  group_by(TEXT_ID) %>%
  arrange(ANALYS) %>%
  summarize(
    no_params = n(),
    no_val = sum(FORMATTED_ENTRY != "T"),
    ANALYS = substr(paste(ANALYS, collapse = " // "), 1, 50)
    )
  
test_2022b %>%
  arrange(TEXT_ID) %>%
  mutate(TEXT_ID_no = as.numeric(substr(TEXT_ID, 9, 13))) %>%
  group_by(no_params) %>%
  summarize(
    no_samples = n(),
    min_ID = min(TEXT_ID_no),
    max_ID = max(TEXT_ID_no),
    diff = max_ID - min_ID,
    no_val = round(mean(no_val), 2),
    ANALYS_first = first(ANALYS))

```


#### Checking 

```{r}

i <- 1     # muscle, mercury
i <- 3     # siloxans
i <- 5     # isotopes
#i <- 5:6    # isotopes + SIA
i <- 6     # isotopes + SIA - lacking numbers  
i <- 9   # metabolites (no values)
i <- 10   # metabolites
i <- 19   # metabolites. includiing absorbanse  

tab1 <- test_2022 %>%
  group_by(TEXT_ID, STATUSX) %>%
  mutate(no_params = n()) %>%
  filter(no_params %in% i) %>%
  xtabs(~REPORTED_NAME + TEXT_ID + STATUSX, .)

tab2 <- test_2022 %>%
  filter(STATUSX == "Ferdig") %>%
  group_by(TEXT_ID) %>%
  mutate(no_params = n()) %>%
  filter(no_params %in% i) %>%
  xtabs(~REPORTED_NAME + TEXT_ID, .)

tab2

# i <- 19
# test_2022 %>%
#   group_by(TEXT_ID) %>%
#   mutate(no_params = n()) %>%
#   filter(no_params == i) %>%
#   xtabs(~REPORTED_NAME + TEXT_ID, .)

if (FALSE){
  test_2022 %>%
    group_by(TEXT_ID) %>%
    arrange(TEXT_ID, REPORTED_NAME) %>%
    mutate(no_params = n()) %>%
    filter(no_params %in% i) %>%
    select(TEXT_ID, DESCRIPTION:T_ANALYSIS_METHOD, FORMATTED_ENTRY, UNITS) %>%
    View(paste("test", i))
  
  # Reanalysis? 
  test_2022 %>%
    filter(REPORTED_NAME == "1-OH-fenantren" & DESCRIPTION == "30B Inner Oslofjord - Torsk galle 1") %>%
    select(TEXT_ID, DESCRIPTION:T_ANALYSIS_METHOD, STATUSX, FORMATTED_ENTRY, UNITS)
  }

    
```

## 3. Get data from LIMS (all years)  


### Find projects  

* By searching for "SCCP eksl. LOQ"   

```{r}

check <- get_nivabase_selection(
  "PROSJEKT, REPORTED_NAME, SAMPLED_DATE",
  "LABWARE_IMPORT",
  "REPORTED_NAME",
  c("SCCP eksl. LOQ"), values_are_text = TRUE) %>%
  mutate(
    Month = month(SAMPLED_DATE),
    Year = year(SAMPLED_DATE),
    MYEAR = case_when(
      Month <= 2 ~ Year-1,
      Month >= 3 ~ Year))

tab <- xtabs(~PROSJEKT + MYEAR, check)
tab

# for writing code:
# rownames(tab) %>% dput()

```

#### Make project string  

```{r}

projects <- c("O 16330 ANA15 MILKYS 2016", 
              "O 17330;ANA16 MILKYS 2016/17", 
              "O 18330;ANA17 Milkys 2018, analyser-hoved-2017pr", 
              "O 19330;ANA18 - MILKYS 2018", 
              "O 19330;ANA19 - MILKYS2019", 
              "O 210330;ANA21 - MILKYS 2021; Hovedanalyser 2021",
              "O 210200.ANAIN")

# Make project string
old.o <- options(useFancyQuotes = FALSE)

project_string_0 <- paste(sQuote(projects), collapse = ", ")
project_string <- paste("and PROSJEKT in (", project_string_0, ")")
project_string

options(old.o)

```

### Select by project and parameters   

```{r}

# paste(names(test), collapse = ", ")

vars <- "SAMPLE_TYPE, SAMPLED_DATE, AQUAMONITOR_ID, AQUAMONITOR_CODE, REPORTED_NAME, ENTRY_QUALIFIER, FORMATTED_ENTRY, NUMERIC_ENTRY, UNITS, DESCRIPTION, STATUS, STATUSX, TEXT_ID, PROSJEKT, ANALYSEOPPDRAG, SAMPLE_NUMBER, T_ANALYSIS_METHOD, ANALYS"

df_ccp_all <- get_nivabase_selection(
  vars,
  "LABWARE_IMPORT",
  "REPORTED_NAME",
  c("SCCP eksl. LOQ", "SCCP inkl. LOQ", "MCCP eksl. LOQ", "MCCP inkl. LOQ"), values_are_text = TRUE, 
  extra_sql = project_string) %>%
  mutate(
    Month = month(SAMPLED_DATE),
    Year = year(SAMPLED_DATE),
    MYEAR = case_when(
      Month <= 2 ~ Year-1,
      Month >= 3 ~ Year))

xtabs(~STATUSX + MYEAR, df_ccp_all)
xtabs(~STATUS + MYEAR, df_ccp_all)

# xtabs(~STATUS + STATUSX + MYEAR, df_ccp_all)

# View(df_ccp_all %>% filter(MYEAR == 2022))  

```



## 4. One year only  

* Select by status (A = accepted) and (last) year  

```{r}

df_ccp <- df_ccp_all %>%
  filter(
    STATUS %in% "A",
    MYEAR  %in% sampling_year)

```


#### Tabulate data  

- Eksl. LOQ may be numeric or 'ND'  
- Inkl. LOQ is numeric  
- For one cod station, many samples have 'T' for both   

```{r}

check1 <- df_ccp %>%
  filter(REPORTED_NAME %in% c("SCCP eksl. LOQ", "SCCP inkl. LOQ")) %>%
  mutate(Type = case_when(
    FORMATTED_ENTRY == "ND" ~ "ND",
    FORMATTED_ENTRY == "T" ~ "T",
    !is.na(as.numeric(sub(",", ".", FORMATTED_ENTRY))) ~ "Numeric",
    TRUE ~ "??"))

# xtabs(~AQUAMONITOR_CODE, check1)

cat("\n\n\n")
cat("Eksl. LOQ \n")
xtabs(~AQUAMONITOR_CODE + Type, check1 %>% filter(REPORTED_NAME %in% "SCCP eksl. LOQ")) %>% head(10)

cat("==================================\n")
cat("Inkl. LOQ \n")
xtabs(~AQUAMONITOR_CODE + Type, check1 %>% filter(REPORTED_NAME %in% "SCCP inkl. LOQ")) %>% head(10)

```

### SCCP  

* Get adapted SCCP data  

#### Viewing (for understanding)        
```{r}

check <- df_ccp %>%
  filter(REPORTED_NAME %in% c("SCCP eksl. LOQ", "SCCP inkl. LOQ")) %>%
  select(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID, REPORTED_NAME, FORMATTED_ENTRY) %>%
  tidyr::pivot_wider(names_from = REPORTED_NAME, values_from = FORMATTED_ENTRY) %>%
  arrange(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID)


## View data  

# View(check)

```


#### Make data for export      

- Change "T" to zero for all results   
- Set FLAG1 to zero, it doesn't have any meaning for these data       

```{r}

params <- c("SCCP eksl. LOQ", "SCCP inkl. LOQ")

df_selected <- df_ccp %>%
  filter(REPORTED_NAME %in% params & !FORMATTED_ENTRY %in% "T") %>%
  select(AQUAMONITOR_ID, AQUAMONITOR_CODE, MYEAR, TEXT_ID, REPORTED_NAME, FORMATTED_ENTRY) %>%
  mutate(Value_temp = as.numeric(sub(',', '.', FORMATTED_ENTRY)))

check <- xtabs(~FORMATTED_ENTRY, df_selected %>% filter(is.na(Value_temp)))

cat("\n")

if (identical(names(check), "ND")){
  message("All FORMATTED_ENTRY are either numeric or 'ND', as expected")
} else {
  stop("Some not-numeric data are something else than 'ND'! Check table called 'check'.")
}


df_SCCP_for_database <- df_selected %>%
  mutate(
    VALUE = case_when(
      FORMATTED_ENTRY == "ND" ~ 0,
      TRUE ~ Value_temp),
    # Just set FLAG1 to be NA, whatever
    FLAG1 = as.character(NA)
  )

# Alternative for FLAG1?
    # FLAG1 = case_when(
    #   FORMATTED_ENTRY == "ND" ~ "<",
    #   TRUE ~ as.character(NA))

df_SCCP_for_analysis <- df_SCCP_for_database %>%
  select(AQUAMONITOR_ID, AQUAMONITOR_CODE, MYEAR, TEXT_ID, REPORTED_NAME, VALUE) %>%
  tidyr::pivot_wider(names_from = REPORTED_NAME, values_from = VALUE) %>%
  arrange(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID) %>%
  rename(
    Value_lo = `SCCP eksl. LOQ`,
    Value_up = `SCCP inkl. LOQ`,
  )

```


### MCCP  

* Get adapted MCCP data  

#### Viewing (for understanding)        
```{r}

check <- df_ccp %>%
  filter(REPORTED_NAME %in% c("MCCP eksl. LOQ", "MCCP inkl. LOQ")) %>%
  select(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID, REPORTED_NAME, FORMATTED_ENTRY) %>%
  tidyr::pivot_wider(names_from = REPORTED_NAME, values_from = FORMATTED_ENTRY) %>%
  arrange(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID)


## View data  

# View(check)

```


#### Make data for export  

- As above (for SCCP)

```{r}

params <- c("MCCP eksl. LOQ", "MCCP inkl. LOQ")

df_selected <- df_ccp %>%
  filter(REPORTED_NAME %in% params & !FORMATTED_ENTRY %in% "T") %>%
  select(AQUAMONITOR_ID, AQUAMONITOR_CODE, MYEAR, TEXT_ID, REPORTED_NAME, FORMATTED_ENTRY) %>%
  mutate(Value_temp = as.numeric(sub(',', '.', FORMATTED_ENTRY)))

check <- xtabs(~FORMATTED_ENTRY, df_selected %>% filter(is.na(Value_temp)))

cat("\n")

if (identical(names(check), "ND")){
  message("All FORMATTED_ENTRY are either numeric or 'ND', as expected")
} else {
  stop("Some not-numeric data are something else than 'ND'! Check table called 'check'.")
}

df_MCCP_for_database <- df_selected %>%
  mutate(
    VALUE = case_when(
      FORMATTED_ENTRY == "ND" ~ 0,
      TRUE ~ Value_temp),
    # Just set FLAG1 to be NA, whatever
    FLAG1 = as.character(NA)
  )

# Alternative for FLAG1?
    # FLAG1 = case_when(
    #   FORMATTED_ENTRY == "ND" ~ "<",
    #   TRUE ~ as.character(NA))

df_MCCP_for_analysis <- df_MCCP_for_database %>%
  select(AQUAMONITOR_ID, AQUAMONITOR_CODE, MYEAR, TEXT_ID, REPORTED_NAME, VALUE) %>%
  tidyr::pivot_wider(names_from = REPORTED_NAME, values_from = VALUE) %>%
  arrange(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID) %>%
  rename(
    Value_lo = `MCCP eksl. LOQ`,
    Value_up = `MCCP inkl. LOQ`,
  )

```

## 5. All years    


* Make data for export      

    - Basis is "eksl." data  
    - When "eksl." data is numeric, use this (over LOQ) value   
    - When "eksl." = "ND", set FLAG1 = < and use the "inkl. LOQ" value as the LOQ value     

### SCCP     

#### Prepare, check for duplicates 

```{r}

params <- c("SCCP eksl. LOQ", "SCCP inkl. LOQ")

df_selected <- df_ccp_all %>%
  filter(REPORTED_NAME %in% params & !FORMATTED_ENTRY %in% "T") %>%
  select(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID, MYEAR, SAMPLED_DATE, REPORTED_NAME, FORMATTED_ENTRY, STATUS, STATUSX) %>%
  mutate(Value_temp = as.numeric(sub(',', '.', FORMATTED_ENTRY)))

check <- xtabs(~FORMATTED_ENTRY, df_selected %>% filter(is.na(Value_temp)))

cat("\n")

check2 <- names(check) %in% c("n.r.", "nd", "ND")

if (sum(!check2) == 0){
  message("All FORMATTED_ENTRY are either numeric or some sort of 'ND', as expected")
} else {
  stop("Some not-numeric data are something else than 'ND'! Check table called 'check'.")
}

#
# Remove duplicates - VERY MUCH SPECIALIZED CODE
#

# 09543: keep the lowest value for 'incl.'
#
sel <- with(df_selected, TEXT_ID == "NR-2018-09543" & REPORTED_NAME == "SCCP inkl. LOQ" & FORMATTED_ENTRY == "40,7"); sum(sel)
if (sum(sel) == 1)
  df_selected <- df_selected[!sel,]
#
# 09544: keep the numeric value for 'incl.', keep the ND for 'eksl.'  
#
sel <- with(df_selected, TEXT_ID == "NR-2018-09544" & REPORTED_NAME == "SCCP eksl. LOQ" & FORMATTED_ENTRY != "ND"); sum(sel)
if (sum(sel) == 1)
  df_selected <- df_selected[!sel,]
sel <- with(df_selected, TEXT_ID == "NR-2018-09544" & REPORTED_NAME == "SCCP inkl. LOQ" & FORMATTED_ENTRY == "ND"); sum(sel)
if (sum(sel) == 1)
  df_selected <- df_selected[!sel,]
#
# 09544: keep the numeric value for 'incl.', keep the ND for 'eksl.'  
#
sel <- with(df_selected, TEXT_ID == "NR-2018-09545" & REPORTED_NAME == "SCCP eksl. LOQ" & FORMATTED_ENTRY != "ND"); sum(sel)
if (sum(sel) == 1)
  df_selected <- df_selected[!sel,]
sel <- with(df_selected, TEXT_ID == "NR-2018-09545" & REPORTED_NAME == "SCCP inkl. LOQ" & FORMATTED_ENTRY == "ND"); sum(sel)
if (sum(sel) == 1)
  df_selected <- df_selected[!sel,]

#
# Check
#

check_duplicates <- df_selected %>%
  select(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID, REPORTED_NAME, FORMATTED_ENTRY, Value_temp) %>%
  dplyr::group_by(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID, REPORTED_NAME) %>%
  dplyr::mutate(n = dplyr::n(), 
                Value_min = min(Value_temp), Value_max = max(Value_temp),
                N_na = sum(is.na(Value_temp)),
                Value_diff = Value_max - Value_min,
                OK = case_when(
                  N_na > 0 & N_na < n ~ FALSE,  # if one, but not both values are NA 
                  Value_diff > 0 ~ FALSE,       # if values are different
                  TRUE ~ TRUE)) %>%
  dplyr::filter(n > 1 & !OK) %>%    #  & !(Value_diff == 0)
  ungroup() %>%
  arrange(AQUAMONITOR_CODE, TEXT_ID, REPORTED_NAME,Value_temp)


```


#### Run if duplicates  

```{r}

if (FALSE){
  
  xtabs(~TEXT_ID + REPORTED_NAME, check_duplicates) 
  
  # Check one sample   
  # Conclusion: 
  # test <- get_nivabase_data("select * from NIVADATABASE.LABWARE_IMPORT where TEXT_ID = 'NR-2018-09545'")
  # tab <- table(test$REPORTED_NAME)
  # tab[tab > 1]
  
  # View duplicates (i = duplicate number)  
  check_duplicates %>%
    select(TEXT_ID, REPORTED_NAME, FORMATTED_ENTRY) %>%  
    group_by(TEXT_ID, REPORTED_NAME) %>%
    mutate(i = seq_along(TEXT_ID)) %>%
    arrange(TEXT_ID, REPORTED_NAME, i) %>%
    tidyr::pivot_wider(id_cols = c(TEXT_ID, i), names_from = REPORTED_NAME, values_from = FORMATTED_ENTRY)
  
  # Plot all data except duplicates  
  gg <- df_selected %>%
    filter(AQUAMONITOR_CODE %in% c("36A", "36A1") & !TEXT_ID %in% unique(check_duplicates$TEXT_ID) ) %>%
    ggplot(aes(MYEAR)) +
    geom_point(aes(y = Value_temp, color = REPORTED_NAME))
  gg
  gg + facet_wrap(vars(REPORTED_NAME))
  
}


if (nrow(check_duplicates) == 0){
  message("No duplicates in the data")
} else {
  stop("Duplicates in the data - check 'check_duplicates'")
}

```

#### Make datasets  
```{r}

df_SCCP_for_database <- df_selected %>%
  mutate(
    VALUE = case_when(
      FORMATTED_ENTRY == "ND" ~ 0,
      TRUE ~ Value_temp),
    # Just set FLAG1 to be NA, whatever
    FLAG1 = as.character(NA)
  )

# Alternative for FLAG1?
    # FLAG1 = case_when(
    #   FORMATTED_ENTRY == "ND" ~ "<",
    #   TRUE ~ as.character(NA))

df_SCCP_for_analysis <- df_SCCP_for_database %>%
  distinct(AQUAMONITOR_ID, AQUAMONITOR_CODE, MYEAR, TEXT_ID, REPORTED_NAME, VALUE) %>%
  tidyr::pivot_wider(names_from = REPORTED_NAME, values_from = VALUE) %>%
  arrange(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID) %>%
  rename(
    Value_lo = `SCCP eksl. LOQ`,
    Value_up = `SCCP inkl. LOQ`,
  )

```


### MCCP     

#### Prepare, check for duplicates 

```{r}

params <- c("MCCP eksl. LOQ", "MCCP inkl. LOQ")

df_selected <- df_ccp_all %>%
  filter(REPORTED_NAME %in% params & !FORMATTED_ENTRY %in% "T") %>%
  select(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID, MYEAR, SAMPLED_DATE, REPORTED_NAME, FORMATTED_ENTRY, STATUS, STATUSX) %>%
  mutate(Value_temp = as.numeric(sub(',', '.', FORMATTED_ENTRY)))

check <- xtabs(~FORMATTED_ENTRY, df_selected %>% filter(is.na(Value_temp)))

cat("\n")

check2 <- names(check) %in% c("n.r.", "nd", "ND")

if (sum(!check2) == 0){
  message("All FORMATTED_ENTRY are either numeric or some sort of 'ND', as expected")
} else {
  stop("Some not-numeric data are something else than 'ND'! Check table called 'check'.")
}


#
# Remove duplicates - VERY MUCH SPECIALIZED CODE
#

# 09543: keep the numeric value for 'incl.'
#
sel <- with(df_selected, TEXT_ID == "NR-2018-09543" & REPORTED_NAME == "MCCP inkl. LOQ" & FORMATTED_ENTRY == "ND"); sum(sel)
if (sum(sel) == 1)
  df_selected <- df_selected[!sel,]
#
# 09544: keep the numeric value for 'incl.', keep the ND for 'eksl.'  
#
sel <- with(df_selected, TEXT_ID == "NR-2018-09544" & REPORTED_NAME == "MCCP eksl. LOQ" & FORMATTED_ENTRY != "ND"); sum(sel)
if (sum(sel) == 1)
  df_selected <- df_selected[!sel,]
sel <- with(df_selected, TEXT_ID == "NR-2018-09544" & REPORTED_NAME == "MCCP inkl. LOQ" & FORMATTED_ENTRY == "ND"); sum(sel)
if (sum(sel) == 1)
  df_selected <- df_selected[!sel,]
#
# 09544: keep the numeric value for 'incl.', keep the ND for 'eksl.'  
#
sel <- with(df_selected, TEXT_ID == "NR-2018-09545" & REPORTED_NAME == "MCCP eksl. LOQ" & FORMATTED_ENTRY != "ND"); sum(sel)
if (sum(sel) == 1)
  df_selected <- df_selected[!sel,]
sel <- with(df_selected, TEXT_ID == "NR-2018-09545" & REPORTED_NAME == "MCCP inkl. LOQ" & FORMATTED_ENTRY == "ND"); sum(sel)
if (sum(sel) == 1)
  df_selected <- df_selected[!sel,]

#
# Check
#
check_duplicates <- df_selected %>%
  select(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID, REPORTED_NAME, FORMATTED_ENTRY, Value_temp) %>%
  dplyr::group_by(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID, REPORTED_NAME) %>%
  dplyr::mutate(n = dplyr::n(), 
                Value_min = min(Value_temp), Value_max = max(Value_temp),
                N_na = sum(is.na(Value_temp)),
                Value_diff = Value_max - Value_min,
                OK = case_when(
                  N_na > 0 & N_na < n ~ FALSE,  # if one, but not both values are NA 
                  Value_diff > 0 ~ FALSE,       # if values are different
                  TRUE ~ TRUE)) %>%
  dplyr::filter(n > 1 & !OK) %>%    #  & !(Value_diff == 0)
  ungroup() %>%
  arrange(AQUAMONITOR_CODE, TEXT_ID, REPORTED_NAME,Value_temp)


if (nrow(check_duplicates) == 0){
  message("No duplicates in the data")
} else {
  stop("Duplicates in the data - check 'check_duplicates'")
}

```


#### Run if duplicates  

```{r}


if (T){
  
  xtabs(~TEXT_ID + REPORTED_NAME, check_duplicates) 
  
  # Check one sample   
  # Conclusion: 
  # test <- get_nivabase_data("select * from NIVADATABASE.LABWARE_IMPORT where TEXT_ID = 'NR-2018-09545'")
  # tab <- table(test$REPORTED_NAME)
  # tab[tab > 1]
  
  # View duplicates (i = duplicate number)  
  check_duplicates %>%
    select(TEXT_ID, REPORTED_NAME, FORMATTED_ENTRY) %>%  
    group_by(TEXT_ID, REPORTED_NAME) %>%
    mutate(i = seq_along(TEXT_ID)) %>%
    arrange(TEXT_ID, REPORTED_NAME, i) %>%
    tidyr::pivot_wider(id_cols = c(TEXT_ID, i), names_from = REPORTED_NAME, values_from = FORMATTED_ENTRY)
  
  # Plot all data except duplicates  
  gg <- df_selected %>%
    filter(AQUAMONITOR_CODE %in% c("36A", "36A1") & !TEXT_ID %in% unique(check_duplicates$TEXT_ID) ) %>%
    ggplot(aes(MYEAR)) +
    geom_point(aes(y = Value_temp, color = REPORTED_NAME))
  gg
  gg + facet_wrap(vars(REPORTED_NAME))
  
}


```

### Make datasets  

```{r}


df_MCCP_for_database <- df_selected %>%
  mutate(
    VALUE = case_when(
      FORMATTED_ENTRY == "ND" ~ 0,
      TRUE ~ Value_temp),
    # Just set FLAG1 to be NA, whatever
    FLAG1 = as.character(NA)
  )

# Alternative for FLAG1?
    # FLAG1 = case_when(
    #   FORMATTED_ENTRY == "ND" ~ "<",
    #   TRUE ~ as.character(NA))

df_MCCP_for_analysis <- df_MCCP_for_database %>%
  distinct(AQUAMONITOR_ID, AQUAMONITOR_CODE, MYEAR, TEXT_ID, REPORTED_NAME, VALUE) %>%
  tidyr::pivot_wider(names_from = REPORTED_NAME, values_from = VALUE) %>%
  arrange(AQUAMONITOR_ID, AQUAMONITOR_CODE, TEXT_ID) %>%
  rename(
    Value_lo = `MCCP eksl. LOQ`,
    Value_up = `MCCP inkl. LOQ`,
  )


```



## 6. Combined data    

### Combine  

```{r}

df_CCP_for_database <- bind_rows(df_SCCP_for_database, df_MCCP_for_database)

df_CCP_for_analysis <- bind_rows(
  df_SCCP_for_analysis %>% mutate(PARAM = "SCCP"), 
  df_MCCP_for_analysis %>% mutate(PARAM = "MCCP") 
  )

```

### Plot  1

```{r}

df_CCP_for_database %>%
  filter(grepl("SCCP", REPORTED_NAME)) %>%
  ggplot(aes(AQUAMONITOR_CODE, VALUE, color = REPORTED_NAME)) +
  geom_jitter(width = 0.15) +
  ggeasy::easy_rotate_labels(which = "x", angle = -45)

df_CCP_for_database %>%
  filter(grepl("SCCP", REPORTED_NAME) & AQUAMONITOR_CODE %in% c("23B", "53B","30B", "24B")) %>%
  ggplot(aes(MYEAR, VALUE, color = REPORTED_NAME)) +
  geom_jitter(width = 0.15) +
  facet_wrap(vars(AQUAMONITOR_CODE)) +
  scale_y_log10()


```

### Plot 2  

```{r, fig.width=9, fig.height=7}

df_CCP_for_analysis %>%
  filter(AQUAMONITOR_CODE %in% c("23B", "53B","30B", "24B")) %>%
  group_by(AQUAMONITOR_CODE, PARAM, MYEAR) %>%
  summarize(
    Value_lo = mean(Value_lo),
    Value_up = mean(Value_up)
  ) %>%
  ggplot(aes(MYEAR, ymin = Value_lo, ymax = Value_up)) +
  geom_errorbar(width = 0.2) +
  facet_grid(vars(PARAM), vars(AQUAMONITOR_CODE))


```






## 7. Final data  

### Metadata  
```{r}

df_labware_meta <- get_nivabase_selection(
  "*", "LABWARE_CHECK_SAMPLE", "PROSJEKT", projects, values_are_text = TRUE)

df_labware_meta  <- df_labware_meta %>%
  filter(TEXT_ID %in% unique(df_MCCP_for_database$TEXT_ID))

nrow(df_labware_meta) # 5862

df_meta <- df_labware_meta %>%
  distinct(TEXT_ID, SAMPLED_DATE, SPECIES, TISSUE, BIOTA_SAMPLENO)

check <- df_meta %>%
  add_count(TEXT_ID) %>%
  filter(n > 1)

if (nrow(check) > 0){
  stop("TEXT_ID in metadata niot unique")
} else {
  # Add metadata to data
  df_CCP_for_database <- df_CCP_for_database %>%
    left_join(
      df_meta, by = "TEXT_ID"
    ) 
}


```

### Check  
```{r}

xtabs(~SPECIES + TISSUE, df_CCP_for_database)

xtabs(~MYEAR, df_CCP_for_database)

xtabs(~addNA(BIOTA_SAMPLENO), df_CCP_for_database)

```


## 8. Save

```{r}

folder_save <- "Files_to_Jupyterhub_2021/Chlor_paraffins/"

saveRDS(df_CCP_for_database, "Files_to_Jupyterhub_2021/Chlor_paraffins/816_CCP_for_database_2015-2022.rds")
saveRDS(df_CCP_for_analysis, "Files_to_Jupyterhub_2021/Chlor_paraffins/816_CCP_for_analysis_2015-2022.rds")
saveRDS(df_labware_meta, "Files_to_Jupyterhub_2021/Chlor_paraffins/816_CCP_2015-2021_meta.rds")


# writexl::write_xlsx(df_ccp_ready2,
#                     "Files_to_Jupyterhub_2021/Chlor_paraffins/816_CCP_2021.xlsx")
# writexl::write_xlsx(df_labware_meta,
#                     "Files_to_Jupyterhub_2021/Chlor_paraffins/816_CCP_2021_meta.xlsx")
# writexl::write_xlsx(df_ccp,
#                     "Files_to_Jupyterhub_2021/Chlor_paraffins/816_CCP_2021_labware.xlsx")

```

### Read saved data  

```{r}

if (FALSE){
  
  df_CCP_for_database <- readRDS("Files_to_Jupyterhub_2021/Chlor_paraffins/816_CCP_for_database_2015-2022.rds")
  df_CCP_for_analysis <- readRDS("Files_to_Jupyterhub_2021/Chlor_paraffins/816_CCP_for_analysis_2015-2022.rds")

}


```


## 9. For Vannmiljø   

- Not finished - realised this would be too difficult for instance due to 'Provenr'   
```{r}

df_ccp_ready3 <- df_ccp_ready2 %>%
  mutate(
    # ake 'fake' ID_lokal based on station code and sample number
    ID_lokal = paste0("NIVA@BIO$", AQUAMONITOR_CODE, "_", sprintf("%03.0f", BIOTA_SAMPLENO))
  )
# table(df_ccp_ready3$ID_lokal)

# Select data for liver and mussel respectively
df_vm_liver_source <- df_ccp_ready3 %>%
  filter(TISSUE == "LI-Lever")
df_vm_mussel_source <- df_ccp_ready3 %>%
  filter(TISSUE == "SB-Whole soft body")

# We also need sample number  

# Check vannmiljø file  
check_vm <- readxl::read_excel("Files_to_Vannmiljo/2021/NIVA Milkys 2021 - original.xlsx",
                            sheet = "Vannregistreringer")

# Checking  
#
# check_vm %>%
#   filter(Vannlok_kode == "NIVA@46980") %>%
#   xtabs(~Provenr, .)


#
# Tissue: liver
#
# Make first line of finished Vannmiljø file
df_vm_liver_1 <- check_vm %>%
  filter(Parameter_id == "MCCP" & Medium_id == "BL") %>%
  head(1)
# Make file with the number of rows that we need
df_vm_liver <- df_vm_liver_1
for (i in 2:nrow(df_vm_liver_source)){
  df_vm_liver <- bind_rows(df_vm_liver, df_vm_liver_1)
}
# Insert correct values
df_vm_liver$ID_lokal <- df_vm_liver_source$ID
df_vm_liver$Vannlok_kode <- df_vm_liver_source$Kilde_id
df_vm_liver$Parameter_id <- df_vm_liver_source$NAME
df_vm_liver$Operator <- ifelse(is.na(df_vm_liver_source$FLAG1), "", "<")
df_vm_liver$Verdi <- df_vm_liver_source$VALUE


#
# Tissue: mussel
#
# Make first line of finished Vannmiljø file
df_vm_mussel_1 <- check_vm %>%
  filter(Parameter_id == "MCCP" & Medium_id == "BB") %>%
  head(1)
# Make file with the number of rows that we need
df_vm_mussel <- df_vm_mussel_1
for (i in 2:nrow(df_vm_mussel_source)){
  df_vm_mussel <- bind_rows(df_vm_mussel, df_vm_mussel_1)
}

# not finished



```

## APPENDIX: Check Vannmiljø export file     

- Checking that Kilde_id = AQUAMONITOR_ID with 'NIVA@' in front of it  
- As expected, 20B is not found  
- But can easily be created by adding 'NIVA@' in front of AQUAMONITOR_ID  

```{r}

df_vm <- readxl::read_excel("Files_to_Vannmiljo/2020/ooa63pi kvalsjekk 18.01.2022.xlsm", sheet = "LOK")

df_vm_stations <- df_vm %>%
  select(Kilde_id, Navn) %>%
  mutate(AQUAMONITOR_ID = sub('NIVA@', '', Kilde_id, fixed = TRUE) %>% as.numeric())

check1 <- df_ccp_ready1 %>%
  left_join(df_vm_stations, by = "AQUAMONITOR_ID")

check2 <- check1 %>%
  filter(is.na(Kilde_id)) %>%
  count(AQUAMONITOR_ID, AQUAMONITOR_CODE)

check2

```

## APPENDIX 2: Check 'ND' for *all* parameters       

### ND in FORMATTED_ENTRY      
```{r}
sql <- list(
  "select * from NIVADATABASE.LABWARE_IMPORT where FORMATTED_ENTRY like '%ND%' AND TEXT_ID like '%2018%';",
  "select * from NIVADATABASE.LABWARE_IMPORT where FORMATTED_ENTRY like '%ND%' AND TEXT_ID like '%2019%';",
  "select * from NIVADATABASE.LABWARE_IMPORT where FORMATTED_ENTRY like '%ND%' AND TEXT_ID like '%2020%';",
  "select * from NIVADATABASE.LABWARE_IMPORT where FORMATTED_ENTRY like '%ND%' AND TEXT_ID like '%2021%';",
  "select * from NIVADATABASE.LABWARE_IMPORT where FORMATTED_ENTRY like '%ND%' AND TEXT_ID like '%2022%';"
)
names(sql) <- 2018:2022

df_nd <- map_dfr(sql, get_nivabase_data, .id = "Year")

xtabs(~REPORTED_NAME + Year, df_nd)

xtabs(~PROSJEKT + Year, df_nd)

```

### T in FORMATTED_ENTRY      

* Is used for a large number of parameters and projects  
* Also for single BDEs (e.g. BDE99) in seals in Urban Fjord 2022  

```{r}

sql <- list(
  "select * from NIVADATABASE.LABWARE_IMPORT where FORMATTED_ENTRY like '%T%' AND TEXT_ID like '%2018%';",
  "select * from NIVADATABASE.LABWARE_IMPORT where FORMATTED_ENTRY like '%T%' AND TEXT_ID like '%2019%';",
  "select * from NIVADATABASE.LABWARE_IMPORT where FORMATTED_ENTRY like '%T%' AND TEXT_ID like '%2020%';",
  "select * from NIVADATABASE.LABWARE_IMPORT where FORMATTED_ENTRY like '%T%' AND TEXT_ID like '%2021%';",
  "select * from NIVADATABASE.LABWARE_IMPORT where FORMATTED_ENTRY like '%T%' AND TEXT_ID like '%2022%';"
)
names(sql) <- 2018:2022

df_t <- map_dfr(sql, get_nivabase_data, .id = "Year")

xtabs(~REPORTED_NAME + Year, df_t)

# xtabs(~PROSJEKT + Year, df_t)
xtabs(~PROSJEKT, df_t)

```

```{r}

# select * from NIVADATABASE.LABWARE_IMPORT where FORMATTED_ENTRY like '%ND%' AND TEXT_ID like '%2022%
# 
# "SELECT * FROM nivadatabase.labware_import WHERE formatted_entry LIKE '%ND%' AND text_id LIKE '%2022% AND REPORTED_NAME = 'BDE99' AND  "

test <- get_nivabase_data(paste(
  "select * from NIVADATABASE.LABWARE_IMPORT where PROSJEKT = 'O 19330;ANA19 - MILKYS2019'",
  "and extract(year from SAMPLED_DATE) = 2019",
  "and AQUAMONITOR_CODE in '36B'",
  "and REPORTED_NAME = 'BDE99';"))


```

### Check BDE99 (as an example)  

* T 

```{r}

cat("BDE99 with 't', by project: \n")
df_t %>%
  filter(REPORTED_NAME == "BDE99") %>% 
  xtabs(~PROSJEKT + Year, .)  
cat("\n")

cat("BDE99 with 't', by stations within Milkys 2019: \n")
df_t %>%
  filter(REPORTED_NAME == "BDE99" & PROSJEKT == 'O 19330;ANA19 - MILKYS2019') %>% 
  xtabs(~AQUAMONITOR_CODE, .)  
cat("\n")

# Get data from LIMS/Labware  
df_labw <- get_nivabase_data(paste(
  "select * from NIVADATABASE.LABWARE_IMPORT where PROSJEKT = 'O 19330;ANA19 - MILKYS2019'",
  "and extract(year from SAMPLED_DATE) = 2019",
  # "and AQUAMONITOR_CODE in ('36B', '13B', '80B')",
  "and REPORTED_NAME = 'BDE99';"))

# tab1 = LABWARE

tab1 <- table(df_labw$AQUAMONITOR_CODE)
  
# tab2 = NIvadatabase

# Get data up until 2021  
dat_compl <- readRDS("Files_from_Jupyterhub_2021/Raw_data/101_data_updated_2022-09-01.rds")

tab2 <- dat_compl %>%
  filter(PARAM == "BDE99" & MYEAR == 2019) %>%
  xtabs(~STATION_CODE, .)

# The first two ('36B', '13B') has one 'T' observation 
tab1_sample <- tab1[c('36B', '13B', '80B', '19B', '24B')]
tab2_sample <- tab2[c('36B', '13B', '80B', '19B', '24B')]

cat("Records by station (sample), Labware (): \n")
tab1_sample
cat("\n")

cat("Records by station (sample), Nivabase: \n")
tab2_sample
cat("\n")

cat("Difference (the first two, '36B' and '13B', has one 'T' observation): \n")
tab1_sample - tab2_sample

df_labw %>% 
  filter(AQUAMONITOR_CODE %in% '36B') %>%
  select(REPORTED_NAME, DESCRIPTION, ENTRY_QUALIFIER:NUMERIC_ENTRY) %>%
  knitr::kable()

# Example
if (FALSE){
  df_labw %>% filter(AQUAMONITOR_CODE %in% '30B') %>% select(REPORTED_NAME, DESCRIPTION, ENTRY_QUALIFIER:NUMERIC_ENTRY)
}

# For SQL Developer:
# SELECT * FROM nivadatabase.labware_import WHERE prosjekt = 'O 19330;ANA19 - MILKYS2019'
# AND EXTRACT(YEAR FROM sampled_date) = 2019
# AND aquamonitor_code IN '36B'
# AND reported_name = 'BDE99';



```

