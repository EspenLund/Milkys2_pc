---
title: "866_Test_Tukey_Kramer"
author: "DHJ"
date: "30 9 2021"
output: html_document
---


## 1. Libraries etc

### Libraries
```{r}

library(dplyr)
library(ggplot2)
library(tidyr)

# library(ggpubr)       # doesn't have multiple comparison tests
# library(ggstatsplot)  # doesn't have Tukey multiple comparison test

# install.packages("agricolae")
library(agricolae)

```

### Year  
```{r}

selected_year <- 2020

```

## 2. Data   

### Read 
```{r}

dat <- readRDS("Files_from_Jupyterhub_2020/Raw_data/109_adjusted_data_2021-09-15.rds")

# For coordinates   
dat_stations <- readxl::read_excel("Files_to_Jupyterhub_2019/Kartbase_edit.xlsx")

# dat_bigexcel <- readRDS("Files_from_Jupyterhub_2020/Big_excel_table/Data_xl_2021-09-15_ver02.rds")

```

### Join to stations  
```{r}

dat2 <- dat %>%
    filter(VALUE_WW > 0.1) %>%
    left_join(dat_stations, by = "STATION_CODE") %>%
    mutate(
        Matrix = paste0(LATIN_NAME, ", ", TISSUE_NAME),
        log_Conc = log10(VALUE_WW + 0.1),
        Station = paste(STATION_CODE, substr(STATION_NAME, 1, 15)),
        LOQ = ifelse(is.na(FLAG1), "Over LOQ", "Under LOQ")
    ) %>%
    filter(!is.na(log_Conc))


```

### Matrices and years  
```{r}

matrices <- dat2 %>%
    filter(MYEAR == 2020) %>%
    count(Matrix) %>%
    arrange(desc(n)) %>%
    pull(Matrix)

years <- sort(unique(dat2$MYEAR))

```

### Parameters  
```{r}


# param_meta$Substance.Group %>% unique() %>% dput()

group_seq <- c("Metals and metalloids", "Chlorobiphenyls", 
  "Polycyclic aromatic hydrocarbons (PAHs)", 
  "Organobromines", 
  "Dichloro-diphenyl-trichloroethane (DDTs)", "Organochlorines (general)",
  "Chlorinated paraffins", "Organofluorines", "Phenols/chlorophenols", 
  "Organo-metallic compounds", 
  "Chlorinated flame retardants",
  "Biological effects: molecular/biochemical/cellular/assays", 
  "Organic esters", "Isotopes",  
  "Cyclodienes", "Dioxins", "Biomarkers", "Phthalates", 
  "Phosphorus flame retardant (PFR)", "Major inorganic constituents", 
  "Support parameters", "Hexachlorocyclohexanes", "Triazines", 
  "Siloxanes", 
  ""
)

param_meta <- read.csv2("Files_to_Jupyterhub_2019/Lookup for big excel - param.csv") %>%
  select(Parameter.Code, Substance.Group) %>%
  mutate(Substance.Group = factor(Substance.Group, levels = group_seq))

parameters <- dat2 %>%
    filter(MYEAR == 2020) %>%
    distinct(PARAM) %>%
    left_join(param_meta, by = c("PARAM" = "Parameter.Code")) %>%
    arrange(Substance.Group, PARAM) %>%
    pull(PARAM)



```

## 3. Plots  

### Plot single observations  

```{r, fig.width=9, fig.height=6}}

year <- 2020

dat_select <- dat2 %>%
  filter(PARAM %in% "HG" & TISSUE_NAME %in% "Muskel" & MYEAR == year)

ggplot(dat_select, aes(Station, log_Conc)) +
  geom_jitter(color = "red", width = 0.1, height = 0) +
  # geom_violin() +
  theme(axis.text.x = element_text(angle = -45, hjust = 0))

#?plot.group
# ?barplot

```

### ANOVA and default Tukey-Kramer plot  
```{r, fig.width=9, fig.height=5}

model <- aov(log_Conc ~ Station, data = dat_select)
multcomp <-  HSD.test(model, "Station", alpha = )
# plot(multcomp)
# plot(multcomp, horiz=TRUE, variation="SD", las=1)
par(mfrow=c(1,1), mar=c(3,10,2,3))
plot(multcomp, horiz=TRUE, las = 1, cex.names = 0.8, xlim = c(-1,0))

```

## 4. Tukey-Kramer plot  
- Get letters from 'multcomp'  
```{r}

# str(multcomp)

df_summ <- multcomp$means %>%
  mutate(Station = rownames(multcomp$means)
  ) 

# For plotting
df_groups <- data.frame(
  Station = rownames(multcomp$groups),
  Station_group = multcomp$groups$groups) %>%
  left_join(df_summ, by = "Station") %>%
  rename(
    Mean = log_Conc,
    Median = Q50)

# For plotting mean and median
df_groups2 <- df_groups %>%
  select(Station, Mean, Median) %>%
  tidyr::pivot_longer(-Station, names_to = "Type", values_to = "Value")

ggplot(df_groups2, aes(Station)) +
  geom_linerange(data = df_groups, aes(ymin = Min, ymax = Max)) +
  geom_linerange(data = df_groups, aes(ymin = Q25, ymax = Q75), size = 1.25) +
  geom_point(aes(y = Value, shape = Type), color = "white", fill = "red2", size = 2.5) +
  scale_shape_manual(values = c(22, 23)) +
  geom_text(data = df_groups, 
            aes(
              y = Max + diff(range(dat_select$log_Conc))*0.07, 
              label = Station_group,
              color = Station_group)) +
  theme(axis.text.x = element_text(angle = -45, hjust = 0)) +
  labs(y = "log10(Concentration + 0.1)")

```

## 5. ANOVA summary and assumptions

### Summary 
```{r}

summary(model)

```

### Homogeneity of variances   

- Bartlett Test of Homogeneity of Variances (parametric)  
- Figner-Killeen Test of Homogeneity of Variances (non-parametric)
- Graphic test of homogeneity of variances based on Brown-Forsyth   
```{r, results='hold'}

# Add count per station  
dat_select <- dat_select %>%
  add_count(Station)

# Bartlett Test of Homogeneity of Variances (parametric)
bartlett.test(log_Conc ~ Station, data = dat_select %>% filter(n >= 2))

# Figner-Killeen Test of Homogeneity of Variances (non-parametric)
fligner.test(log_Conc ~ Station, data = dat_select %>% filter(n >= 2))

# Homogeneity of Variance Plot
# install.packages("HH")
library(HH)
hov(log_Conc ~ Station, 
    data = dat_select %>% filter(n >= 2) %>% mutate(Station = factor(Station)))
hovPlot(log_Conc ~ Station,  
    data = dat_select %>% filter(n >= 2) %>% mutate(Station = factor(Station)))

```

### Robust types of ANOVA     
- Kruskal-Wallis test (non-parametric)
```{r}

# install.packages("onewaytests")
library(onewaytests)

kw_result <- kw.test(log_Conc ~ Station, data = dat_select %>% filter(n >= 2))
# pair_results <- paircomp(kw_result, adjust.method = "bonferroni", )  
# table(pair_results$`  No difference`)
# pair_results[pair_results$`  No difference`  == "Reject",]
 
welch.test(log_Conc ~ Station, data = dat_select %>% filter(n >= 2))



```

### Dunnett's Modified Tukey-Kramer Pairwise Multiple Comparison Test  

- Conducts a pairwise multiple comparison test (using the C procedure) for mean differences with unequal sample sizes and no assumption of equal population variances. 

- Produces slightly wider (i.e. more conservative) confidence intervals than the Tukey-Kramer procedure

```{r}

# install.packages("DTK")
library(DTK)
# Dunnett's Modified Tukey-Kramer Pairwise Multiple Comparison Test
# Conducts a pairwise multiple comparison test (using the C procedure) for mean differences with unequal sample sizes and no assumption of equal population variances. 
# produces slightly wider (i.e. more conservative) confidence intervals than the Tukey-Kramer procedure

table(factor(subset(dat_select, n >= 2)$Station))

n_minimum <- 4
DTK.result <- DTK.test(
  x = subset(dat_select, n >= n_minimum)$log_Conc,
  f = factor(subset(dat_select, n >= n_minimum)$Station), 
  a = 0.05)
DTK.result
# DTK.plot(DTK.result)

```


