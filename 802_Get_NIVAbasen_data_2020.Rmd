---
title: "802 Get chemical data from NIVAbasen"
output: html_document
---

## Libraries
```{r setup, include=FALSE}
# install.packages("niRvana")
library(dplyr)
library(ggplot2)
library(lubridate)

# And then the niRvana package. If you need to install it, then run thee next line also:
# devtools::install_github("NIVANorge/niRvana")
library(niRvana)

source("802_Get_NIVAbasen_data_functions.R")

```


## Modify niRvana functions  

### New version of get_nivabase_data   
- until we have fixed in in niRvana package   
    - issue 1: add encoding when creating connection https://github.com/NIVANorge/niRvana/issues/9)   
    - issue 2: switch to using 64-bit!

1) Add encoding to 'get_nivabase_data' function    
```{r}

# The old solution for 32-bit Oracle server
get_nivabase_data_SOCKETSERVER <- function (sql = NULL, source = "NIVABASE") {
  library(svSocket)
  sock_port <- 8642L
  sock_con <- "sv_con"
  dataframe_temporary <<- data.frame()
  table_out <- "dataframe_temporary"
  pwd <- unserialize(sodium::simple_decrypt(db_pwd, db_privkey))
  startSocketServer(port = sock_port, server.name = "oracle_query_32", 
                    local = TRUE)
  expr <- "library(svSocket)"
  expr <- c(expr, sprintf("con <- DBI::dbConnect(odbc::odbc(), '%3$s', UID='%1$s', PWD='%2$s', encoding = 'ISO-8859-1')", 
                          db_username, pwd, source))
  expr <- c(expr, sprintf("%1$s <- DBI::dbGetQuery(con, \"%2$s\")", 
                          table_out, sql))
  expr <- c(expr, sprintf("%s <- socketConnection(port=%i)", 
                          sock_con, sock_port))
  expr <- c(expr, sprintf("evalServer(%s, %s, %s)", sock_con, 
                          table_out, table_out))
  expr <- c(expr, sprintf("close(%s)", sock_con))
  expr <- paste(expr, collapse = ";")
  prog <- file.path(R.home(), "bin", "i386", "Rscript.exe")
  system2(prog, args = c("-e", shQuote(expr)), stdout = NULL, 
          wait = TRUE, invisible = TRUE)
  stopSocketServer(port = sock_port)
  fact2char_df(dataframe_temporary)
}


# New solution, assumes you have 64-bit Oracle server installed  
# Software Center -> "Oracle Client19x64 installer"   
get_nivabase_data <- function (sql = NULL, source = "NIVABASE") {
  pwd <- unserialize(sodium::simple_decrypt(db_pwd, db_privkey))
  con <- DBI::dbConnect(odbc::odbc(), source, UID = db_username, PWD = pwd, encoding = 'ISO-8859-1')   
  dataframe_temporary <- DBI::dbGetQuery(con, sql)
  DBI::dbDisconnect(con)
  fact2char_df(dataframe_temporary)
}

```

```{r}

# Version without testing
set_credentials <- function (test = TRUE){
  passphrase <- "My passphrase"
  db_username <<- svDialogs::dlg_input("Please write your username (capital letters)", 
                                       Sys.info()["user"])$res
  db_privkey <<- sodium::keygen()
  db_pubkey <<- sodium::pubkey(db_privkey)
  db_pwd <<- sodium::simple_encrypt(serialize(getPass::getPass(paste0("Please write the password for user ", 
                                                                      db_username, ": ")), NULL), db_pubkey)
  if (test){
    x <- try(get_nivabase_data("select * from NIVADATABASE.STATION_TYPES where rownum = 1"))
    if (class(x) %in% "data.frame") {
      cat("Username/password successfully set for the rest of this R session\n")
    }
    else {
      cat("====================================================================================================\n")
      cat("Username/password is not correct. Please try again. The password may differ from your NIVA password\n")
      cat("====================================================================================================\n")
    }
  } else {
    cat("Username/password set for the rest of this R session (not tested)\n")
  }
  invisible(NULL)
}

# set_credentials(test = FALSE)
# set_credentials(test = TRUE)


```
### New version of 'get_samples_from_sampleid'  
- does not get data from NIVADATABASE.SPECIES (which has been deleted)  
```{r}

get_samples_from_sampleid <- function (sample_id, add_species_and_tissue = TRUE, report = FALSE) {
    df <- get_nivabase_selection("*", "BIOTA_SAMPLES", 
        "SAMPLE_ID", sample_id)
    if (add_species_and_tissue) {
        df_tissue <- get_nivabase_data("select TISSUE_ID,TISSUE_NAME from NIVADATABASE.BIOTA_TISSUE_TYPES")
        # DOESN'T EXIST ANYMORE:
        # df_species <- get_nivabase_data("select SPECIES_ID,LATIN_NAME from NIVADATABASE.SPECIES")
        df <- merge(df, df_tissue, by = "TISSUE_ID", all.x = TRUE, 
            all.y = FALSE)
    }
    df <- dplyr::rename(df, REMARK_sample = REMARK)
    if (report) {
        n <- sum(is.na(df$TISSUE_ID))
        p <- round(mean(is.na(df$TISSUE_ID)) * 100, 1)
        cat("TISSUE_ID lacking for", n, "cases, i.e.", 
            p, "percent\n")
        n <- sum(!is.na(df$TISSUE_ID) & is.na(df$TISSUE_NAME))
        p <- round(mean(!is.na(df$TISSUE_ID) & is.na(df$TISSUE_NAME)) * 
            100, 1)
        cat("TISSUE_NAME lacking for additional", n, "cases, i.e.", 
            p, "percent\n")
    }
    df
}

```

## Get new(er) data

### Give your username and password to R (only once per R session):
```{r}
set_credentials()
```

### Get the list of projects
```{r}
df_projects <- get_projects()   # we call it 'df_projects' (the default name used by 'get_stations_from_project')
```

### Get a list of the stations in the CEMP_Biota project
```{r}
df_stations <- get_stations_from_project("CEMP_Biota", ignore.case = FALSE)
```

### Get all specimens collected at these stations (20 seconds or so)
```{r}
df_specimens <- get_specimens_from_stationdata(df_stations)
```

### Get species  
```{r}

taxoncode_id <- unique(df_specimens$TAXONOMY_CODE_ID)

df_species <- get_nivabase_data(paste(
  "select a.TAXONOMY_CODE_ID, b.LATIN_NAME",
  "from NIVADATABASE.TAXONOMY_CODES a LEFT JOIN NIVADATABASE.TAXONOMY b ON a.NIVA_TAXON_ID = b.NIVA_TAXON_ID",
  "where TAXONOMY_CODE_ID in",
  "(", paste(taxoncode_id, collapse=","), ");"
))


```

### Plot sample dates   
```{r, fig.height=6, fig.width=7}

df_specimens %>%
  left_join(df_species, by = "TAXONOMY_CODE_ID") %>%
  filter(year(DATE_CAUGHT) >= 2020) %>%
  ggplot(aes(DATE_CAUGHT)) +
  geom_histogram(binwidth = 3600*24*10) +   # 10 days
  scale_x_datetime(date_breaks = "1 month", date_labels = "%m %Y") +
  facet_wrap(vars(LATIN_NAME), ncol = 1, scales = "free_y")

```



## Get the data itself  
Get data frame of chemical data for all samples from the measurement year 2016 (30 seconds or so)
```{r, results = FALSE}

# debugonce(get_biota_chemistry)
# debugonce(get_samples_from_sampleid)

df_2020_temp <- get_biota_chemistry(
  years = 2020:2021,              # in case some specimens wrongly  
                                  #    have date_caught = 2020
  specimendata = df_specimens, 
  stationdata = df_stations,
  report_samples = TRUE)

df_2020 <- df_2020_temp %>%
  left_join(df_species, by = "TAXONOMY_CODE_ID")

```

### Check species  
```{r}

table(addNA(df_2020$LATIN_NAME))

```


### Save 
```{r}
#
# 2020 data
#
# dir.create("Files_to_Jupyterhub_2020")

# Make timestamp (date stamp actually)
t <- Sys.time()
timestamp <- substr(t, 1, 10)
filename <- paste0("Files_to_Jupyterhub_2020/01_df_2020_notstandard_", timestamp, ".rds")

# Set to TRUE/FALSE depending on whether file should be saved or not  
if (FALSE){

  saveRDS(df_2020, file = filename)
  cat("2020 data saved as rds,", sQuote(filename), "\n")
  filename_txt <- sub("rds", "csv", filename)
  write.csv(df_2020, file = filename_txt, fileEncoding = "UTF-8")
  cat("2020 data saved as csv,", sQuote(filename_txt), "\n")

}

# Set to TRUE/FALSE depending on whether file should be read or not  
if (FALSE){
  # df_2020 <- readRDS(filename)
  df_2020 <- readRDS("Files_to_Jupyterhub_2020/01_df_2020_notstandard_2021-09-30.rds")
}

```


