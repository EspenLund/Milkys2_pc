---
title: "Report for parameter group"
author: "DHJ"
date: "22 6 2022"
params:
  chemical_group: "metals"
output: 
  html_document:
    keep_md: false
    toc: true
    toc_float: true
---

```{r, echo = FALSE}

knitr::opts_chunk$set(echo = FALSE, results = 'hold')
# knitr::opts_chunk(results = 'hold')

```


```{r}

current_year <- 2021

```


```{r packages, results='hide', message=FALSE, warning=FALSE}

library(dplyr)
# library(tidyr)
library(ggplot2)
library(lubridate)
library(flextable)
# library(glue)
library(readxl)
library(purrr)
library(leftcensored)   # DHJ's package (https://github.com/DagHjermann/leftcensored)
library(scico)          # colour palettes incl. "Vik" (https://github.com/thomasp85/scico)

library(ggiraph)
library(cowplot)

# library(safejoin) # https://github.com/moodymudskipper/safejoin

# source("01_Get_chemical_data_NIVAbasen_functions.R")  # for get_standard_parametername()
source("824_Report_for_scientists_functions.R")
source("825_Report_paramgroup_functions.R", encoding = "UTF-8")

```



```{r get_data, warning=FALSE}

chem_params <- get_parametervalues(params$chemical_group)

# debugonce(get_data_tables)
dat_sample_fish <- get_data(params$chemical_group, "fish")
dat_sample_muss <- get_data(params$chemical_group, "mussel")

dat_median <- get_medians(dat_sample_fish, dat_sample_muss)

dat_median_fish <- dat_median %>%
  filter(LATIN_NAME %in% c("Gadus morhua", "Platichthys flesus"))
dat_median_mussel <- dat_median %>%
  filter(LATIN_NAME %in% c("Mytilus edulis"))


```


## Medians last year  

### Fish  

```{r,  fig.height=6, fig.width=11}

pargroup_median_table(dat_median_fish, fill = "Proref_ratio_WW", year = 2021)

```


### Blue mussel  

```{r,  fig.height=6, fig.width=11}

pargroup_median_table(dat_median_mussel, fill = "Proref_ratio_WW", year = 2021)

```


## Ratio to proref in last year       

### Fish  
* Note: 
    - Concentrations given in tooltip (should do something for the < values for minimum values)   
* To improve  
    - To avoid "random" overlap, use geom_dotplot instead? (with small binwidth)
```{r, fig.height=6, fig.width=11, warning=FALSE}

pargroup_boxplot(dat_median_fish, y = "Proref_ratio_WW", year = current_year,
              ylabel = "Ratio conc. w.w. / proref",
              main_title = paste0("Ratio concentration/proref, metals in fish ", current_year))

```




### Mussel    
```{r, fig.height=6, fig.width=11, warning=FALSE}

pargroup_boxplot(dat_median_mussel, y = "Proref_ratio_WW", year = current_year,
              ylabel = "Ratio conc. w.w. / proref",
              main_title = paste0("Ratio concentration/proref, metals in mussel ", current_year))

```



## Ratio to EQS in last year       

### Fish  
* Note: 
    - Concentrations given in tooltip (should do something for the < values for minimum values)   
```{r, fig.height=6, fig.width=11, warning=FALSE}

pargroup_boxplot(dat_median_fish, y = "EQS_ratio_WW", year = current_year,
              ylabel = "Ratio conc. w.w. / EQS",
              main_title = paste0("Ratio concentration/EQS, metals in fish ", current_year))

```
### Blue mussels  
* Note: 
    - Concentrations given in tooltip (should do something for the < values for minimum values)   
```{r, fig.height=6, fig.width=11, warning=FALSE}

pargroup_boxplot(dat_median_mussel, y = "EQS_ratio_WW", year = current_year,
              ylabel = "Ratio conc. w.w. / EQS",
              main_title = paste0("Ratio concentration/EQS, metals in mussel ", current_year))

```

## Fish, time series {.tabset}

### CD   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("CD", dat_median_fish, fill = "Proref_ratio_WW", width_svg = 8)

```


### HG   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("HG", dat_median_fish, fill = "Proref_ratio_WW", width_svg = 8)

```


### PB   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("PB", dat_median_fish, fill = "Proref_ratio_WW", width_svg = 8)

```




### AG   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("AG", dat_median_fish, fill = "Proref_ratio_WW", width_svg = 8)

```

### AS   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("AS", dat_median_fish, fill = "Proref_ratio_WW", width_svg = 8)

```

### CR   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("CR", dat_median_fish, fill = "Proref_ratio_WW", width_svg = 8)

```

### CU   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("CU", dat_median_fish, fill = "Proref_ratio_WW", width_svg = 8)

```

### NI   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("NI", dat_median_fish, fill = "Proref_ratio_WW", width_svg = 8)

```

### SN   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("SN", dat_median_fish, fill = "Proref_ratio_WW", width_svg = 8)

```

### ZN   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("ZN", dat_median_fish, fill = "Proref_ratio_WW", width_svg = 8)

```


## Blue mussel, time series {.tabset}

### CD   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("CD", dat_median_mussel, fill = "Proref_ratio_WW", width_svg = 8)

```


### HG   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("HG", dat_median_mussel, fill = "Proref_ratio_WW", width_svg = 8)

```


### PB   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("PB", dat_median_mussel, fill = "Proref_ratio_WW", width_svg = 8)

```




### AG   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("AG", dat_median_mussel, fill = "Proref_ratio_WW", width_svg = 8)

```

### AS   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("AS", dat_median_mussel, fill = "Proref_ratio_WW", width_svg = 8)

```

### CR   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("CR", dat_median_mussel, fill = "Proref_ratio_WW", width_svg = 8)

```

### CU   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("CU", dat_median_mussel, fill = "Proref_ratio_WW", width_svg = 8)

```

### NI   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("NI", dat_median_mussel, fill = "Proref_ratio_WW", width_svg = 8)

```

### SN   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("SN", dat_median_mussel, fill = "Proref_ratio_WW", width_svg = 8)

```

### ZN   

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("ZN", dat_median_mussel, fill = "Proref_ratio_WW", width_svg = 8)

```



## EQS ratio over time {.tabset}     

### HG, fish    

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("HG", dat_median_fish, fill = "EQS_ratio_WW", width_svg = 8)

```

### HG, mussel    

```{r, fig.height=6, fig.width=11, warning=FALSE}

parameter_median_table("HG", dat_median_mussel, fill = "EQS_ratio_WW", width_svg = 8)

```





