---
title: "802 Get chemical data from NIVAbasen"
output: html_document
---

## Libraries
```{r setup, include=FALSE}
# install.packages("niRvana")

library(dplyr)
library(ggplot2)
library(lubridate)

# And then the niRvana package. 

# Install directly - need to add password etc, so this dosn't work:
# devtools::install_github("NIVANorge/niRvana")

# For now:
# 1) Go to https://github.com/NIVANorge/niRvana
# 2) "Code" button -> download zip -> save file to own PC - > unzip it    
# 3) use devtools::install("path to package folder") to install the package  s
library(niRvana)  

source("802_Get_NIVAbasen_data_functions.R")

```


## Settings  
```{r}

measurement_year <- 2022

```


## Get new(er) data

### Give your username and password to R (only once per R session)  
* Not necessary if you have set your Nivabasen username/password using the 'keyring' package 
```{r}
# set_credentials()
```

### Get the list of projects

```{r}

df_projects <- get_projects()   # we call it 'df_projects' (the default name used by 'get_stations_from_project')

```

### Get a list of the stations in the CEMP_Biota project

```{r}

df_stations <- get_stations_from_project("CEMP_Biota", ignore.case = FALSE)

```

### Get all specimens collected at these stations (20 seconds or so)  

- Includes LATIN_NAME  
- Also include the year after, as some daa may be collected in January february next yra

```{r}

df_specimens <- get_specimens_from_stationdata(df_stations, years = measurement_year + 0:1)

df_specimens_sel <- df_specimens %>%
  filter(
    (year(DATE_CAUGHT) %in% measurement_year & month(DATE_CAUGHT) >= 3) |
      (year(DATE_CAUGHT) %in% (measurement_year+1) & month(DATE_CAUGHT) <= 2)
    )

```

### Plot sample dates in measurement_year (or the year after)    

```{r, fig.height=6, fig.width=7}

ggplot(df_specimens_sel, aes(DATE_CAUGHT)) +
  geom_histogram(binwidth = 3600*24*10) +   # 10 days
  scale_x_datetime(date_breaks = "1 month", date_labels = "%m %Y") +
  facet_wrap(vars(LATIN_NAME), ncol = 1, scales = "free_y")

```



## Get the data itself  
Get data frame of chemical data for all samples from the measurement year 2016 (30 seconds or so)  
- LATIN_NAME is included  
```{r, results = FALSE}

# debugonce(get_biota_chemistry)
# debugonce(get_samples_from_sampleid)

df_chemdata <- get_biota_chemistry(
  years = measurement_year + 0:1,              # in case some specimens wrongly  
                                               #    have date_caught in the year after
  specimendata = df_specimens_sel,             # specimens are already form the correct time period only
  stationdata = df_stations,
  report_samples = TRUE)

```

#### Plot (for example parameters)  

```{r, fig.height=8, fig.width=5}  

# table(df_chemdata$NAME)
# table(df_chemdata$NAME) %>% names() %>% dput()  

pars <- c("ALAD", "Aldrin", "BDE49", "Benzo[a]pyren", "EROD", "Fettinnhold", 
  "Kadmium", "p,p'-DDE", "PCB 118", "Perfluoroktansulfonamid (PFOSA)", 
  "SCCP eksl. LOQ", "Toksafen Parlar 26", "Tørrstoff %", "Tributyltinn (TBT)")

df_chemdata %>%
  filter(NAME %in% pars) %>%
  count(STATION_CODE, NAME) %>%
  # ggplot(aes(STATION_CODE, NAME)) +
  ggplot(aes(NAME, STATION_CODE)) +
  geom_tile(aes(fill = n)) +
  scale_fill_viridis_c() +
  ggeasy::easy_rotate_x_labels(-45)


```


### Save 
```{r}
#
# Do this ONCE:
# dir.create("Files_to_Jupyterhub_2021")

# Make timestamp (date stamp actually)
t <- Sys.time()
timestamp <- substr(t, 1, 10)
folder <- paste0("Files_to_Jupyterhub_", measurement_year)
filename_only <- paste0("01_df_", measurement_year, "_notstandard_", timestamp, ".rds")
filename <- paste0(folder, "/", filename_only)
filename

# Set to TRUE/FALSE depending on whether file should be saved or not  
if (FALSE){

  saveRDS(df_chemdata, file = filename)
  cat(measurement_year, "data saved as rds,", sQuote(filename), "\n")
  filename_txt <- sub("rds", "csv", filename)
  write.csv(df_chemdata, file = filename_txt, fileEncoding = "UTF-8")
  cat(measurement_year, "data saved as csv,", sQuote(filename_txt), "\n")

}

# Set to TRUE/FALSE depending on whether file should be read or not  
if (FALSE){
  # df_chemdata <- readRDS(filename)
  files <- dir(folder) %>% rev()
  files
  filename_only <- files[1]    # 1 = latest data   
  filename <- paste0(folder, "/", filename_only)
  df_chemdata <- readRDS(filename)
}

```


## APPENDIX 1

```{r}

# For app 804

if (FALSE){
  
  
  df_2020 <- readRDS("Files_from_Jupyterhub_2020/Raw_data/109_adjusted_data_2021-09-15.rds")
  
  names(df_2021)
  names(df_2020)
  
  df_2021_test <- bind_rows(
    df_2020,
    df_2021 %>%
      mutate(MYEAR = lubridate::year(SAMPLE_DATE),
             VALUE_WW = VALUE)
  )
  
  saveRDS(df_2021_test, "Files_from_Jupyterhub_2020/Raw_data/802_testdata_2022-05-23.rds")
  
  
}

```


## APPENDIX 2 - get Labware data for gall metabolites       

### Check 1

```{r}

# One project, one sample   
test <- get_nivabase_data(
  "select * from NIVADATABASE.LABWARE_IMPORT where PROSJEKT = 'O 210200.ANAIN' and DESCRIPTION = '30B Inner Oslofjord - Torsk galle 1'")
test <- get_nivabase_data(
  "select * from NIVADATABASE.LABWARE_IMPORT where PROSJEKT = 'O 210200.ANAIN' and DESCRIPTION like '53B%'")

```

### Check 2  

```{r}

# All Sørfjorden samples  
test1 <- get_nivabase_data(
  "select * from NIVADATABASE.LABWARE_CHECK_SAMPLE where PROSJEKT = 'O 210200.ANAIN' and DESCRIPTION like '%53B%'")  
xtabs(~addNA(SAMPLED_DATE) + TISSUE, test1)

# All Sørfjorden measurements    
test2 <- get_nivabase_data(
  "select * from NIVADATABASE.LABWARE_IMPORT where PROSJEKT = 'O 210200.ANAIN' and DESCRIPTION like '%53B%'")  
# xtabs(~DESCRIPTION, test2)
xtabs(~DESCRIPTION + addNA(year(SAMPLED_DATE)), test2 %>% filter(grepl("galle", DESCRIPTION, ignore.case = TRUE)))
xtabs(~is.na(NUMERIC_ENTRY) + addNA(year(SAMPLED_DATE)), test2 %>% filter(grepl("galle", DESCRIPTION, ignore.case = TRUE)))

write.csv(test2, "clipboard-4096")
writexl::write_xlsx(test2, "C:/Data/Temp/Milkys_2021-22_Labware_53B.xlsx")

if (FALSE){
  test2 %>% 
    filter(grepl("galle", DESCRIPTION, ignore.case = TRUE),
           is.na(SAMPLED_DATE)) %>% View()
}



```

### Also check Bømlo and Indre Oslofjord   

```{r}

test2 <- get_nivabase_data(
  "select * from NIVADATABASE.LABWARE_IMPORT where PROSJEKT = 'O 210200.ANAIN' and DESCRIPTION like '%23B%'")  
xtabs(~is.na(NUMERIC_ENTRY) + addNA(year(SAMPLED_DATE)), test2 %>% filter(grepl("galle", DESCRIPTION, ignore.case = TRUE)))

test2 <- get_nivabase_data(
  "select * from NIVADATABASE.LABWARE_IMPORT where PROSJEKT = 'O 210200.ANAIN' and DESCRIPTION like '%30B%'")  
xtabs(~is.na(NUMERIC_ENTRY) + addNA(year(SAMPLED_DATE)), test2 %>% filter(grepl("galle", DESCRIPTION, ignore.case = TRUE)))


```




