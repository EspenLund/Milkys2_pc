---
title: "814 - Import cod siloxan data from NILU to Nivabasen, 2020"
author: "DHJ"
date: "2 9 2019"
output: 
  html_document:
    keep_md: true
---

Make tables for inserting into NIVAbase   
  
For eider duck and cod (siloxans only) data from NILU  


## 0. Libraries and functions
```{r}

library(dplyr)
library(purrr)
library(lubridate)
library(stringr)
library(tidyr)
library(ggplot2)
library(niRvana)
library(safejoin)   # https://github.com/moodymudskipper/safejoin

source("812_Import_til_NIVAbasen_NILU_functions.R")

# "Restart" for lazy people that don't want to write the 
#    database password again (deletes all objects except database password/username)
if (FALSE){
  obj <- ls()
  obj <- obj[!obj %in% c("db_privkey", "db_pubkey", "db_pwd", "db_username")]
  rm(list = obj)
  rm(obj)
}


```

### For connectng to Nivabasen    
Store your username and password to R (only once per R session)  
```{r}

set_credentials()

# Check these codes (press F2) for reminder about what comes from which tables:
# niRvana::get_biota_chemistry
# niRvana::get_samples_from_sampleid

```

## 1. Read data


### a. Year
```{r}

selected_year <- 2020

```


### b. Get most recent data produced in Jupyterhub  
We only keep the data for the curret year
```{r}
# dir("Data")
# Data at sample level (chemical data, biological efect parameters and VDSI)
data_all <- readRDS(file = "Files_to_Jupyterhub_2020/01_df_2020_notstandard_2021-06-15.rds")

```


### c. Get samples in Labware file     
```{r}

# March-December data
sql <- paste(
  "select * from NIVADATABASE.LABWARE_CHECK_SAMPLE", 
  "where extract(YEAR from SAMPLED_DATE) =", selected_year, 
  "and extract(MONTH from SAMPLED_DATE) >= 3", 
  "and UPPER(PROSJEKT) like '%MILKYS%';")
sql
df_labware_01 <- get_nivabase_data(sql)

# January-February next year data (if any)
sql <- paste(
  "select * from NIVADATABASE.LABWARE_CHECK_SAMPLE", 
  "where extract(YEAR from SAMPLED_DATE) =", selected_year + 1, 
  "and extract(MONTH from SAMPLED_DATE) <= 2", 
  "and UPPER(PROSJEKT) like '%MILKYS%';")
df_labware_02 <- get_nivabase_data(sql)

# Remove everything except Eider duck stations
# Extract 'Specimen_no' and 'TISSUE_NAME'
df_samples <- bind_rows(df_labware_01, df_labware_02) %>%
  # Add 'Specimen_no'
  mutate(DESCRIPTION = gsub("<f8>", "ø", DESCRIPTION, fixed = TRUE),
         DESCRIPTION = gsub("<c5>", "Å", DESCRIPTION, fixed = TRUE),
         DESCRIPTION = gsub("<e5>", "å", DESCRIPTION, fixed = TRUE),
         DESCRIPTION = gsub("<c6>", "Æ", DESCRIPTION, fixed = TRUE),
         DESCRIPTION = gsub("<e6>", "æ", DESCRIPTION, fixed = TRUE),
         DESCRIPTION2 = DESCRIPTION %>% stringr::str_sub(start = nchar(AQUAMONITOR_CODE) + 1),
         Specimen_no = stringr::str_extract(DESCRIPTION2, "[0-9]+") %>% as.numeric(),
         TISSUE_NAME = stringr::str_sub(TISSUE, start = 4))

```


### d. Get some generic lookup tables  
* Tissues  
* Species names  
* Projects
* Methods  
```{r}

df_tissue <- get_nivabase_data(
  "select TISSUE_ID,TISSUE_NAME from NIVADATABASE.BIOTA_TISSUE_TYPES")

df_taxon <- get_nivabase_selection(
  "NIVA_TAXON_ID, LATIN_NAME", 
  "TAXONOMY", 
  "LATIN_NAME",
  unique(dat_eider_nivabase$LATIN_NAME), values_are_text = TRUE
  )

# Get a list of projects
df_projects <- get_projects()   # we call it 'df_projects' (the default name)

# Get a list of stations
df_stations <- get_stations_from_project("CEMP_Biota", ignore.case = FALSE)

# Get df_methods (NILU methods only)
df_methods <- get_nivabase_selection(
  "*", 
  "METHOD_DEFINITIONS", 
  "LABORATORY", 
  "NILU", values_are_text = TRUE)

```




## 2. Data to insert in NIVAbase
1. Eider duck data are from specimens/samples that MOSTLY ARE in the NIVAbase (for 2018 data, they were NOT) 
    - Sample ID given as Labware ID, e.g. 'NR-2020-09188' 
    - New records in BIOTA_SAMPLES only (SAMPLE_NO taken from data, get SAMPLE_ID from database)
    - Also note that although pairs of eggs and blood were unrelated (I think!),
      the same SPECIMEN_ID was giben for pairs of blood/egg samples     

2. NILU cod data (siloxans; D4,D5 and D6) are from specimens that MOSTLY ARE in the NIVAbase, 
but new samples (liver) are numbered corresponding to the muscle samples
   - Sample ID should normally be given as station number + sample number (1-100)
   - This was added manually in the excel file (Samperapport_edited.xlsx)
     based on the 'fake Labware ID' (e.g. 'NR-2020-09188') added (which doesn't correspond to
     the actual Labware IDs)
   - Use existing record in BIOTA_SINGLE_SPECIMENS (existing SPECIMEN_ID)
   - New records in BIOTA_SAMPLES_SPECIMENS - relationship between SAMPLE_NO and SPECIMEN_ID
   should be the same as for muscle
   - New records in BIOTA_SAMPLES (new SAMPLE_ID, SAMPLE_NO taken from data)

3. Biological effects in cod - from specimens that ARE in the NIVAbase, with the 
exception of a single cod individual (Fish_no = 15, station = 53B). New samples (bile, blood,
liver fraction). Samples are numbered corresponding to the muscle samples (as NILU cod)
    - Use existing records in BIOTA_SINGLE_SPECIMENS (existing SPECIMEN_ID)  
    - New records in BIOTA_SAMPLES_SPECIMENS (new SAMPLE_ID, but existing SPECIMEN_ID)  
    - New records in BIOTA_SAMPLES (new SAMPLE_ID, SAMPLE_NO taken from data)  


### a. NILU data  
```{r}

dat_cod <- readRDS("Data/210_dat_cod-siloxans_2020.rds") %>%
  mutate(TEXT_ID = sub("Nr. ", "NR-", Sample_no, fixed = TRUE))

# xtabs(~TEXT_ID + Group, dat_cod)

```


### b. Add station code    
- Starting 'data_for_input'  
```{r}

# Make lookup table for finding station code + ID
df_lookup_stations <- data_all %>%
  distinct(STATION_CODE, STATION_NAME, STATION_ID)

# Check contents of 'Sample' field
table(substr(dat_cod$Sample, 13, 20))

# Start 'data_for_input'  
data_for_input_1 <- dat_cod %>%
  mutate(
    STATION_CODE = case_when(
      grepl("oslo", Sample) ~ "30B",
      grepl("bergen", Sample) ~ "24B",
      grepl("svalbard", Sample) ~ "19B",
      grepl("tromsø", Sample) ~ "43B2",
      grepl("varanger", Sample) ~ "10B",
      TRUE ~ "",
  )) %>%
  left_join(df_lookup_stations, by = "STATION_CODE") %>%
  mutate(
    LATIN_NAME = "Gadus morhua"
  ) %>%
  rename(
    TISSUE_NAME = Tissue,
    UNIT = Unit
  )

table(addNA(data_for_input_1$STATION_ID))

```

### c. Tissue, check  
If 'Tissues are correct' we can just keep this column
```{r}

df_tissue <- get_nivabase_data("select TISSUE_ID,TISSUE_NAME from NIVADATABASE.BIOTA_TISSUE_TYPES")

cat("Tissues:\n")
unique(data_for_input_1$TISSUE_NAME)

check <- unique(data_for_input_1$TISSUE_NAME) %in% df_tissue$TISSUE_NAME
if (sum(!check) == 0){
  cat("Tissue names exist in NIVAbasen\n")
} else {
  warning("NOT ALL tissue names exist in NIVAbasen!")
}
```


### d. Species, check  
If 'Species are correct' we can just keep this column
```{r}
cat("Species:\n")
unique(data_for_input_1$LATIN_NAME)

df_species <- get_nivabase_selection("SPECIES_ID,LATIN_NAME", "SPECIES", 
                                     "LATIN_NAME", unique(data_for_input_1$LATIN_NAME), values_are_text = TRUE)

check <- unique(data_for_input_1$LATIN_NAME) %in% df_species$LATIN_NAME
if (sum(!check) == 0){
  cat("Species names exist in NIVAbasen\n")
} else {
  warning("NOT ALL species names exist in NIVAbasen!")
}

```

### e. Date - not needed       
```{r}
# from 
# data_for_input_1 %>% 
#   count(STATION_CODE, SAMPLE_DATE)
```

### f. Parameters  
- We just check what we used last year  
```{r}

df_lookup_methods_1 <- get_nivabase_selection(
  "*", 
  "METHOD_DEFINITIONS", 
  "NAME", 
  c("D4","D5","D6"), values_are_text = TRUE)

df_lookup_methods_2 <- df_lookup_methods_1 %>%
  filter(LABORATORY == "NILU" & grepl("w.w.", UNIT))

df2 <- get_nivabase_selection("*", "BIOTA_CHEMISTRY_VALUES", "METHOD_ID", df_lookup_methods$METHOD_ID)
df3 <- get_nivabase_selection("*", "BIOTA_SAMPLES", "SAMPLE_ID", df2$SAMPLE_ID)
df_lookup_methods <- df_lookup_methods_2 %>% 
  select(METHOD_ID, NAME, UNIT) %>%
  right_join(df2, by = "METHOD_ID") %>%
  left_join(df3, by = "SAMPLE_ID") %>%
  filter(year(SAMPLE_DATE) == 2019) %>%
  distinct(NAME, UNIT, METHOD_ID)

if(sum(table(df_lookup_methods$NAME) > 1)){
  stop("Some values of NAME has more than one METHOD_ID!")
} else {
  message("All NAME values are unique in 'df_lookup_methods'")
}

# Add METHOD_ID 
data_for_input <- data_for_input_1 %>%
  left_join(
    df_lookup_methods %>% rename(UNIT_Method = UNIT),
    by = c("Parameter" = "NAME")
  )

if (sum(is.na(data_for_input$METHOD_ID)) > 0){
stop("Some values of Parameter not found in 'df_lookup_methods'!")
} else {
  message("All METHOD_ID found")
}

# df4 <- get_nivabase_selection("*", "BIOTA_SAMPLES_SPECIMENS", "SPECIMEN_ID", df3$SAMPLE_ID)


```
### g. Units, check manually    
- Must be correspondence between UNIT and UNIT_Method!  
```{r}

data_for_input %>%
  distinct(Parameter, UNIT, UNIT_Method)

```





## 3. Plot connections  
```{r, fig.width = 8, fig.height=4}

stations <- data_for_input$STATION_CODE %>% unique()

for (station in stations){
  gg <- data_for_input %>%
    filter(STATION_CODE %in% station) %>%
    mutate(SAMPLE_NO = factor(Sample_no), SPECIMEN_NO = factor(SPECIMEN_NO)) %>%
    ggplot(aes(SAMPLE_NO, SPECIMEN_NO)) +
    geom_point() +
    facet_grid(cols = vars(TISSUE_NAME)) +
    theme(axis.text.x = element_text(angle = -45, hjust = 0)) +
    labs(title = station)
  print(gg)
}

```




## 10. BIOTA_SINGLE_SPECIMENS  
### a. Gets existing BIOTA_SINGLE_SPECIMENS  
```{r}

existing_singlespec_1 <- get_nivabase_selection(
  "*",
  "BIOTA_SINGLE_SPECIMENS",
  "STATION_ID",
  unique(data_for_input$STATION_ID),
  extra_where = " and extract(YEAR from DATE_CAUGHT) = 2020"
)
# Check

existing_singlespec_1 %>%
  left_join(df_stations %>% select(STATION_ID, STATION_CODE)) %>%
  ggplot(aes(x = STATION_CODE, y = SPECIMEN_NO)) +
  geom_point()


```

### b. Specimens we need vs. specimens we got   
Two important points here:  
1. Biological effect samples are never pooled samples, so we have a one-to-one relationship between samples and inividuals. Thus, we can add SPECIMEN_NO as a column to the sample table (without having to go via BIOTA_SAMPLES_SPECIMENS)   
2. Also, in this particular case/year, the sample number is identical to the specimen number

### b1. Check samples in Labware file     
**For a bit improved code without hard-coded year, see "74...2019data"** 
```{r}

#
# 2019 data  
#

# March-December data
df_labware_01 <- 
  get_nivabase_data(
    "select * from NIVADATABASE.LABWARE_CHECK_SAMPLE 
    where extract(YEAR from SAMPLED_DATE) = 2019 
    and extract(MONTH from SAMPLED_DATE) >= 3 
    and UPPER(PROSJEKT) like '%MILKYS%';")   # HARD-CODED
# January-February next year data
df_labware_02 <- 
  get_nivabase_data(
    "select * from NIVADATABASE.LABWARE_CHECK_SAMPLE 
    where extract(YEAR from SAMPLED_DATE) = 2020 
    and extract(MONTH from SAMPLED_DATE) <= 2 
    and UPPER(PROSJEKT) like '%MILKYS%';")   # HARD-CODED

df_samples <- bind_rows(df_labware_01, df_labware_02) %>%
  filter(AQUAMONITOR_CODE %in% df_stations$STATION_CODE)

```

### b2. Visualise Fish_no vs SAMPLE_NO   
Check whether there are other tissues than liver (not liver-microsome) and muscle  
```{r}

df_samples %>%
  filter(AQUAMONITOR_CODE %in% data_for_input$STATION_CODE) %>%
  ggplot(aes(BIOTA_SAMPLENO, Specimen_no, color = is.na(X_BULK_BIO))) +
  geom_point() +
  facet_grid(vars(AQUAMONITOR_CODE), vars(TISSUE))

```
### b3. Add SPECIMEN_NO to biota_samples     
Given that the checks above shows that two assumptions given in start of 'b' is OK  
```{r}

# Given the two assumptions above, we can do like this:  
biota_samples <- biota_samples %>%
  mutate(SPECIMEN_NO = SAMPLE_NO)

if (FALSE){
  
  # Samples that lack a corresponding individual
  biota_samples %>%
    anti_join(existing_singlespec_1, by = c("STATION_ID", "SPECIMEN_NO")) %>%
    left_join(df_stations %>% select(STATION_ID, STATION_CODE)) %>%
    select(STATION_CODE, TISSUE_NAME, SAMPLE_NO, SPECIMEN_NO) %>%
    arrange(STATION_CODE, TISSUE_NAME, SAMPLE_NO)
  
}

```
### b4. Start 'biota_specimens_to_add'   
```{r}

# Start 'specimens_to_add' 
biota_specimens_to_add <- biota_samples %>%
  anti_join(existing_singlespec_1, by = c("STATION_ID", "SPECIMEN_NO")) %>%
  distinct(STATION_ID, SPECIMEN_NO)


nrow(biota_specimens_to_add) %>% cat(); 
cat(" specimen records will be added to BIOTA_SINGLE_SPECIMENS")

```

### c. Add date and species code   
to `existing_singlespec_date` 
```{r}

existing_singlespec_date <- existing_singlespec_1 %>%
  count(STATION_ID, DATE_CAUGHT,TAXONOMY_CODE_ID)
existing_singlespec_date
# should be only one line per station_id! (I.e. 4 lines)

biota_specimens_to_add <- biota_specimens_to_add %>%
  safe_left_join(existing_singlespec_date %>% select(-n), 
                 na_matches = "never",
                 by = "STATION_ID",
                 check = "BCV")

```

### d. Make SQLs  
PASTE INTO SQL DEVELOPER TO ADD THE RECORDS   
Note to DHJ: use "SQL developer (latest version)" from desktop. Don't use the start menu.  
- remember `commit;` after running the insert sentences  
```{r}
# Test functions
# make_sql_single_specimen(1, biota_single_specimens_eider)
# make_sql_single_specimen(2, biota_single_specimens_eider)

sql_list <- 1:nrow(biota_specimens_to_add) %>% 
  map_chr(make_sql_single_specimen, data = biota_specimens_to_add)
sql <- paste(sql_list, collapse = ";\n")
sql <- paste0(sql, ";\n")  
writeLines(sql, "clipboard")  # copies SQLs to clipboard - go to SQL Developer and paste


cat("Number of SQLs: \n")
length(sql_list)  # 9


cat("\nSample of SQLs: \n")
sql_list[1:3]

```

### e. Get the records we just added  
Directly from R, instead of pasting into SQL Developer for getting data  
- in contrast to the original of this code (for 2018 data)   
Remember to **commit** in SQL developer first  
```{r}

biota_specimens_fromdatabase <- niRvana::get_nivabase_selection(
  "*",
  "BIOTA_SINGLE_SPECIMENS",
  "STATION_ID",
  biota_specimens_to_add$STATION_ID, 
  extra_where = paste(
    " and extract(YEAR from DATE_CAUGHT) =",
    selected_year, 
    "and ENTERED_BY = 'DHJ'")
)

if (FALSE)
  biota_specimens_fromdatabase


cat("Number of records: ")
nrow(biota_specimens_fromdatabase) %>% cat()   # 144
cat("\nShould be the same as number of SQLs above! \n\n")

# Check ID
cat("SPECIMEN_ID: ")
range(biota_specimens_fromdatabase$SPECIMEN_ID) %>% paste(collapse = " - ") %>% cat()
cat("\n")

```



## 11. BIOTA_SAMPLES_SPECIMENS   
Add records for   
1. The new specimens  
2. The 'old' specimens, linking to new samples (biota_samples)  

### a. Get all individuals  
(including the new ones)
```{r}

biota_specimens_complete <- niRvana::get_nivabase_selection(
  "*",
  "BIOTA_SINGLE_SPECIMENS",
  "STATION_ID",
  unique(biota_samples$STATION_ID), 
  extra_where = paste(
    " and extract(YEAR from DATE_CAUGHT) =",
    year)
    )

cat("Number of records: ")
nrow(biota_specimens_complete) %>% cat()   # 144

```

### b. Make `biota_samples_specimens`
```{r}

# biota_samples already have SPECIMEN_NO added (from 10b)
biota_samples_specimens <- biota_samples %>%
  select(STATION_ID, STATION_CODE, TISSUE_NAME, SAMPLE_NO, SAMPLE_ID, SPECIMEN_NO) %>%
  safe_left_join(
    biota_specimens_complete %>% select(STATION_ID, SPECIMEN_NO, SPECIMEN_ID),
    na_matches = "never",
    by = c("STATION_ID", "SPECIMEN_NO"),
    check = "BCV")
    
cat("Number of records that will be added to BIOTA_SAMPLES_SPECIMENS: ")
nrow(biota_samples_specimens) %>% cat()   # 144

```

### c. Visualise biota_samples_specimens  
```{r}

if (FALSE)
  xtabs(~SAMPLE_NO + SPECIMEN_NO + STATION_ID, biota_samples_specimens)


ggplot(biota_samples_specimens, aes(SAMPLE_NO, SPECIMEN_NO)) +
  geom_point() +
  facet_grid(cols = vars(STATION_CODE), rows = vars(TISSUE_NAME)) +
  theme(axis.text.x = element_text(hjust = 0, angle = -30))

```


### d. Make SQLs  
PASTE INTO SQL DEVELOPER TO ADD THE RECORDS  
```{r}
sql_list <- 1:nrow(biota_samples_specimens) %>% 
  map_chr(make_sql_samples_specimens, data = biota_samples_specimens)
sql <- paste(sql_list, collapse = ";\n")
sql <- paste0(sql, ";\n")
writeLines(sql, "clipboard")   # copies SQLs to clipboard - go to SQL Developer and paste

cat("Number of SQLs: \n")
length(sql_list)  # 144

cat("\nSample of SQLs: \n")
sql_list[1:3]

```




## 12. BIOTA_CHEMISTRY_VALUES

### a1. Check uniqueness  
```{r}

data_insert2 %>%
  count(STATION_ID, LATIN_NAME, TISSUE_NAME, SAMPLE_NO, NAME) %>%
  xtabs(~n, .)  # should be only 1's!

```
### a2. Check that SAMPLE_NO is given for all   
```{r}

data_insert2 %>%
  filter(is.na(SAMPLE_NO)) %>%
  nrow()

```

### b. Make `biota_chemistry_values`  
Also here, we have to make sure that we use 'Liver - microsome' and not just 'Lever'  
- See 9a  
```{r}

biota_chemistry_values <- data_insert2 %>%
  mutate(
    REPNO = SAMPLE_NO,
    TAXONOMY_CODE_ID = latin_to_taxid("Gadus morhua")$TAXONOMY_CODE_ID,
    TISSUE_NAME = case_when(
      TISSUE_NAME == "Lever" ~ "Liver - microsome",   # HARD-CODED
      TRUE ~ TISSUE_NAME)
  ) %>%
  safe_left_join(biota_samples %>% 
                   select(STATION_ID, TISSUE_NAME, SAMPLE_NO, SAMPLE_ID),
                 by = c("STATION_ID", "TISSUE_NAME", "SAMPLE_NO"),
                 na_matches = "never",
                 check = "BCMV")  # ''M' give error if x has unmatched sets of joining values

cat("Number of records that will be added to BIOTA_SAMPLES_SPECIMENS: ")
nrow(biota_chemistry_values) %>% cat()   # 203

# Check if SAMPLE_NO or SAMPLE_ID is NA
if (FALSE){
  sum(is.na(biota_chemistry_values$SAMPLE_NO))
  sum(is.na(biota_chemistry_values$SAMPLE_ID))
}

```

### c. Visualise data   
Compare with plot in 1c  
```{r}

ggplot(biota_chemistry_values, aes(TISSUE_NAME, SAMPLE_NO, color = VALUE)) +
  geom_point() +
  facet_grid(cols = vars(STATION_CODE), rows = vars(NAME)) +
  theme(axis.text.x = element_text(hjust = 0, angle = -30))

ggplot(biota_chemistry_values, aes(SAMPLE_NO, VALUE)) +
  geom_point() +
  facet_grid(cols = vars(STATION_CODE), rows = vars(NAME), scale = "free_y") +
  theme(axis.text.x = element_text(hjust = 0, angle = -30))


```


### c. Make SQLs  
PASTE INTO SQL DEVELOPER TO ADD THE RECORDS   
- Remember to `commit;` afterwards  
```{r}

sql_list <- 1:nrow(biota_chemistry_values) %>% 
  map_chr(make_sql_chemistry_values, data = biota_chemistry_values)
length(sql_list) # 225

i <- 1:length(sql_list)
sql <- paste(sql_list[i], collapse = ";\n")
sql <- paste0(sql, ";\n")
writeLines(sql, "clipboard-1024")   # copies SQLs to clipboard - go to SQL Developer and paste
                                    # "clipboard-1024" instead of "clipboard": increases avaliable
                                    #    for the clipboard

cat("Number of SQLs: \n")
length(sql_list)  # 9


cat("\nSample of SQLs: \n")
sql_list[1:3]

```






## 13. Final check    

### a. Reload data  
```{r}

# Get all specimens collected at these stations (20 seconds or so)
df_specimens_allyrs <- get_specimens_from_stationdata(df_stations)

# Get data frame of chemical results (30 seconds or so)
dat_test <- get_biota_chemistry(
  years = selected_year, 
  specimendata = df_specimens_allyrs,
  stationdata = df_stations,
  report_samples = TRUE)

head(dat_test)

if (FALSE){
  
  # Check tissues in the 2019 data
  dat_nivabase_2018 <- get_biota_chemistry(
    years = selected_year, 
    specimendata = df_specimens_allyrs,
    stationdata = df_stations,
    report_samples = TRUE)
  
  xtabs(~NAME + TISSUE_NAME, dat_nivabase_2018 %>% filter(NAME %in% pars))
  # ALAD = Blod 
  # EROD = Liver - microsome
  # The rest = Galle 
}


```


### b. Plot  
Should look like the plot in 1c and 12c! (Except that 1c has more parameters  )
```{r}

# Parameters
pars <- c("PA1O", "PYR1O", "BAP3O", "PA1OH", "PYR1OH", "BAP3OH", "ALAD", "EROD", "ABS380")

dat_test %>%
  filter(NAME %in% pars) %>% # View()
  # group_by(STATION_CODE, NAME) %>%
  # summarise(VALUE = median(VALUE)) %>%
ggplot(aes(SAMPLE_NO, VALUE)) +
  geom_point() +
  facet_grid(cols = vars(STATION_CODE), rows = vars(NAME), scales = "free_y")


```



## APPENDIX  
```{r}

```{r}

df1 <- get_nivabase_selection(
  "*",
  "BIOTA_SINGLE_SPECIMENS",
  "STATION_ID",
  69750,
  extra_where = " and extract(YEAR from DATE_CAUGHT) = 2020")

df2 <- get_nivabase_selection(
  "*",
  "BIOTA_SAMPLES_SPECIMENS",
  "SPECIMEN_ID",
  df1$SPECIMEN_ID)

df3 <- get_nivabase_selection(
  "*",
  "BIOTA_SAMPLES",
  "SAMPLE_ID",
  df2$SAMPLE_ID)

df3 <- get_nivabase_selection(
  "*",
  "BIOTA_SAMPLES",
  "SAMPLE_ID",
  df2$SAMPLE_ID)

df3b <- get_nivabase_selection(
  "*",
  "BIOTA_SAMPLES",
  "SAMPLE_ID",
  245960)

df3b <- get_nivabase_selection(
  "*",
  "BIOTA_SAMPLES",
  "STATION_ID",
  69750,
  extra_where = " and extract(YEAR from SAMPLE_DATE) = 2020")

```
```

