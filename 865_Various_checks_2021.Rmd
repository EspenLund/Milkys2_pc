---
title: "862_Get_sample_data"
author: "DHJ"
date: "21 9 2021"
output: 
  html_document:
    toc: true
    toc_float: 
---

Various checks of the raw data from Jupyterhub and/or Nivadatabase  

* Set 'from_jupyterhub' to TRUE or FALSE depending on what you want to plot  
    
    

## 1. Libraries
```{r setup, include=FALSE}
# install.packages("niRvana")

library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)
library(tidyr)
library(ggeasy)

# And then the niRvana package. If you need to install it, then run thee next line also:
# devtools::install_github("NIVANorge/niRvana")
library(niRvana)

source("802_Get_NIVAbasen_data_functions.R")

```

### Settings  
```{r}

sampling_year <- 2021

# Set to TRUE if you want to used data from Nivadatabasen   
# Set to FALSE if you want to used data exported from Jupyterhub    
from_jupyterhub <- FALSE

```


## 2a. Nivadatabase data   

### Give your username and password to R (only once per R session)  

*Not necessary if username and password has been set using keyring**  

```{r}

# set_credentials()

```

### Get the list of projects

```{r}

df_projects <- get_projects()   # we call it 'df_projects' (the default name used by 'get_stations_from_project')

```

### Get a list of the stations in the CEMP_Biota project

```{r}

df_stations <- get_stations_from_project("CEMP_Biota", ignore.case = FALSE)

```

### Get all specimens collected at these stations (20 seconds or so)
- Includes LATIN_NAME  
```{r}

df_specimens <- get_specimens_from_stationdata(df_stations, years = sampling_year)
cat("df_specimens:", nrow(df_specimens), "rows\n")

# Checking wrong year
df_specimens_nextyear <- get_specimens_from_stationdata(df_stations, years = sampling_year + 1)

cat("df_specimens_nextyear:", nrow(df_specimens_nextyear), "rows\n")

```

### Plot sample dates in 2021 (or later)

```{r, fig.height=6, fig.width=7}

df_specimens %>%
  filter(year(DATE_CAUGHT) >= sampling_year) %>%
  ggplot(aes(DATE_CAUGHT)) +
  geom_histogram(binwidth = 3600*24*10) +   # 10 days
  scale_x_datetime(date_breaks = "1 month", date_labels = "%m %Y") +
  facet_wrap(vars(LATIN_NAME), ncol = 1, scales = "free_y")

```


### Get the data itself  
Get data frame of chemical data for all samples for the measurement year   
- LATIN_NAME is included  
```{r, results = FALSE}

# debugonce(get_biota_chemistry)
# debugonce(get_samples_from_sampleid)

dat_base <- get_biota_chemistry(
  years = sampling_year,
  specimendata = df_specimens, 
  stationdata = df_stations,
  report_samples = TRUE)

```


## 2b. Jupyterhub data  

### a. Data from Jupyterhub   
```{r}

dat_hub <- readRDS("Files_from_Jupyterhub_2021/109_adjusted_data_2022-06-04.rds")

# For coordinates   
dat_stations <- readxl::read_excel("Files_to_Jupyterhub_2021/Kartbase_edit.xlsx")

# dat_bigexcel <- readRDS("Files_from_Jupyterhub_2020/Big_excel_table/Data_xl_2021-09-15_ver02.rds")

```

### b. Select time series with data in sampling_year     
- Define dat_sel1a and dat_sel1b
```{r}

# Select time series with data in 2020   
dat_sel1a <- dat_hub %>%
  group_by(STATION_CODE, TISSUE_NAME, PARAM) %>%
  mutate(Last_year = max(MYEAR)) %>%
  filter(Last_year >= sampling_year) %>%
  ungroup() %>%
  mutate(LOQ = ifelse(is.na(FLAG1),"Over LOQ", "Under LOQ"))  

dat_sel1b <- dat_base %>%
    mutate(
      LOQ = ifelse(is.na(FLAG1),"Over LOQ", "Under LOQ"),
      PARAM = NAME,
      MYEAR = sampling_year,
      VALUE_WW = VALUE)  
  

```


## 3. Check 36A/36A1/36B  

```
From: Espen Lund <espen.lund@niva.no> 
Sent: fredag 15. juli 2022 12:20
To: Dag Øystein Hjermann <Dag.Hjermann@niva.no>
Cc: Merete Grung <merete.grung@niva.no>; Merete Schøyen <merete.schoyen@niva.no>
Subject: MILKYS 2021: rettelser SIA

Hei, når du er tilbake igjen, Dag: 
Det har vært noen rettelser i stasjoner for SIA-dataene i LIMS. Vet ikke om rettelsene automatisk også blir gjort i Nivabasen, vi må sjekke at det blir riktig i Nivabasen og i våre datafiler:
SIA-data for torsk 36B ble feilaktig plassert på  blåskjell 36A. 
SIA-data for blåskjell 36A1 ble feilaktig plassert på blåskjell 36A. 
Se utklipp under, hvor rødt er feil og grønt er riktig: 

Espen
```

### Check samples    
```{r}

df_samples_36A <- niRvana::get_samples_by_stationcode("36A")
xtabs(~Year, df_samples_36A)
xtabs(~TISSUE_NAME + SPECIMEN_NO, df_samples_36A %>% filter(Year == 2021))

df_samples_36B <- niRvana::get_samples_by_stationcode("36B")
xtabs(~TISSUE_NAME + SPECIMEN_NO, df_samples_36B %>% filter(Year == 2021))

df_samples_36A1 <- niRvana::get_samples_by_stationcode("36A1")
xtabs(~Year, df_samples_36A1)
xtabs(~TISSUE_NAME + SPECIMEN_NO, df_samples_36A1 %>% filter(Year == 2021))

```

### Check cod and mussel data  

*  Error: there should be no 36A, all blue mussel data should be 36A1    
*  Correct: All cod data is 36B       

```{r}

xtabs(~TISSUE_NAME + NAME + STATION_CODE + LATIN_NAME, 
      dat_base %>% filter(STATION_CODE %in% c("36A", "36A1", "36B") & NAME %in% c("% C", "Delta 15N", "BDE77"))
)

```

## 4. Check PAH metabolites + ALAD, EROD  

```{r}

st <- "23B"
st <- "53B"

dat_base %>%
  filter(STATION_CODE == st) %>%
  View(st)

dat_base %>%
  filter(STATION_CODE == st) %>%
  xtabs(~NAME, .)

dat_base %>%
  filter(STATION_CODE == st) %>%
  xtabs(~TISSUE_NAME, .)

dat_base %>%
  filter(grepl("OH", NAME, ignore.case = FALSE))

dat_2020 <- readRDS("Files_from_Jupyterhub_2020/Raw_data/109_adjusted_data_2021-09-15.rds")

dat_2020 %>%
  filter(STATION_CODE == st) %>%
  xtabs(~TISSUE_NAME, .)

dat_2020 %>%
  filter(STATION_CODE == st & TISSUE_NAME %in% c("Blod", "Galle", "Liver - microsome")) %>%
  xtabs(~PARAM, .)

```

## 5. Check ferrybox stations (unrelated to Milkys)  

### From projects like "forsuring"   
* 2010-2012 only  
```{r}

get_nivabase_data("select * from NIVADATABASE.PROJECTS_STATIONS where rownum < 4")
get_nivabase_data("select * from NIVADATABASE.PROJECTS where rownum < 4")

df1 <- get_nivabase_data("select PROJECT_ID, PROJECT_NAME, PROJECT_DESCRIPTION from NIVADATABASE.PROJECTS where PROJECT_NAME like '%forsur%'")

df1

df2 <- get_nivabase_selection("*", "PROJECTS_STATIONS", "PROJECT_ID", df1$PROJECT_ID)

df2b <- df2 %>%
  left_join(df1) %>%
  group_by(STATION_ID, STATION_CODE, STATION_NAME) %>%
  summarize(across(.cols = c(PROJECT_ID, PROJECT_NAME), .fns = ~paste(unique(.), collapse = ",")))

df3 <- niRvana::add_coordinates(df2b)

# write.csv(df3, "../../seksjon 214/R-oceanography/Common data/PROJECTS_STATIONS_acidification.csv")

df3b <- df3 %>% filter(grepl("FerryBox", STATION_NAME))

if (FALSE){
  library(leaflet)
  # Copy/paste to console
  leaflet() %>%
    addTiles() %>%
    addMarkers(lng = df3b$LONGITUDE, lat = df3b$LATITUDE, 
               popup = paste(df3b$STATION_NAME, "<br>", df3b$PROJECT_NAME))
    
}

df4 <- get_nivabase_selection(
  "WATER_SAMPLE_ID, STATION_ID, SAMPLE_DATE, DEPTH1",
  "WATER_SAMPLES",
  "STATION_ID",
  df3b$STATION_ID)

table(year(df4$SAMPLE_DATE))

```
### From station names  

a. Norbjørn

```{r}

df1a <- get_nivabase_data(paste(
  "select * from NIVADATABASE.PROJECTS_STATIONS", 
  "where STATION_NAME like '%Tromsø-Svalbard%'"))
# zero

df1a <- get_nivabase_data(paste(
  "select * from NIVADATABASE.PROJECTS_STATIONS", 
  "where STATION_CODE like '%NB%'"))
# 189

nbs <- paste0("NB", 1:15) %>% sQuote() %>% paste(collapse = ",")

df1a <- get_nivabase_data(paste(
  "select PROJECT_ID, STATION_ID, STATION_CODE, STATION_NAME from NIVADATABASE.PROJECTS_STATIONS", 
  "where STATION_CODE in ('NB1','NB2','NB3','NB4','NB5','NB6','NB7','NB8','NB9','NB10','NB11','NB12','NB13','NB14','NB15')"))
# 31

df2 <- get_nivabase_selection(
  "WATER_SAMPLE_ID, STATION_ID, SAMPLE_DATE, DEPTH1",
  "WATER_SAMPLES",
  "STATION_ID",
  df1a$STATION_ID)

table(year(df2$SAMPLE_DATE))

df1b <- df1a %>% 
  left_join(df2 %>% count(STATION_ID, name = "samples_2019-2022")) %>%
  add_coordinates()

write.csv(df1b, "../Mikronor_midlertidig/Nivadatabase_Norbjorn_stations.csv")

if (FALSE){
  library(leaflet)
  # Copy/paste to console
  leaflet() %>%
    addTiles() %>%
    addMarkers(lng = df1b$LONGITUDE, lat = df1b$LATITUDE, 
               popup = paste(df1b$STATION_NAME, "<br>", df1b$PROJECT_NAME))
    
}

```


b. Fantasy + Norbjorn

```{r}

df1a <- get_nivabase_data(paste(
  "select * from NIVADATABASE.PROJECTS_STATIONS", 
  "where STATION_CODE like '%FA%'"))
# 225 obs but are they the right ones?

# Find projects f Norbjørn
proj_id <- unique(df1b$PROJECT_ID)

df1a <- get_nivabase_selection(
  "PROJECT_ID, STATION_ID, STATION_CODE, STATION_NAME", 
  "PROJECTS_STATIONS",
  "PROJECT_ID",
  proj_id
)

df_projects <- get_nivabase_selection(
  "PROJECT_ID, PROJECT_NAME",
  "PROJECTS",
  "PROJECT_ID",
  proj_id
)

df1b <- df1a %>% left_join(df_projects)

df2 <- df1b %>%
  group_by(STATION_ID, STATION_CODE, STATION_NAME) %>%
  summarize(across(.cols = c(PROJECT_ID, PROJECT_NAME), .fns = ~paste(unique(.), collapse = ","))) %>%
  add_coordinates()

write.csv(df2, "../Mikronor_midlertidig/Nivadatabase_Havforsuring_stations.csv")

if (FALSE){
  library(leaflet)
  # Copy/paste to console
  leaflet() %>%
    addTiles() %>%
    addMarkers(lng = df2$LONGITUDE, lat = df2$LATITUDE, 
               popup = paste(df2$STATION_NAME, "<br>", df2$PROJECT_NAME))
    
}

```

```{r}

```

```{r}



df_method <- get_nivabase_selection(
  "METHOD_ID, NAME, UNIT",
  "METHOD_DEFINITIONS",
  "NAME",
  "pH", values_are_text = TRUE)  




```


