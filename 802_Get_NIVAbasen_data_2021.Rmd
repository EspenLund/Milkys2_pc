---
title: "802 Get chemical data from NIVAbasen"
output: html_document
---

## Download raw data for use in Jupyterhub  

* Data are fetched from Nivadatabase (Aquamonitor, but not *using* Aquamonitor)    

* From 04.06.2022, we also started add data from Labware (part 5)  
    - the final data (df_2021_both) were combining Nivadatabase data (df_2021) with Labware data with status C, P and I
    to create the final data set saved in step 6 (before, part 4 was the final part) 
    - This was done to also include data "stalled" in Labware because some parameters (PFAS) had not been entered into LIMS     
    - Thus, "01_df_2021_notstandard_2022-06-04.rds" contains many more rows (19875 vs 5547) and
    two more variables (STATUS + STATUSX) compared to the file made two days before (2022-06-02)  

## 1. Libraries
```{r setup, include=FALSE}
# install.packages("niRvana")

library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)

# And then the niRvana package. If you need to install it, then run thee next line also:
# devtools::install_github("NIVANorge/niRvana")
library(niRvana)

source("802_Get_NIVAbasen_data_functions.R")

```

### Settings  
```{r}

sampling_year <- 2021

```


## 2. Get new(er) data

### Give your username and password to R (only once per R session):
```{r}
# set_credentials()
```

### Get the list of projects

```{r}

df_projects <- get_projects()   # we call it 'df_projects' (the default name used by 'get_stations_from_project')

```

### Get a list of the stations in the CEMP_Biota project

```{r}

df_stations <- get_stations_from_project("CEMP_Biota", ignore.case = FALSE)

```

### Get all specimens collected at these stations (20 seconds or so)
- Includes LATIN_NAME  
```{r}

df_specimens <- get_specimens_from_stationdata(df_stations, years = sampling_year + 0:1)
cat("df_specimens:", nrow(df_specimens), "rows\n")

# Checking wrong year
df_specimens_nextyear <- get_specimens_from_stationdata(df_stations, years = sampling_year + 1)

cat("df_specimens_nextyear:", nrow(df_specimens_nextyear), "rows\n")

```

### Plot sample dates in 2021 (or later)

```{r, fig.height=6, fig.width=7}

df_specimens %>%
  filter(year(DATE_CAUGHT) >= sampling_year) %>%
  ggplot(aes(DATE_CAUGHT)) +
  geom_histogram(binwidth = 3600*24*10) +   # 10 days
  scale_x_datetime(date_breaks = "1 month", date_labels = "%m %Y") +
  facet_wrap(vars(LATIN_NAME), ncol = 1, scales = "free_y")

```



## 3a. Get the data itself  
Get data frame of chemical data for all samples for the measurement year   
- LATIN_NAME is included  
```{r, results = FALSE}

# debugonce(get_biota_chemistry)
# debugonce(get_samples_from_sampleid)
# debugonce(get_chemistry_from_sampledata)

df_data <- get_biota_chemistry(
  years = sampling_year,
  specimendata = df_specimens, 
  stationdata = df_stations,
  report_samples = TRUE)

```


### Check data 1    
```{r}

xtabs(~STATION_CODE, df_data)

xtabs(~is.na(VALUE), df_data)

params_this_year <- unique(df_data$NAME) %>% sort()

# PAH-metabolites NOT in
grep("pyr", params_this_year, ignore.case = T, value = T)
grep("OH", params_this_year, ignore.case = F, value = T)

# Data from previous year
df_prev <- readRDS("Files_to_Jupyterhub_2020/01_df_2020_notstandard_2022-01-05.rds")
params_previous_year <- unique(df_prev$NAME)

# Change some parameter names, so they can be compared
params_previous_year <- sub("BDE-", "BDE", params_previous_year, fixed = TRUE)
params_previous_year <- sub("PCB-", "PCB ", params_previous_year, fixed = TRUE)

# Parameters in last year's data set but not this year
sel1 <- !params_previous_year %in% params_this_year
params_previous_year[sel1]

# Parameters in last year's data set but not this year
# ....

```

### Check data 2  
- Checks specifica parameters in last year's data and the new data
```{r}

string <- "MCCP"
string <- "HBCD"
string <- "H4PFOS"
string <- "Fluortelomersulfonat"
string <- "PFHpS"
string <- "D5"
string <- "OH"
string <- "1-OH-fenantren"

df_data %>% filter(grepl(string, NAME)) %>% pull(NAME) %>% unique() %>% paste(collapse = "; ")
df_prev %>% filter(grepl(string, NAME)) %>% pull(NAME) %>% unique() %>% paste(collapse = "; ")
full_join(
  df_data %>% filter(grepl(string, NAME)) %>% count(STATION_CODE, name = as.character(sampling_year)),
  df_prev %>% filter(grepl(string, NAME)) %>% count(STATION_CODE, name = as.character(sampling_year-1)),
  by = "STATION_CODE"
)



```

## 3b. Fix SCCP and MCCP issue   

For samples with
```
MCCP eksl LOQ = NA  
MCCP inkl LOQ = X      =>  LOQ = X
```

For samples with
```
MCCP eksl LOQ = X1
MCCP inkl LOQ = X2     =>  LOQ = X2 - X1
``` 

* FLAG1 is always NA  
* So the `'MCCP eksl LOQ' data that are under LOQ should be changed to LOQ, plus "<" as FLAG1 value   
* Moreover: the rows with NA simply doesn't exist in the Nivadabase table (table BIOTA_CHEMISTRY_VALUES in NIvadatabase)   
* Same for SCCP  

### a. Check 1    
```{r}

df_data %>% 
  filter(NAME %in% c("SCCP eksl. LOQ", "SCCP inkl. LOQ")) %>% 
  xtabs(~NAME + STATION_CODE + addNA(FLAG1), .)


df_data %>% 
  filter(NAME %in% c("MCCP eksl. LOQ", "MCCP inkl. LOQ")) %>%
  xtabs(~NAME + STATION_CODE + addNA(FLAG1), .)

```

### b. Check 2    
- Checking SCCP only  

```{r}

# SCCP  

df1  <- df_data %>% 
  filter(NAME %in% c("SCCP eksl. LOQ", "SCCP inkl. LOQ")) %>%
  select(STATION_CODE, TISSUE_NAME, SAMPLE_ID, NAME, VALUE) %>%
  tidyr::pivot_wider(names_from = NAME, values_from = VALUE)

df2 <- df_data %>% 
  filter(NAME %in% "SCCP inkl. LOQ") %>%
  select(STATION_CODE, TISSUE_NAME, SAMPLE_ID, NAME, FLAG1)

df_SCCP <- left_join(df1, df2)


# MCCP  

df1  <- df_data %>% 
  filter(NAME %in% c("MCCP eksl. LOQ", "MCCP inkl. LOQ")) %>%
  select(STATION_CODE, TISSUE_NAME, SAMPLE_ID, NAME, VALUE) %>%
  tidyr::pivot_wider(names_from = NAME, values_from = VALUE)

df2 <- df_data %>% 
  filter(NAME %in% "MCCP inkl. LOQ") %>%
  select(STATION_CODE, TISSUE_NAME, SAMPLE_ID, NAME, FLAG1)

df_MCCP <- left_join(df1, df2)

# Show
df_SCCP

```

### d. method ID  
```{r}

id <- df_data %>% 
  filter(NAME %in% c("SCCP eksl. LOQ", "SCCP inkl. LOQ", "MCCP eksl. LOQ", "MCCP inkl. LOQ")) %>% 
  pull(METHOD_ID) %>%
  unique()

df_meth_ccp <- get_nivabase_selection("NAME, METHOD_ID", "METHOD_DEFINITIONS", "METHOD_ID", id)

if (nrow(df_meth_ccp) != 4){
  stop("Expected one row per CCP, i.e. 4 rows")
}

```

### e. Make new data rows  
```{r}

#
# SCCP 
#

sample_id_lacking <- df_SCCP %>% 
  filter(is.na(`SCCP eksl. LOQ`)) %>%
  pull(SAMPLE_ID)

cat("SCCP:", nrow(df_SCCP), "samples -", length(sample_id_lacking), "samples lacking values for 'SCCP eksl. LOQ' \n")

df_SCCP_data_to_add <- df_data %>%
  filter(NAME %in% "SCCP inkl. LOQ" & SAMPLE_ID %in% sample_id_lacking)
  
cat("-", nrow(df_SCCP_data_to_add), "rows of data to add \n")

id <- df_meth_ccp %>% filter(NAME %in% "SCCP eksl. LOQ") %>% pull(METHOD_ID)

df_SCCP_data_to_add$NAME <- "SCCP eksl. LOQ"
df_SCCP_data_to_add$METHOD_ID <- id
df_SCCP_data_to_add$FLAG1 <- "<"

#
# MCCP 
#

sample_id_lacking <- df_MCCP %>% 
  filter(is.na(`MCCP eksl. LOQ`)) %>%
  pull(SAMPLE_ID)

cat("MCCP:", nrow(df_MCCP), "samples -", length(sample_id_lacking), "samples lacking values for 'MCCP eksl. LOQ' \n")

df_MCCP_data_to_add <- df_data %>%
  filter(NAME %in% "MCCP inkl. LOQ" & SAMPLE_ID %in% sample_id_lacking)
  
cat("-", nrow(df_MCCP_data_to_add), "rows of data to add \n")

id <- df_meth_ccp %>% filter(NAME %in% "MCCP eksl. LOQ") %>% pull(METHOD_ID)

df_MCCP_data_to_add$NAME <- "MCCP eksl. LOQ"
df_MCCP_data_to_add$METHOD_ID <- id
df_MCCP_data_to_add$FLAG1 <- "<"

```

### f. Add data  
```{r}

cat("nrow(df_data):", nrow(df_data), "\n")

check <- df_data %>% filter(NAME %in% "SCCP eksl. LOQ" & FLAG1 %in% "<")
if (nrow(check) == 0){
  df_data <- bind_rows(df_data, df_SCCP_data_to_add)
}

cat("nrow(df_data):", nrow(df_data), "\n")

check <- df_data %>% filter(NAME %in% "MCCP eksl. LOQ" & FLAG1 %in% "<")
if (nrow(check) == 0){
  df_data <- bind_rows(df_data, df_MCCP_data_to_add)
}

cat("nrow(df_data):", nrow(df_data), "\n")

```


## 4. Save data from Nivadatabase  

* Note: from 06.04.2022, we go one step further and add data from Labware (part 5) and save tht combined data in step 6 

```{r}
# #
# # Latest data data
# #
# 
# # Folder name
# name_folder <- paste0("Files_to_Jupyterhub_", sampling_year)
# 
# # Make folder, if it doesn't already exist:
# if (!dir.exists(name_folder)){
#   dir.create(name_folder)
# }
# 
# # Make timestamp (date stamp actually)
# t <- Sys.time()
# timestamp <- substr(t, 1, 10)
# 
# # File name
# name_file <- paste0("01_df_", sampling_year, "_notstandard_", timestamp, ".rds")
# 
# name_fullpath <- paste0(name_folder, "/", name_file)
# 
# # Set to TRUE/FALSE depending on whether file should be saved or not  
# if (FALSE){
# 
#   saveRDS(df_2021, file = name_fullpath)
#   cat("2021 data saved as rds,", sQuote(name_fullpath), "\n")
#   name_fullpath_txt <- sub("rds", "csv", name_fullpath)
#   write.csv(df_2021, file = name_fullpath_txt, fileEncoding = "UTF-8")
#   cat("2021 data saved as csv,", sQuote(name_fullpath_txt), "\n")
# 
# }
# 
# # Set to TRUE/FALSE depending on whether file should be read or not  
# if (FALSE){
#   
#   # Depends only on part 1 above
#   name_folder <- paste0("Files_to_Jupyterhub_", sampling_year)
#   fn_rds <- dir(name_folder, pattern = paste0("01_df_", sampling_year, "_notstandard.+.rds$"))
#   df_2021 <- readRDS(paste0(name_folder, "/", tail(fn_rds, 1)))
#   
# }

df_2021 <- df_data

```



## 5. Add data from Labware    

- This is used if there are half-finished" samples in Labware that are not approved, but we want to export them to Jupyterhub anyway  

### Get data  
```{r}

# From QC_Chemistry app. Failed with "table or view does not exist"
# df_labware <- get_nivabase_data("select * from labware.v_app_chemistry_qc_project where PROSJEKT = 'O 210200.ANAIN'")  

# test <- get_nivabase_data("select * from NIVADATABASE.LABWARE_IMPORT where rownum < 5")
# test <- get_nivabase_data("select * from NIVADATABASE.STATIONS where rownum < 5")

df_labware <- get_nivabase_data("select * from NIVADATABASE.LABWARE_IMPORT where PROSJEKT = 'O 210200.ANAIN'")
nrow(df_labware) # 20153

df_labware_meta <- get_nivabase_data("select * from NIVADATABASE.LABWARE_CHECK_SAMPLE where PROSJEKT = 'O 210200.ANAIN'")
nrow(df_labware_meta) # 982

# Save safety copy  
if (FALSE){

  sampling_year <- 2021
  
  # Folder name
  name_folder <- paste0("Files_to_Jupyterhub_", sampling_year)

  # Make timestamp (date stamp actually)
  t <- Sys.time()
  timestamp <- substr(t, 1, 10)
  
  # File name, data  
  name_file <- paste0("01_labware_", sampling_year, "_", timestamp, ".rds")
  name_fullpath <- paste0(name_folder, "/", name_file)
  
  # Save
  saveRDS(df_labware, name_fullpath)

  # File name, metadata
  name_file <- paste0("01_labwaremeta_", sampling_year, "_", timestamp, ".rds")
  name_fullpath <- paste0(name_folder, "/", name_file)
  
  # Save
  saveRDS(df_labware_meta, name_fullpath)
  
}


```


### Check 1: Sample dates  

```{r}

df_labware %>%
  count(AQUAMONITOR_CODE, SAMPLED_DATE) %>%
  ggplot() +
  geom_text(aes(x = SAMPLED_DATE, y = 1, label = AQUAMONITOR_CODE), position = "jitter") 

```


### Check 2: Parameter names    

* Compare the names sent to Milkys2 on Jupyterhub (n1) to those that we find in REPORTED_NAME (n3)    
* n1 contains many that we don't find inn3, but n1 is much longer
     - n1 contains for instance botn "BDE-49" (not found in n3) and "BDE49" (found in n3)   
     - all the n1 names are names that are standardized in the scripts on Jupyterhub  
     - so it's more important that there are few (and unimportant) parameters that are Labware but not in Nivabase 2020 (the last list)  

```{r}

# 2020 data sent to Milkys2 on Jupyterhub
fn <- "Files_to_Jupyterhub_2020/01_df_2020_notstandard_2022-01-05.rds"         # data sent FROM Milkys2_pc to Milkys2 on Jupyterhub 
df_2020 <- readRDS(fn)
# table(df_2020$SAMPLE_DATE)

n1 <- unique(df_2020$NAME) %>% sort()
n2 <- unique(df_2021$NAME) %>% sort()
n3 <- unique(df_labware$REPORTED_NAME) %>% sort()

cat("length(n1):", length(n1), "\n")
cat("length(n2):", length(n2), "\n")
cat("length(n3):", length(n3), "\n")

# Test setdiff
# setdiff(1:10, 5:20)

cat("In Nivabase 2020 and not in Labware: \n")
# setdiff(n1, n3)  
# - long list (109 names). 
# - contains for instance

cat("In Nivabase 2021 and not in Labware: \n")
setdiff(n2, n3)

cat("In Labware and not in Nivabase 2020: \n")
setdiff(n3, n1)

#  [1] "1,2,4,5-Tetraklorbenzen"              "a-Endosulfan"                        
#  [3] "Dicofol"                              "Heksaklorbutadien"                   
#  [5] "Heksakloretan"                        "Isodrin"                             
#  [7] "Pentaklorfenol"                       "Sum av analysert NonaBDEs (eks. LOQ)"
#  [9] "Sum av analysert OctaBDEs (eks. LOQ)" "Sum DDT"                             
# [11] "Telodrin" 


```

### Start 'df_2021_labware' by renaming variables  

* Mostly renaming, except TISSUE_NAME and APPROVED   
* Also including Status, used in next chunk  

```{r}

if (FALSE){
  # Used for writing code below
  names(df_2021)
  cat("\n")
  names(df_labware)
  cat("\n")
}

df_2021_labware <- df_labware %>%
  left_join(df_labware_meta %>% select(TEXT_ID, SPECIES, TISSUE, BIOTA_SAMPLENO), 
            by = "TEXT_ID") %>%
  mutate(
    TISSUE_NAME = str_sub(TISSUE, start = 4),
    APPROVED = 0
  ) %>%
  rename(
    STATION_CODE = AQUAMONITOR_CODE,
    STATION_NAME = AQUAMONITOR_NAME,
    LATIN_NAME = SPECIES,
    SAMPLE_DATE = SAMPLED_DATE,
    SAMPLE_NO = BIOTA_SAMPLENO,
    NAME = REPORTED_NAME,
    VALUE = NUMERIC_ENTRY,
    FLAG1 = ENTRY_QUALIFIER,
    UNIT = UNITS,
    STATION_ID = AQUAMONITOR_ID
    ) %>% 
  mutate(
    REPNO = SAMPLE_NO
  ) %>%
  select(
    STATION_CODE, STATION_NAME, LATIN_NAME, SAMPLE_DATE, TISSUE_NAME, SAMPLE_NO, REPNO,
    NAME, VALUE, FLAG1, UNIT, 
    APPROVED, STATION_ID, STATUS, STATUSX)

names(df_2021_labware)
  
if (FALSE){
  
  # some checks
  
  table(df_2021$TISSUE_NAME)
  table(df_2021_labware$TISSUE_NAME)
  
  sel <- df_2021$SAMPLE_NO == df_2021$REPNO
  mean(sel)
  
  table(df_2021$UNIT)
  table(df_labware$UNITS)
  table(df_labware$AQUAMONITOR_UNIT)
  
  table(df_2021$APPROVED)
  
  df_labware_meta %>% names()  

}


```

### Check status vs. sent to Nivabase   
```{r}

# table(df_2021_labware$STATION_CODE, df_2021_labware$STATUS)
# table(df_2021_labware$STATION_CODE, df_2021_labware$STATUSX)
# table(df_2021_labware$STATUS, df_2021_labware$STATUSX)

tab_lab <- df_2021_labware %>%
  count(STATION_CODE, STATUS) %>%
  tidyr::pivot_wider(names_from = STATUS, values_from = n)

tab_nivadatabase <- df_2021 %>%
  count(STATION_CODE, name = "Nivabase")

full_join(tab_lab, tab_nivadatabase, by = "STATION_CODE")

```

### Combine   

* Use status C, P and I only - this avoids adding data already in 'df_2021'  

```{r}

df_2021_both <- bind_rows(
  df_2021,             # Nivadatabase data from Nivadatabasen  
  df_2021_labware %>%
    filter(STATUS %in% c("C", "P", "I"))
)

```


### Check some data  
```{r}

# df_2021 %>% filter(STATION_CODE %in% "53B") %>% View()
# Muscle (Hg) data only

# df_2021_both %>% filter(STATION_CODE %in% "53B") %>% View()


```


### Check for duplicates  
```{r}

check <- df_2021_both %>%
  count(STATION_CODE, LATIN_NAME, TISSUE_NAME, NAME, SAMPLE_NO) %>%
  filter(n > 1)

nrow(check)  # should be zero

```



## 6. Save data from Nivadatabase + LIMS   

### a. Save  
```{r}
#
# Latest data
#

# Folder name
name_folder <- paste0("Files_to_Jupyterhub_", sampling_year)

# Make folder, if it doesn't already exist:
if (!dir.exists(name_folder)){
  dir.create(name_folder)
}

# Make timestamp (date stamp actually)
t <- Sys.time()
timestamp <- substr(t, 1, 10)

# File name
name_file <- paste0("01_df_", sampling_year, "_notstandard_", timestamp, ".rds")
name_file

name_fullpath <- paste0(name_folder, "/", name_file)

# Set to TRUE/FALSE depending on whether file should be saved or not  
if (FALSE){
  
  # SELECT:
  # data_final <- df_2021_both   # if using Labware data
  # data_final <- df_data        # if using only Nivabasen data

  saveRDS(data_final, file = name_fullpath)
  cat("2021 data saved as rds,", sQuote(name_fullpath), "\n")
  name_fullpath_txt <- sub("rds", "csv", name_fullpath)
  write.csv(data_final, file = name_fullpath_txt, fileEncoding = "UTF-8")
  cat("2021 data saved as csv,", sQuote(name_fullpath_txt), "\n")

}

```

### b. Read saved file  
```{r}

# Set to TRUE/FALSE depending on whether file should be read or not  
if (FALSE){
  
  # Depends only on part 1 above
  name_folder <- paste0("Files_to_Jupyterhub_", sampling_year)
  fn_rds <- dir(name_folder, pattern = paste0("01_df_", sampling_year, "_notstandard.+.rds$"))
  # file name
  fn <- tail(fn_rds, 1)   # picks the last file  
  df_2021 <- readRDS(paste0(name_folder, "/", fn))    
  
}

```


## APPENDIX: Test data 2020-2021   

```{r}

if (FALSE){
  
  
  df_2020 <- readRDS("Files_from_Jupyterhub_2020/Raw_data/109_adjusted_data_2021-09-15.rds")
  
  names(df_2021)
  names(df_2020)
  
  df_2021_test <- bind_rows(
    df_2020,
    df_2021 %>%
      mutate(MYEAR = lubridate::year(SAMPLE_DATE),
             VALUE_WW = VALUE)
  )
  
  saveRDS(df_2021_test, "Files_from_Jupyterhub_2020/Raw_data/802_testdata_2022-05-23.rds")
  
  
}

```

