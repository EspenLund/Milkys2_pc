---
title: "802 Get chemical data from NIVAbasen"
output: html_document
---

## Libraries
```{r setup, include=FALSE}
# install.packages("niRvana")

library(dplyr)
library(ggplot2)
library(lubridate)

# And then the niRvana package. If you need to install it, then run thee next line also:
# devtools::install_github("NIVANorge/niRvana")
library(niRvana)

source("802_Get_NIVAbasen_data_functions.R")

```

### Settings  
```{r}

sampling_year <- 2021

```


## Get new(er) data

### Give your username and password to R (only once per R session):
```{r}
# set_credentials()
```

### Get the list of projects

```{r}

df_projects <- get_projects()   # we call it 'df_projects' (the default name used by 'get_stations_from_project')

```

### Get a list of the stations in the CEMP_Biota project

```{r}

df_stations <- get_stations_from_project("CEMP_Biota", ignore.case = FALSE)

```

### Get all specimens collected at these stations (20 seconds or so)
- Includes LATIN_NAME  
```{r}

df_specimens <- get_specimens_from_stationdata(df_stations, years = sampling_year)
cat("df_specimens:", nrow(df_specimens), "rows\n")

# Checking wrong year
df_specimens_nextyear <- get_specimens_from_stationdata(df_stations, years = sampling_year + 1)

cat("df_specimens_nextyear:", nrow(df_specimens_nextyear), "rows\n")

```

### Plot sample dates in 2021 (or later)

```{r, fig.height=6, fig.width=7}

df_specimens %>%
  filter(year(DATE_CAUGHT) >= sampling_year) %>%
  ggplot(aes(DATE_CAUGHT)) +
  geom_histogram(binwidth = 3600*24*10) +   # 10 days
  scale_x_datetime(date_breaks = "1 month", date_labels = "%m %Y") +
  facet_wrap(vars(LATIN_NAME), ncol = 1, scales = "free_y")

```



## Get the data itself  
Get data frame of chemical data for all samples for the measurement year   
- LATIN_NAME is included  
```{r, results = FALSE}

# debugonce(get_biota_chemistry)
# debugonce(get_samples_from_sampleid)

df_data <- get_biota_chemistry(
  years = sampling_year,
  specimendata = df_specimens, 
  stationdata = df_stations,
  report_samples = TRUE)

```





### Save 
```{r}
#
# Latest data data
#

# Folder name
name_folder <- paste0("Files_to_Jupyterhub_", sampling_year)

# Make folder, if it doesn't already exist:
if (!dir.exists(name_folder)){
  dir.create(name_folder)
}

# File name
name_file <- paste0("01_df_", sampling_year, "_notstandard_", timestamp, ".rds")

# Make timestamp (date stamp actually)
t <- Sys.time()
timestamp <- substr(t, 1, 10)

name_fullpath <- paste0(name_folder, "/", name_file)

# Set to TRUE/FALSE depending on whether file should be saved or not  
if (FALSE){

  saveRDS(df_2021, file = name_fullpath)
  cat("2021 data saved as rds,", sQuote(name_fullpath), "\n")
  name_fullpath_txt <- sub("rds", "csv", name_fullpath)
  write.csv(df_2021, file = name_fullpath_txt, fileEncoding = "UTF-8")
  cat("2021 data saved as csv,", sQuote(name_fullpath_txt), "\n")

}

# Set to TRUE/FALSE depending on whether file should be read or not  
if (FALSE){
  
  name_folder <- paste0("Files_to_Jupyterhub_", sampling_year)
  fn_rds <- dir(name_folder, pattern = paste0("01_df_", sampling_year, "_notstandard.+.rds$"))
  df_2021 <- readRDS(paste0(name_folder, "/", tail(fn_rds, 1)))
  
}

```

```{r}

if (FALSE){
  
  
  df_2020 <- readRDS("Files_from_Jupyterhub_2020/Raw_data/109_adjusted_data_2021-09-15.rds")
  
  names(df_2021)
  names(df_2020)
  
  df_2021_test <- bind_rows(
    df_2020,
    df_2021 %>%
      mutate(MYEAR = lubridate::year(SAMPLE_DATE),
             VALUE_WW = VALUE)
  )
  
  saveRDS(df_2021_test, "Files_from_Jupyterhub_2020/Raw_data/802_testdata_2022-05-23.rds")
  
  
}

```


## Add data from Labware  

### Get data  
```{r}

# From QC_Chemistry app. Failed with "table or view does not exist"
# df_labware <- get_nivabase_data("select * from labware.v_app_chemistry_qc_project where PROSJEKT = 'O 210200.ANAIN'")  

df_labware <- get_nivabase_data("select * from NIVADATABASE.LABWARE_IMPORT where PROSJEKT = 'O 210200.ANAIN'")
nrow(df_labware) # 20153

```
### Sample dates  
```{r}
df_labware %>%
  count(AQUAMONITOR_CODE, SAMPLED_DATE) %>%
  ggplot() +
  geom_text(aes(x = SAMPLED_DATE, y = 1, label = AQUAMONITOR_CODE), position = "jitter")

```


### Parameter names  
```{r}

n1 <- unique(df_2021$NAME) %>% sort()
n2 <- unique(df_labware$REPORTED_NAME) %>% sort()

cat("Only in Nivabase: \n")
setdiff(n1, n2)
cat("\nOnly in Labware: \n")
setdiff(n2, n1)

```

### Check Nivabasen data for same  
```{r}

if (FALSE){
  df_2021 %>%
    distinct(STATION_CODE, NAME) %>%
    count(STATION_CODE) %>%
    arrange(desc(n))
}



```
