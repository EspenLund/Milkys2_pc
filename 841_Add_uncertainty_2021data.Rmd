---
title: "34_Add_uncertainty"
author: "DHJ"
date: "29 8 2019"
output: 
  html_document:
    keep_md: true
---

**NOTE: NOT USED IN 2021! Jupyterhub (DHJ/Milkys2) script 105 used instead.**  

**UNCRT can be given in three ways:**
- as standard deviation `u` (set METCU = SD)   
- as "expanded uncertainty" = 2 x standard deviation = 2u (set METCU = U2)   
- as percentage = 100u/VALUE (set METCU = %)   
NOTE: The formula used in part 6 and 7, sqrt(s^2 + (Value^2)*(v^2)), is taken from Rob Fryer and is given both in Annex 5 of the 2018/19 MIME report as well as in ICES DOME 'Frequently Asked Questions'    

- This year (part 8), we use percentage (and METCU = %) as given by the labs.   




## 1. Libraries
```{r, results=}

library(dplyr)
library(purrr)
library(readxl)
library(safejoin)  # for safe_left_join() with check = "V" 
                   # (check if no set of values of join columns is duplicated in y)
library(ggplot2)

library(here)
# setwd("C:/Data/seksjon 212")
# set_here("C:/Data/seksjon 212")

# here()
# ?set_here
# set_here("C:/Data/seksjon 212/Milkys")

```


### Selected year  
```{r}

selected_year <- 2021

```


## 2. Chemical data    
We only keep data from the last year   

```{r}

# dir("Data")
# Data at sample level (chemical data, biological efect parameters and VDSI)
# Also in "../Milkys2/Data/101_data_updated_2020-08-05.rds"
 
fn <- "Files_from_Jupyterhub_2021/Raw_data/101_dat_new_2022-09-01.rds"          # data FROM Milkys2 on Jupyterhub
dat_all <- readRDS(fn)

fn <- "Files_from_Jupyterhub_2021/Raw_data/101_data_updated_2022-09-01.rds"     # data FROM Milkys2 on Jupyterhub - all years
dat_allyears <- readRDS(fn)

# Remember: for sum variables, only SAMPLE_NO2 has been set (SAMPLE_NO is NA)
check <- dat_all %>%
  filter(SAMPLE_NO != SAMPLE_NO2)

if (nrow(check) > 0)
  stop("Check cases where SAMPLE_NO != SAMPLE_NO2")

dat_all <- dat_all %>%
  mutate(
    TISSUE_NAME = case_when(
      TISSUE_NAME %in% "Egg homogenate of yolk and albumin" ~ "Egg",
      TRUE ~ TISSUE_NAME)
  )


```


### Check if there are unique values 
```{r}

check <- dat_all %>%
  ungroup() %>%
  group_by(STATION_CODE, LATIN_NAME, TISSUE_NAME, MYEAR, SAMPLE_NO2, 
           UNIT, PARAM) %>%
  mutate(n = n()) %>%
  filter(n > 1)

cat("The number of duplicate values in 'dat_all' is: ", nrow(check))  # 0


if (FALSE){
  check %>%
    filter(TISSUE_NAME == "Egg" & SAMPLE_NO == 1)
    
}

```

### Get parameter (substance) groups  
```{r}

df_paramgroups <- readxl::read_excel("Input_files_2021/Lookup table - substance groups - 2021.xlsx")  
sel <- !dat_all$PARAM %in% df_paramgroups$PARAM

if (sum(sel) > 0){ 
  stop("Not found:", 
      unique(dat_all$PARAM[sel]) %>% paste(collapse = "; "), "\n")
} else {
  cat("All parameters (PARAM) found in file for parameter (substance) groups")
}

n1 <- nrow(dat_all)
dat_all <- dat_all %>%
  left_join(df_paramgroups %>% select(PARAM, Substance.Group))
n2 <- nrow(dat_all)

if (n2 > n1){
  stop("PARAM in 'df_paramgroups' not unique! Fix, and recreate dat_all.")
}

if (sum(is.na(dat_all$Substance.Group)) > 0){
  stop("Some values of 'Substance.Group' in 'df_paramgroups' lacks data! Fix, and recreate dat_all.")
}

cat("'Substance.Group' added to data")

# For copying to clipboard -> paste to excel
# dat_all[!sel,] %>% count(PARAM) %>% write.table("clipboard", sep= "\t")

# Table example
# dat_allyears %>% filter(grepl("OP", PARAM)) %>% xtabs(~MYEAR + PARAM, .)

```
### Plot raw data   
- In earlier veriosn of the data, some PFDcA values from Sørfjorden are very low  
- the same for some PFUdA data 
- PCBs are also very low for 19B, but this is correct (methods are adjusted for this station)   

```{r}

plot_raw_data_liver_highlight <- function(param, 
                                          highlight = "53B", 
                                          highlight_text = "Inner Sørfjord", 
                                          log = FALSE){
  df <- dat_all %>% 
    filter(LATIN_NAME == "Gadus morhua" & MYEAR == sampling_year & PARAM == param) %>% 
    arrange(VALUE_WW) %>%
    mutate(
      Flag1 = ifelse(is.na(FLAG1), "Over LOQ", "Under LOQ"),
      `Station color` = ifelse(STATION_CODE == highlight, highlight_text, "Other stations")
      )
  gg <- ggplot(df, aes(STATION_CODE, VALUE_WW, color = `Station color`, shape = Flag1)) +
    geom_jitter(width = 0.25, height = 0) +
    labs(title = paste(param, "in cod liver"),
         subtitle = "Dashed line = Lowest 'under LOQ-value'")
  if (sum(df$Flag1 == "Under LOQ") > 0)
    gg <- gg + geom_hline(yintercept = min(df$VALUE_WW[df$Flag1 == "Under LOQ"]), 
                          linetype = "dashed")
  if (log)
    gg <- gg + scale_y_log10()
  print(gg)
}

dat_all %>% 
    filter(LATIN_NAME == "Gadus morhua" & MYEAR == 2020 & substr(PARAM, 1, 2) == "PF") %>%
  group_by(PARAM) %>%
  summarise(median(VALUE_WW), mean(is.na(FLAG1)))

plot_raw_data_liver_highlight("PFDcA") # strange values  
plot_raw_data_liver_highlight("PFOS")
plot_raw_data_liver_highlight("PFOSA")
plot_raw_data_liver_highlight("PFUdA")
plot_raw_data_liver_highlight("PFNA")

plot_raw_data_liver_highlight("CB180", highlight = "19B", highlight_text = "Svalbard", log = TRUE)
plot_raw_data_liver_highlight("CB101", highlight = "19B", highlight_text = "Svalbard", log = TRUE)

```
### Fix PFDcA and PFUdA in cod liver    
- Set values under 0.5 to "< 0.5"
```{r}

sel <- with(dat_all, 
            LATIN_NAME == "Gadus morhua" & PARAM == "PFDcA" & MYEAR == sampling_year & VALUE_WW < 0.5)
sum(sel)
table(addNA(dat_all$FLAG1[sel]))  

sel2 <- with(dat_all, is.na(FLAG1))
sum(sel & sel2)

sel3 <- sel & sel2
dat_all[sel3,]

# We let this one be
# message("Change ", sum(sel), " PFDcA records")
# dat_all$VALUE_WW[sel] <- 0.5 
# dat_all$FLAG1[sel] <- "<" 
# dat_all$VALUE_DW[sel] <- NA 
# dat_all$VALUE_FB[sel] <- NA 

# PLot again
# plot_raw_data_liver_highlight("PFDcA") # strange values  

```
### Fix concentrations below zero  
```{r}

if (FALSE){
  
  dat_all %>%
    filter() %>%
    xtabs(~LATIN_NAME + PARAM + MYEAR, .)
  
}

sel <- with(
  dat_all, 
  VALUE_WW < 0 & !PARAM %in% c("Delta13C") & LATIN_NAME == "Somateria mollissima")
message("Fix ", sum(sel), " eider duck PCBs with conc. < 0, these are below LOQ")

dat_all$VALUE_WW[sel] <- -dat_all$VALUE_WW[sel]
dat_all$VALUE_DW[sel] <- -dat_all$VALUE_DW[sel]
dat_all$VALUE_FB[sel] <- -dat_all$VALUE_WW[sel]
dat_all$FLAG1[sel] <- "<"

```


### Create `dat_all`  
- Data for the selected year   

```{r}

dat_all <- dat_all %>%
  filter(MYEAR %in% selected_year)

xtabs(~ addNA(LATIN_NAME), dat_all)

```


### Fix QUANTIFICATION_LIMIT   
- Given for metals    

```{r}

sel <- !is.na(dat_all$QUANTIFICATION_LIMIT)
cat("Has QUANTIFICATION_LIMIT: \n")
table(sel)

cat("\nHas VALUE_WW > QUANTIFICATION_LIMIT: \n")
xtabs(~(VALUE_WW > QUANTIFICATION_LIMIT), dat_all[sel,])

sel2 <- 
  !is.na(dat_all$QUANTIFICATION_LIMIT) & 
  !is.na(dat_all$VALUE_WW) & 
  with(dat_all, VALUE_WW < QUANTIFICATION_LIMIT)
cat("\nHas VALUE_WW < QUANTIFICATION_LIMIT: \n")
sum(sel2)

# Check these data
# dat_all[sel2,]

# Quantification limits of metals is 1-20; this must be ug/kg, not mg/kg
dat_all[sel2,] %>%
  select(PARAM, VALUE_WW, QUANTIFICATION_LIMIT) %>%
  group_by(PARAM) %>%
  summarise(across(.fns = list(mean=mean, min=min, sd=sd)))

# If not yet fixed (all QUANTIFICATION_LIMIT are above 0.5)
if (min(dat_all$QUANTIFICATION_LIMIT[sel2]) >= 0.5){   
  # fix by dividing values by 1000
  dat_all$QUANTIFICATION_LIMIT[sel2] <- dat_all$QUANTIFICATION_LIMIT[sel2]/1000
}
# after fixing, the lowest QUANTIFICATION_LIMIT is 0.001 (so this fixing can only be done once)

```

### Extra: View the most important data columns     
- For interactive use  
```{r, echo=FALSE}
#
# SHOW RAW DATA
# data set with selected columns, just for View
#
dat_all_view <- dat_all %>% 
  select(
    STATION_CODE, STATION_NAME, SAMPLE_DATE, LATIN_NAME, TISSUE_NAME, PARAM, MYEAR, 
    SAMPLE_NO2, VALUE_WW, FLAG1, QUANTIFICATION_LIMIT, UNCERTAINTY
  )

if (FALSE){
  View(dat_all_view %>% 
         filter(LATIN_NAME == "Gadus morhua" & PARAM == "CB180" & MYEAR == sampling_year) %>% 
         arrange(VALUE_WW), title = "CB180")
  View(dat_all_view %>% 
         filter(LATIN_NAME == "Gadus morhua" & PARAM == "PFUdA" & MYEAR == sampling_year) %>% 
         arrange(VALUE_WW), title = "PFUdA")
  View(dat_all_view %>% 
         filter(LATIN_NAME == "Gadus morhua" & PARAM == "PFDcA" & MYEAR == sampling_year) %>% 
         arrange(VALUE_WW), title = "PFDcA")
  View(dat_all_view %>% 
         filter(LATIN_NAME == "Gadus morhua" & PARAM == "PFOS" & MYEAR == sampling_year) %>% 
         arrange(VALUE_WW), title = "PFOS")
}

```

## 3a. Uncertainty data   

### Check labs  
- Tried to use the LABORATORY field, but that wasn't useful - it says 'NIVA_LABWARE' for almost everything  
```{r}

if (FALSE){
  
  # Get full 2021 data  
  name_folder <- paste0("Files_to_Jupyterhub_", selected_year)
  fn_rds <- dir(name_folder, pattern = paste0("01_df_", sampling_year, "_notstandard.+.rds$"))
  dat_full <- readRDS(paste0(name_folder, "/", tail(fn_rds, 1)))
  
  
  # Get LABORATORY
  method_id <- unique(dat_full$METHOD_ID)
  df_lab <- get_nivabase_selection(
    "METHOD_ID, LABORATORY",
    "METHOD_DEFINITIONS",
    "METHOD_ID",
    method_id
  )
  
  # Add to data  
  dat_full <- dat_full %>%
    left_join(df_lab, by = "METHOD_ID")
  
  dat_full %>%
    count(NAME, LATIN_NAME, LABORATORY)

}


```


### Add lab 

* Source: Tender. Table 7 in '3-3. Dokumentasjon for Løsningsforslag (MILKYS 2021-2025).docx', see folder 'Input_files_2021\Uncertainty'

* Blåskjell; blandprøver av bløtdelene	
    - NIVA:	PFAS, fettprosent
    - Eurofins:	Metaller, Hg, PAH, PCB7, DDT, klororganiske forbindelser, PBDE, HBCDD, klorerte parafiner (SCCP/MCCP), Organotinn, tørrvekt
    - IFE:	SIA  
* Fisk; Lever, muskel, blod, galle 	
    - NIVA:	PFAS, EROD/CYP1A (lever); ALA-D (blod); OH-pyren (galle)   
    - Eurofins	Hg (muskel); Metaller, PCB7, DDT, klororganiske forbindelser, PBDE, HBCDD, klorerte parafiner (SCCP/MCCP), fettprosent (lever)
    - NILU:	Siloksaner (lever)  
    - IFE:	SIA (muskel)  
* Purpursnegl (strandsnegl); bløtdel	 
    - NIVA:	VDSI (utregnes fra enkeltindivider) (ISI utregnes fra enkeltindivider for strandsnegl)   
    - Eurofins:	Organotinn forbindelser (blandprøver)
* Ærfugl; egg og blod	  
    - NIVA:	PFAS   
    - NILU:	Metaller, Hg, PCB7, PBDE, HBCDD, klorerte parafiner (SCCP/MCCP), siloksaner, fettprosent   
    - IFE:	SIA

```{r}

dat_all %>%
  count(Substance.Group, PARAM)  
dat_all %>%
  count(LATIN_NAME)  

dat_all <- dat_all %>%
  mutate(Lab = case_when(
    Substance.Group %in% "Organofluorines" ~ "NIVA",
    PARAM %in% "Fett" & LATIN_NAME %in% "Mytilus edulis" ~ "NIVA",
    Substance.Group %in% c("Biological effects: molecular/biochemical/cellular/assays", "Biomarkers") ~ "NIVA",
    Substance.Group %in% "Siloxans" ~ "NILU",
    Substance.Group %in% "Isotopes" ~ "IFE",  
    LATIN_NAME %in% "Somateria mollissima" ~ "NILU",  
    TRUE ~ "Eurofins")
  )


```

### Uncertainty, Eurofins   
- NOTE: Uncertainty given in data sheet is 2*SE ("expanded uncertainty")   
- Use uncertainty by substance group  
```{r}

# Uncertainty data  
fn <- "Input_files_2021/Uncertainty/2021-2022_MILKYS_QAdata_Eurofins.xlsx"
# excel_sheets(fn)
df_uncert_eurofins1 <- read_excel(fn, sheet = "Uncertainty by group")

table(df_uncert1$Uncertainty)

xtabs(~Substance.Group + addNA(Uncertainty), df_uncert1)

df_uncert_eurofins2 <- df_uncert_eurofins1 %>%
  filter(!is.na(Uncertainty)) %>%
  filter(!Uncertainty %in% "-")

xtabs(~Substance.Group + addNA(Uncertainty), df_uncert2)

df_uncert_eurofins <- df_uncert_eurofins2 %>%
  distinct(Substance.Group, Uncertainty) %>%
  mutate(Uncertainty = as.numeric(Uncertainty))

```
### Uncertainty, NILU     
- NOTE: Uncertainty given in data sheet is 2*SE ("expanded uncertainty")   
- Use uncertainty by substance group  
```{r}

# Uncertainty data  
fn <- "Input_files_2021/Uncertainty/NILU.xlsx"
# excel_sheets(fn)
df_uncert_nilu <- read_excel(fn, sheet = "Uncertainty by group") %>%
  select(Substance.Group, Uncertainty)

```
### Uncertainty, NIVA       
- See table 18 in the tender  
    - '3-3. Dokumentasjon for Løsningsforslag (MILKYS 2021-2025).docx', in folder 'Input_files_2021\Uncertainty'
```{r}

df_uncert_niva <- tibble::tribble(
  ~Substance.Group, ~Uncertainty,
  "Organofluorines", 0.25,
  "Fett", 0.15)

```

### Uncertainty, add to data    
- Metals at NILU - assumed the same as Eurofins  
- 'Organo-metallic compounds' + Pesticides at Eurofins - from tender  
- The rest - guessed  
```{r}

df_uncert <- bind_rows(
  df_uncert_eurofins %>% mutate(Lab = "Eurofins"),
  df_uncert_nilu %>% mutate(Lab = "NILU"),
  df_uncert_niva %>% mutate(Lab = "NIVA"),
  tibble::tribble(
    ~Substance.Group, ~Uncertainty, ~Lab,
    "Metals and metalloids", 0.20, "NILU",
    "Organo-metallic compounds", 0.30, "Eurofins",
    "Pesticides", 0.30, "Eurofins",
    "Others", 0.30, "Eurofins",    # also largely pesticides/herbicides
    "Biological effects: molecular/biochemical/cellular/assays", 0.40, "NIVA",
    "Biomarkers", 0.15, "NIVA",
    "Isotopes", 0.35, "IFE"
    )
)

dat_updated <- dat_all %>%
  left_join(df_uncert, by = c("Substance.Group", "Lab")) %>%
  mutate(
    Uncertainty = case_when(
      Substance.Group %in% "Fat and dry weight" ~ 0.15,
      Substance.Group %in% "Percentage C and N" ~ 0.20,
      TRUE ~ Uncertainty)
  ) %>%
  mutate(UNCRT = 100*Uncertainty) %>%
  mutate(METCU = "%")

if (nrow(dat_updated) > nrow(dat_all)){
  stop("Number of rows increased - make sure Substance.Group and Lab are unique")
} else {
  cat("Uncertainty added to data")
}

```
### Check  
```{r}

check <- dat_updated %>%
  filter(is.na(UNCRT))

if (nrow(check) == 0){
  cat("Uncertainty added to all data")
} else {
  stop("Still some substances / labs lacking uncertainty - check tables below")
}

if (FALSE){
  
  check %>% count(Substance.Group, Lab)
  check %>% count(Substance.Group, PARAM, Lab)
  
}

```



### Show raw data  
- selected columns 
```{r}
#
# data set with selected columns, just for View
#
dat_updated_view <- dat_updated %>% 
  select(
    STATION_CODE, STATION_NAME, SAMPLE_DATE, LATIN_NAME, TISSUE_NAME, PARAM, MYEAR, 
    SAMPLE_NO2, VALUE_WW, FLAG1, Lab,   
    UNCRT, METCU
  )

if (FALSE){
  
  View(dat_all_updated_view %>% 
         filter(LATIN_NAME == "Gadus morhua" & PARAM == "CB180") %>% 
         arrange(VALUE_WW), title = "CB180")
  View(dat_all_updated_view %>% 
         filter(LATIN_NAME == "Gadus morhua" & PARAM == "PFUdA") %>% 
         arrange(VALUE_WW), title = "PFUdA")
  View(dat_all_updated_view %>% 
         filter(LATIN_NAME == "Gadus morhua" & PARAM == "PFDcA") %>% 
         arrange(VALUE_WW), title = "PFDcA")
  View(dat_all_updated_view %>% 
         filter(LATIN_NAME == "Gadus morhua" & PARAM == "PFOS") %>% 
         arrange(VALUE_WW), title = "PFOS")
}

```




### Check if there are unique values 
```{r}

check <- dat_updated %>%
  ungroup() %>%
  group_by(STATION_CODE, LATIN_NAME, TISSUE_NAME, MYEAR, 
           SAMPLE_NO2, UNIT, PARAM) %>%
  mutate(n = n()) %>%
  filter(n > 1)

if (nrow(check) > 0){
  warning("There are ", nrow(check), " duplicates in the data!")
  # xtabs(~STATION_CODE + MYEAR, check)
  xtabs(~PARAM + MYEAR, check)
} else {
  message("There are no duplicates in the data.")
}


```

## 9. Save  
**This is input for 842_ICES_submission_xxxxdata.Rmd**
```{r}

fn <- paste0("Data/841_dat_all_", selected_year) 
saveRDS(dat_updated, fn)

message("Data written to ", fn)

#
# This is input for script 842 ICES submission
#

#
# Read back, if needed:
# 2019 data
# dat_updated <- readRDS("../Milkys/Data/34_dat_all.rds")
# 2020 data
# dat_updated <- readRDS(fn)

```



#### Final check
```{r}

# xxx
dat_updated %>% 
  filter(MYEAR == selected_year & is.na(FLAG1)) %>%
  xtabs(~PARAM + is.na(UNCRT), .)

dat_updated %>% 
  filter(MYEAR == selected_year & is.na(FLAG1) & PARAM == "BDE47") %>%
  xtabs(~Lab + is.na(UNCRT), .)

dat_updated %>% 
  filter(MYEAR == selected_year & is.na(FLAG1) & PARAM == "BDE47" & Lab %in% "NILU")

dat_updated %>% 
  filter(MYEAR == selected_year & is.na(FLAG1) & PARAM == "BDE126" & Lab %in% "NILU")

```

#### Check in MIME   
```{r}

df <- dat_updated %>% 
  filter(MYEAR == selected_year & is.na(FLAG1) & 
           PARAM == "HG" & STATION_CODE == "30B" &
           TISSUE_NAME == "Muskel")
df %>%
  select(VALUE_WW, Uncertainty_expand, LOQ_lt_min, Min_value, UNCRT, METCU)

```






### Comparison   
- with stuff in 7, but now commented out  
```{r}


# mean_uncrt_compare <- function(lab, param, species, tissue){
#   bind_rows(
#     mean_uncrt_1 %>%
#       filter(Lab == lab & PARAM == param & LATIN_NAME == species, TISSUE_NAME == tissue),
#     mean_uncrt_2 %>%
#       filter(Lab == lab & PARAM == param & LATIN_NAME == species, TISSUE_NAME == tissue)
#   )
# }
# 
# mean_uncrt_compare("Eurofins", "CB180", "Gadus morhua", "Lever")



```

### Check 3   
- Kind of table/plot  
```{r}

param <- "CB118"

df1 <- dat_updated %>% 
  filter(MYEAR == selected_year & is.na(FLAG1))

df2 <- dat_updated %>% 
  filter(MYEAR == selected_year & is.na(FLAG1) & PARAM == param)

cat("\n************************************************************\n")
cat("Check error/value ratio for 1) all data and 2) CB118\n\n")

df_list = list(df1,df2)
names(df_list) <- c("All data", param)

for (i in 1:2){
  
  df <- df_list[[i]]
  
  with(df, print(quantile(UNCRT/VALUE_WW, na.rm = TRUE)))

  gg <- ggplot(df, aes(y = UNCRT/VALUE_WW)) + 
    geom_boxplot() +
    scale_y_log10() +
    labs(title = names(df_list)[i])
  print(gg)
  
  }

  

# xtabs(~PARAM + Lab, dat_updated %>% filter(MYEAR == selected_year & is.na(UNCRT)))
# dat_updated %>% filter(PARAM %in% "BDE47" & STATION_CODE == "19N") %>% View()

```




